<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA 기능 테스트 - doha.kr</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .test-item:last-child {
            border-bottom: none;
        }
        .status {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #5856eb; }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .mobile-menu-test {
            background: white;
            border: 2px dashed #6366f1;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>🚀 PWA 기능 테스트 페이지</h1>
    <p>doha.kr의 PWA 기능과 모바일 메뉴가 제대로 작동하는지 테스트합니다.</p>

    <!-- Service Worker 테스트 -->
    <div class="test-section">
        <h2>🔧 Service Worker 상태</h2>
        <div class="test-item">
            <span>Service Worker 지원</span>
            <span id="sw-support" class="status">확인 중...</span>
        </div>
        <div class="test-item">
            <span>Service Worker 등록</span>
            <span id="sw-registered" class="status">확인 중...</span>
        </div>
        <div class="test-item">
            <span>Service Worker 활성화</span>
            <span id="sw-active" class="status">확인 중...</span>
        </div>
        <div class="test-item">
            <span>Service Worker 버전</span>
            <span id="sw-version" class="status">확인 중...</span>
        </div>
        <button onclick="checkServiceWorkerStatus()">상태 새로고침</button>
        <button onclick="updateServiceWorker()">업데이트 확인</button>
    </div>

    <!-- PWA 설치 테스트 -->
    <div class="test-section">
        <h2>📱 PWA 설치 상태</h2>
        <div class="test-item">
            <span>PWA 설치 가능</span>
            <span id="pwa-installable" class="status">확인 중...</span>
        </div>
        <div class="test-item">
            <span>현재 PWA 모드</span>
            <span id="pwa-mode" class="status">확인 중...</span>
        </div>
        <div class="test-item">
            <span>매니페스트 로드</span>
            <span id="manifest-loaded" class="status">확인 중...</span>
        </div>
        <button onclick="showInstallPrompt()">설치 프롬프트 표시</button>
        <button onclick="checkPWAStatus()">PWA 상태 새로고침</button>
    </div>

    <!-- 모바일 메뉴 테스트 -->
    <div class="test-section">
        <h2>📱 모바일 메뉴 테스트</h2>
        <div class="mobile-menu-test">
            <div style="display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <span><strong>doha.kr</strong></span>
                <button class="mobile-menu-toggle" style="display: flex; flex-direction: column; justify-content: center; align-items: center; width: 30px; height: 30px; background: transparent; border: 1px solid #ddd; border-radius: 4px;">
                    <span style="width: 18px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s;"></span>
                    <span style="width: 18px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s;"></span>
                    <span style="width: 18px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s;"></span>
                </button>
            </div>
            <p>위의 햄버거 메뉴 버튼을 클릭해보세요:</p>
            <div class="test-item">
                <span>모바일 메뉴 초기화</span>
                <span id="mobile-menu-init" class="status">확인 중...</span>
            </div>
            <div class="test-item">
                <span>메뉴 토글 기능</span>
                <span id="mobile-menu-toggle" class="status">확인 중...</span>
            </div>
            <button onclick="initTestMobileMenu()">테스트 메뉴 초기화</button>
        </div>
    </div>

    <!-- 캐시 테스트 -->
    <div class="test-section">
        <h2>💾 캐시 상태</h2>
        <div class="test-item">
            <span>캐시 API 지원</span>
            <span id="cache-support" class="status">확인 중...</span>
        </div>
        <div class="test-item">
            <span>정적 캐시</span>
            <span id="static-cache" class="status">확인 중...</span>
        </div>
        <div class="test-item">
            <span>동적 캐시</span>
            <span id="dynamic-cache" class="status">확인 중...</span>
        </div>
        <button onclick="checkCacheStatus()">캐시 상태 확인</button>
        <button onclick="clearAllCaches()">모든 캐시 삭제</button>
    </div>

    <!-- 로그 출력 -->
    <div class="test-section">
        <h2>📊 실시간 로그</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">로그 지우기</button>
        <button onclick="downloadLog()">로그 다운로드</button>
    </div>

    <script type="module">
        // 로그 함수
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const logDiv = document.getElementById('log');
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#6b7280';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[PWA Test] ${message}`);
        }

        // 상태 업데이트 함수
        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message || (status === 'pass' ? '✅ 정상' : status === 'fail' ? '❌ 실패' : '⚠️ 경고');
        }

        // Service Worker 상태 확인
        window.checkServiceWorkerStatus = async function() {
            log('Service Worker 상태 확인 시작');
            
            if ('serviceWorker' in navigator) {
                updateStatus('sw-support', 'pass');
                log('Service Worker API 지원됨', 'success');
                
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        updateStatus('sw-registered', 'pass');
                        log('Service Worker 등록됨', 'success');
                        
                        if (registration.active) {
                            updateStatus('sw-active', 'pass');
                            log('Service Worker 활성화됨', 'success');
                            
                            // 버전 확인
                            const channel = new MessageChannel();
                            channel.port1.onmessage = function(event) {
                                const version = event.data?.version || '알 수 없음';
                                updateStatus('sw-version', 'pass', `v${version}`);
                                log(`Service Worker 버전: ${version}`, 'success');
                            };
                            
                            registration.active.postMessage({type: 'GET_VERSION'}, [channel.port2]);
                        } else {
                            updateStatus('sw-active', 'warning', '비활성');
                            log('Service Worker가 활성화되지 않음', 'error');
                        }
                    } else {
                        updateStatus('sw-registered', 'fail');
                        log('Service Worker가 등록되지 않음', 'error');
                    }
                } catch (error) {
                    log(`Service Worker 확인 중 오류: ${error.message}`, 'error');
                }
            } else {
                updateStatus('sw-support', 'fail');
                log('Service Worker가 지원되지 않음', 'error');
            }
        };

        // Service Worker 업데이트
        window.updateServiceWorker = async function() {
            log('Service Worker 업데이트 확인');
            
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.update();
                    log('Service Worker 업데이트 확인 완료', 'success');
                } else {
                    log('등록된 Service Worker가 없음', 'error');
                }
            } catch (error) {
                log(`Service Worker 업데이트 실패: ${error.message}`, 'error');
            }
        };

        // PWA 상태 확인
        window.checkPWAStatus = function() {
            log('PWA 상태 확인 시작');
            
            // 설치 가능 여부
            if (window.deferredPrompt) {
                updateStatus('pwa-installable', 'pass', '설치 가능');
                log('PWA 설치 프롬프트 사용 가능', 'success');
            } else {
                updateStatus('pwa-installable', 'warning', '프롬프트 없음');
                log('PWA 설치 프롬프트 없음 (이미 설치되었거나 기준 미충족)', 'info');
            }
            
            // PWA 모드 확인
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true;
            
            if (isPWA) {
                updateStatus('pwa-mode', 'pass', 'PWA 모드');
                log('PWA 모드에서 실행 중', 'success');
            } else {
                updateStatus('pwa-mode', 'warning', '브라우저 모드');
                log('브라우저 모드에서 실행 중', 'info');
            }
            
            // 매니페스트 확인
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                updateStatus('manifest-loaded', 'pass');
                log('매니페스트 링크 발견', 'success');
            } else {
                updateStatus('manifest-loaded', 'fail');
                log('매니페스트 링크 없음', 'error');
            }
        };

        // 설치 프롬프트 표시
        window.showInstallPrompt = function() {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                log('PWA 설치 프롬프트 표시됨', 'success');
            } else {
                log('설치 프롬프트를 사용할 수 없음', 'error');
            }
        };

        // 캐시 상태 확인
        window.checkCacheStatus = async function() {
            log('캐시 상태 확인 시작');
            
            if ('caches' in window) {
                updateStatus('cache-support', 'pass');
                log('Cache API 지원됨', 'success');
                
                try {
                    const cacheNames = await caches.keys();
                    log(`총 ${cacheNames.length}개의 캐시 발견: ${cacheNames.join(', ')}`, 'success');
                    
                    const staticCache = cacheNames.find(name => name.includes('static'));
                    const dynamicCache = cacheNames.find(name => name.includes('dynamic'));
                    
                    updateStatus('static-cache', staticCache ? 'pass' : 'fail', 
                                staticCache || '없음');
                    updateStatus('dynamic-cache', dynamicCache ? 'pass' : 'fail', 
                                dynamicCache || '없음');
                    
                    if (staticCache) {
                        const cache = await caches.open(staticCache);
                        const keys = await cache.keys();
                        log(`정적 캐시에 ${keys.length}개 항목 저장됨`, 'success');
                    }
                } catch (error) {
                    log(`캐시 확인 중 오류: ${error.message}`, 'error');
                }
            } else {
                updateStatus('cache-support', 'fail');
                log('Cache API가 지원되지 않음', 'error');
            }
        };

        // 모든 캐시 삭제
        window.clearAllCaches = async function() {
            log('모든 캐시 삭제 시작');
            
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                log(`${cacheNames.length}개 캐시 삭제 완료`, 'success');
                checkCacheStatus();
            } catch (error) {
                log(`캐시 삭제 실패: ${error.message}`, 'error');
            }
        };

        // 테스트 모바일 메뉴 초기화
        window.initTestMobileMenu = function() {
            log('테스트 모바일 메뉴 초기화');
            
            const toggle = document.querySelector('.mobile-menu-toggle');
            if (toggle) {
                updateStatus('mobile-menu-init', 'pass');
                log('모바일 메뉴 버튼 발견', 'success');
                
                // 클릭 이벤트 추가
                toggle.onclick = function() {
                    const spans = this.querySelectorAll('span');
                    const isActive = this.classList.contains('active');
                    
                    if (isActive) {
                        this.classList.remove('active');
                        spans.forEach((span, index) => {
                            span.style.transform = '';
                            span.style.opacity = '';
                        });
                        updateStatus('mobile-menu-toggle', 'pass', '메뉴 닫힌');
                        log('테스트 메뉴 닫힘', 'success');
                    } else {
                        this.classList.add('active');
                        spans[0].style.transform = 'rotate(45deg) translate(5px, 5px)';
                        spans[1].style.opacity = '0';
                        spans[2].style.transform = 'rotate(-45deg) translate(7px, -6px)';
                        updateStatus('mobile-menu-toggle', 'pass', '메뉴 열림');
                        log('테스트 메뉴 열림', 'success');
                    }
                };
            } else {
                updateStatus('mobile-menu-init', 'fail');
                log('모바일 메뉴 버튼 없음', 'error');
            }
        };

        // 로그 지우기
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        // 로그 다운로드
        window.downloadLog = function() {
            const logContent = document.getElementById('log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pwa-test-log-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // PWA 설치 프롬프트 이벤트 리스너
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            window.deferredPrompt = e;
            log('PWA 설치 프롬프트 캐치됨', 'success');
        });

        window.addEventListener('appinstalled', () => {
            log('PWA 설치 완료!', 'success');
            checkPWAStatus();
        });

        // 페이지 로드 시 모든 테스트 실행
        window.addEventListener('load', () => {
            log('PWA 테스트 페이지 로드됨', 'success');
            
            setTimeout(() => {
                checkServiceWorkerStatus();
                checkPWAStatus();
                checkCacheStatus();
                initTestMobileMenu();
            }, 1000);
        });
    </script>
</body>
</html>