<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ - doha.kr</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .test-item:last-child {
            border-bottom: none;
        }
        .status {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #5856eb; }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .mobile-menu-test {
            background: white;
            border: 2px dashed #6366f1;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ PWA ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
    <p>doha.krì˜ PWA ê¸°ëŠ¥ê³¼ ëª¨ë°”ì¼ ë©”ë‰´ê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

    <!-- Service Worker í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>ğŸ”§ Service Worker ìƒíƒœ</h2>
        <div class="test-item">
            <span>Service Worker ì§€ì›</span>
            <span id="sw-support" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="test-item">
            <span>Service Worker ë“±ë¡</span>
            <span id="sw-registered" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="test-item">
            <span>Service Worker í™œì„±í™”</span>
            <span id="sw-active" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="test-item">
            <span>Service Worker ë²„ì „</span>
            <span id="sw-version" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <button onclick="checkServiceWorkerStatus()">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
        <button onclick="updateServiceWorker()">ì—…ë°ì´íŠ¸ í™•ì¸</button>
    </div>

    <!-- PWA ì„¤ì¹˜ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>ğŸ“± PWA ì„¤ì¹˜ ìƒíƒœ</h2>
        <div class="test-item">
            <span>PWA ì„¤ì¹˜ ê°€ëŠ¥</span>
            <span id="pwa-installable" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="test-item">
            <span>í˜„ì¬ PWA ëª¨ë“œ</span>
            <span id="pwa-mode" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="test-item">
            <span>ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¡œë“œ</span>
            <span id="manifest-loaded" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <button onclick="showInstallPrompt()">ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ</button>
        <button onclick="checkPWAStatus()">PWA ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <!-- ëª¨ë°”ì¼ ë©”ë‰´ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>ğŸ“± ëª¨ë°”ì¼ ë©”ë‰´ í…ŒìŠ¤íŠ¸</h2>
        <div class="mobile-menu-test">
            <div style="display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <span><strong>doha.kr</strong></span>
                <button class="mobile-menu-toggle" style="display: flex; flex-direction: column; justify-content: center; align-items: center; width: 30px; height: 30px; background: transparent; border: 1px solid #ddd; border-radius: 4px;">
                    <span style="width: 18px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s;"></span>
                    <span style="width: 18px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s;"></span>
                    <span style="width: 18px; height: 2px; background: #333; margin: 2px 0; transition: all 0.3s;"></span>
                </button>
            </div>
            <p>ìœ„ì˜ í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ì„ í´ë¦­í•´ë³´ì„¸ìš”:</p>
            <div class="test-item">
                <span>ëª¨ë°”ì¼ ë©”ë‰´ ì´ˆê¸°í™”</span>
                <span id="mobile-menu-init" class="status">í™•ì¸ ì¤‘...</span>
            </div>
            <div class="test-item">
                <span>ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥</span>
                <span id="mobile-menu-toggle" class="status">í™•ì¸ ì¤‘...</span>
            </div>
            <button onclick="initTestMobileMenu()">í…ŒìŠ¤íŠ¸ ë©”ë‰´ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ìºì‹œ í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>ğŸ’¾ ìºì‹œ ìƒíƒœ</h2>
        <div class="test-item">
            <span>ìºì‹œ API ì§€ì›</span>
            <span id="cache-support" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="test-item">
            <span>ì •ì  ìºì‹œ</span>
            <span id="static-cache" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="test-item">
            <span>ë™ì  ìºì‹œ</span>
            <span id="dynamic-cache" class="status">í™•ì¸ ì¤‘...</span>
        </div>
        <button onclick="checkCacheStatus()">ìºì‹œ ìƒíƒœ í™•ì¸</button>
        <button onclick="clearAllCaches()">ëª¨ë“  ìºì‹œ ì‚­ì œ</button>
    </div>

    <!-- ë¡œê·¸ ì¶œë ¥ -->
    <div class="test-section">
        <h2>ğŸ“Š ì‹¤ì‹œê°„ ë¡œê·¸</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <button onclick="downloadLog()">ë¡œê·¸ ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <script type="module">
        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const logDiv = document.getElementById('log');
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#6b7280';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[PWA Test] ${message}`);
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message || (status === 'pass' ? 'âœ… ì •ìƒ' : status === 'fail' ? 'âŒ ì‹¤íŒ¨' : 'âš ï¸ ê²½ê³ ');
        }

        // Service Worker ìƒíƒœ í™•ì¸
        window.checkServiceWorkerStatus = async function() {
            log('Service Worker ìƒíƒœ í™•ì¸ ì‹œì‘');
            
            if ('serviceWorker' in navigator) {
                updateStatus('sw-support', 'pass');
                log('Service Worker API ì§€ì›ë¨', 'success');
                
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        updateStatus('sw-registered', 'pass');
                        log('Service Worker ë“±ë¡ë¨', 'success');
                        
                        if (registration.active) {
                            updateStatus('sw-active', 'pass');
                            log('Service Worker í™œì„±í™”ë¨', 'success');
                            
                            // ë²„ì „ í™•ì¸
                            const channel = new MessageChannel();
                            channel.port1.onmessage = function(event) {
                                const version = event.data?.version || 'ì•Œ ìˆ˜ ì—†ìŒ';
                                updateStatus('sw-version', 'pass', `v${version}`);
                                log(`Service Worker ë²„ì „: ${version}`, 'success');
                            };
                            
                            registration.active.postMessage({type: 'GET_VERSION'}, [channel.port2]);
                        } else {
                            updateStatus('sw-active', 'warning', 'ë¹„í™œì„±');
                            log('Service Workerê°€ í™œì„±í™”ë˜ì§€ ì•ŠìŒ', 'error');
                        }
                    } else {
                        updateStatus('sw-registered', 'fail');
                        log('Service Workerê°€ ë“±ë¡ë˜ì§€ ì•ŠìŒ', 'error');
                    }
                } catch (error) {
                    log(`Service Worker í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            } else {
                updateStatus('sw-support', 'fail');
                log('Service Workerê°€ ì§€ì›ë˜ì§€ ì•ŠìŒ', 'error');
            }
        };

        // Service Worker ì—…ë°ì´íŠ¸
        window.updateServiceWorker = async function() {
            log('Service Worker ì—…ë°ì´íŠ¸ í™•ì¸');
            
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.update();
                    log('Service Worker ì—…ë°ì´íŠ¸ í™•ì¸ ì™„ë£Œ', 'success');
                } else {
                    log('ë“±ë¡ëœ Service Workerê°€ ì—†ìŒ', 'error');
                }
            } catch (error) {
                log(`Service Worker ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // PWA ìƒíƒœ í™•ì¸
        window.checkPWAStatus = function() {
            log('PWA ìƒíƒœ í™•ì¸ ì‹œì‘');
            
            // ì„¤ì¹˜ ê°€ëŠ¥ ì—¬ë¶€
            if (window.deferredPrompt) {
                updateStatus('pwa-installable', 'pass', 'ì„¤ì¹˜ ê°€ëŠ¥');
                log('PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì‚¬ìš© ê°€ëŠ¥', 'success');
            } else {
                updateStatus('pwa-installable', 'warning', 'í”„ë¡¬í”„íŠ¸ ì—†ìŒ');
                log('PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì—†ìŒ (ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆê±°ë‚˜ ê¸°ì¤€ ë¯¸ì¶©ì¡±)', 'info');
            }
            
            // PWA ëª¨ë“œ í™•ì¸
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true;
            
            if (isPWA) {
                updateStatus('pwa-mode', 'pass', 'PWA ëª¨ë“œ');
                log('PWA ëª¨ë“œì—ì„œ ì‹¤í–‰ ì¤‘', 'success');
            } else {
                updateStatus('pwa-mode', 'warning', 'ë¸Œë¼ìš°ì € ëª¨ë“œ');
                log('ë¸Œë¼ìš°ì € ëª¨ë“œì—ì„œ ì‹¤í–‰ ì¤‘', 'info');
            }
            
            // ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                updateStatus('manifest-loaded', 'pass');
                log('ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë§í¬ ë°œê²¬', 'success');
            } else {
                updateStatus('manifest-loaded', 'fail');
                log('ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë§í¬ ì—†ìŒ', 'error');
            }
        };

        // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
        window.showInstallPrompt = function() {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                log('PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œë¨', 'success');
            } else {
                log('ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ', 'error');
            }
        };

        // ìºì‹œ ìƒíƒœ í™•ì¸
        window.checkCacheStatus = async function() {
            log('ìºì‹œ ìƒíƒœ í™•ì¸ ì‹œì‘');
            
            if ('caches' in window) {
                updateStatus('cache-support', 'pass');
                log('Cache API ì§€ì›ë¨', 'success');
                
                try {
                    const cacheNames = await caches.keys();
                    log(`ì´ ${cacheNames.length}ê°œì˜ ìºì‹œ ë°œê²¬: ${cacheNames.join(', ')}`, 'success');
                    
                    const staticCache = cacheNames.find(name => name.includes('static'));
                    const dynamicCache = cacheNames.find(name => name.includes('dynamic'));
                    
                    updateStatus('static-cache', staticCache ? 'pass' : 'fail', 
                                staticCache || 'ì—†ìŒ');
                    updateStatus('dynamic-cache', dynamicCache ? 'pass' : 'fail', 
                                dynamicCache || 'ì—†ìŒ');
                    
                    if (staticCache) {
                        const cache = await caches.open(staticCache);
                        const keys = await cache.keys();
                        log(`ì •ì  ìºì‹œì— ${keys.length}ê°œ í•­ëª© ì €ì¥ë¨`, 'success');
                    }
                } catch (error) {
                    log(`ìºì‹œ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            } else {
                updateStatus('cache-support', 'fail');
                log('Cache APIê°€ ì§€ì›ë˜ì§€ ì•ŠìŒ', 'error');
            }
        };

        // ëª¨ë“  ìºì‹œ ì‚­ì œ
        window.clearAllCaches = async function() {
            log('ëª¨ë“  ìºì‹œ ì‚­ì œ ì‹œì‘');
            
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                log(`${cacheNames.length}ê°œ ìºì‹œ ì‚­ì œ ì™„ë£Œ`, 'success');
                checkCacheStatus();
            } catch (error) {
                log(`ìºì‹œ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // í…ŒìŠ¤íŠ¸ ëª¨ë°”ì¼ ë©”ë‰´ ì´ˆê¸°í™”
        window.initTestMobileMenu = function() {
            log('í…ŒìŠ¤íŠ¸ ëª¨ë°”ì¼ ë©”ë‰´ ì´ˆê¸°í™”');
            
            const toggle = document.querySelector('.mobile-menu-toggle');
            if (toggle) {
                updateStatus('mobile-menu-init', 'pass');
                log('ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ ë°œê²¬', 'success');
                
                // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                toggle.onclick = function() {
                    const spans = this.querySelectorAll('span');
                    const isActive = this.classList.contains('active');
                    
                    if (isActive) {
                        this.classList.remove('active');
                        spans.forEach((span, index) => {
                            span.style.transform = '';
                            span.style.opacity = '';
                        });
                        updateStatus('mobile-menu-toggle', 'pass', 'ë©”ë‰´ ë‹«íŒ');
                        log('í…ŒìŠ¤íŠ¸ ë©”ë‰´ ë‹«í˜', 'success');
                    } else {
                        this.classList.add('active');
                        spans[0].style.transform = 'rotate(45deg) translate(5px, 5px)';
                        spans[1].style.opacity = '0';
                        spans[2].style.transform = 'rotate(-45deg) translate(7px, -6px)';
                        updateStatus('mobile-menu-toggle', 'pass', 'ë©”ë‰´ ì—´ë¦¼');
                        log('í…ŒìŠ¤íŠ¸ ë©”ë‰´ ì—´ë¦¼', 'success');
                    }
                };
            } else {
                updateStatus('mobile-menu-init', 'fail');
                log('ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ ì—†ìŒ', 'error');
            }
        };

        // ë¡œê·¸ ì§€ìš°ê¸°
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        // ë¡œê·¸ ë‹¤ìš´ë¡œë“œ
        window.downloadLog = function() {
            const logContent = document.getElementById('log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pwa-test-log-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            window.deferredPrompt = e;
            log('PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ìºì¹˜ë¨', 'success');
        });

        window.addEventListener('appinstalled', () => {
            log('PWA ì„¤ì¹˜ ì™„ë£Œ!', 'success');
            checkPWAStatus();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        window.addEventListener('load', () => {
            log('PWA í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨', 'success');
            
            setTimeout(() => {
                checkServiceWorkerStatus();
                checkPWAStatus();
                checkCacheStatus();
                initTestMobileMenu();
            }, 1000);
        });
    </script>
</body>
</html>