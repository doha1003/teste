!function(){"use strict";const e={config:{enableBotDetection:!0,enableUserTracking:!0,enablePerformanceTracking:!0,enableErrorTracking:!0,maxEventsPerSession:100,sessionTimeout:18e5,apiEndpoint:"/api/analytics"},sessionId:null,userId:null,events:[],botDetected:!1,lastActivity:Date.now(),init:function(){this.sessionId=this.generateSessionId(),this.userId=this.getUserId(),this.detectBot(),this.setupEventListeners(),this.startSessionTracking(),console.log("Analytics system initialized",{sessionId:this.sessionId,botDetected:this.botDetected})},generateSessionId:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)},getUserId:function(){let e=localStorage.getItem("userId");return e||(e="user_"+Date.now().toString(36)+Math.random().toString(36).substr(2),localStorage.setItem("userId",e)),e},detectBot:function(){if(!this.config.enableBotDetection)return;const e={userAgent:this.checkUserAgentForBot(),webdriver:this.checkWebDriver(),plugins:this.checkPlugins(),languages:this.checkLanguages(),screen:this.checkScreenProperties(),mouse:this.checkMouseBehavior(),timing:this.checkTimingBehavior()};let t=0;return Object.keys(e).forEach(n=>{null!==e[n]&&(t+=e[n]?15:0)}),t+=this.checkSuspiciousBehavior(),this.botDetected=t>30,this.trackEvent("bot_detection",{score:t,detected:this.botDetected,indicators:e}),this.botDetected},checkUserAgentForBot:function(){const e=navigator.userAgent.toLowerCase();return[/bot/i,/crawl/i,/spider/i,/scraper/i,/facebookexternalhit/i,/whatsapp/i,/telegram/i,/linkedinbot/i,/twitterbot/i,/googlebot/i,/bingbot/i,/yandexbot/i,/baiduspider/i,/phantom/i,/selenium/i,/headless/i,/automated/i,/testing/i].some(t=>t.test(e))},checkWebDriver:function(){return!!(window.navigator.webdriver||window.callPhantom||window._phantom||window.phantom||window.Buffer||window.emit||window.spawn)},checkPlugins:function(){if(!navigator.plugins)return!0;if(0===navigator.plugins.length)return!0;const e=Array.from(navigator.plugins).map(e=>e.name.toLowerCase());return["headless","phantom","selenium"].some(t=>e.some(e=>e.includes(t)))},checkLanguages:function(){if(!navigator.languages||0===navigator.languages.length)return!0;const e=navigator.language;return!navigator.languages.includes(e)},checkScreenProperties:function(){const e=`${screen.width}x${screen.height}`;return!!["1024x768","800x600","1280x1024","1366x768","1920x1080"].includes(e)||0===screen.width||0===screen.height||0===screen.colorDepth},checkMouseBehavior:function(){let t=0,n=0,i=0,o=0;const s=function(e){if(t++,t>1){const t=Math.abs(e.clientX-i),s=Math.abs(e.clientY-o);(0===t&&s>10||0===s&&t>10)&&n++}i=e.clientX,o=e.clientY,t>=50&&document.removeEventListener("mousemove",s)};return document.addEventListener("mousemove",s),setTimeout(()=>{const i=0===t||n/t>.8?1:0;e.updateBotScore("mouse",i)},5e3),null},checkTimingBehavior:function(){const t=performance.now();let n=0;const i=["click","scroll","keydown","touchstart"],o=function(){n++};return i.forEach(e=>{document.addEventListener(e,o)}),setTimeout(()=>{const s=performance.now()-t,r=n/(s/1e3)>10||s>5e3&&0===n;e.updateBotScore("timing",r?1:0),i.forEach(e=>{document.removeEventListener(e,o)})},1e4),null},checkSuspiciousBehavior:function(){let e=0;if(/mobile|android|iphone|ipad/i.test(navigator.userAgent)&&("ontouchstart"in window||(e+=20)),"undefined"!=typeof Image){const t=new Image;t.style.display="none",document.body.appendChild(t),setTimeout(()=>{!t.complete||0!==t.naturalWidth&&0!==t.naturalHeight||(e+=15),document.body.removeChild(t)},1e3)}let t=0;const n=function(i){t++,t>100&&(e+=10,document.removeEventListener("keydown",n))};return document.addEventListener("keydown",n),e},updateBotScore:function(e,t){this.trackEvent("bot_score_update",{category:e,score:t})},setupEventListeners:function(){const e=this;this.trackPageView(),this.config.enableUserTracking&&!this.botDetected&&this.setupUserInteractionTracking(),this.config.enablePerformanceTracking&&this.setupPerformanceTracking(),this.config.enableErrorTracking&&this.setupErrorTracking(),document.addEventListener("visibilitychange",function(){e.trackEvent("visibility_change",{hidden:document.hidden,timestamp:Date.now()})}),window.addEventListener("beforeunload",function(){e.sendSessionData()})},trackPageView:function(){const e={url:window.location.href,title:document.title,referrer:document.referrer,timestamp:Date.now(),userAgent:navigator.userAgent,screenResolution:`${screen.width}x${screen.height}`,viewportSize:`${window.innerWidth}x${window.innerHeight}`,colorDepth:screen.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language};this.trackEvent("page_view",e)},setupUserInteractionTracking:function(){const e=this;let t;document.addEventListener("click",function(t){e.trackInteraction("click",t)}),document.addEventListener("submit",function(t){e.trackInteraction("form_submit",t)}),window.addEventListener("scroll",function(){clearTimeout(t),t=setTimeout(()=>{e.trackEvent("scroll",{scrollY:window.scrollY,scrollPercent:Math.round(window.scrollY/(document.body.scrollHeight-window.innerHeight)*100)})},250)}),this.startTimeTracking()},trackInteraction:function(e,t){if(this.botDetected)return;const n=t.target,i={type:e,tagName:n.tagName,id:n.id,className:n.className,text:n.textContent?n.textContent.substring(0,100):"",x:t.clientX,y:t.clientY,timestamp:Date.now()};"form_submit"===e&&(i.formAction=n.action,i.formMethod=n.method,i.formElements=n.elements.length),this.trackEvent(e,i)},setupPerformanceTracking:function(){const e=this;window.addEventListener("load",function(){setTimeout(()=>{const t=performance.getEntriesByType("navigation")[0],n=performance.getEntriesByType("paint"),i={loadTime:t.loadEventEnd-t.loadEventStart,domContentLoaded:t.domContentLoadedEventEnd-t.domContentLoadedEventStart,firstPaint:n.find(e=>"first-paint"===e.name)?.startTime||0,firstContentfulPaint:n.find(e=>"first-contentful-paint"===e.name)?.startTime||0,transferSize:t.transferSize,domElements:document.getElementsByTagName("*").length};e.trackEvent("performance",i)},0)}),window.addEventListener("error",function(t){t.target!==window&&e.trackEvent("resource_error",{type:t.target.tagName,src:t.target.src||t.target.href,message:t.message})},!0)},setupErrorTracking:function(){const e=this;if("undefined"!=typeof ErrorHandler){const t=ErrorHandler.handleError;ErrorHandler.handleError=function(n){t.call(this,n),e.trackError(n)}}},startTimeTracking:function(){this.pageStartTime=Date.now();let e=Date.now(),t=0,n=!0;const i=()=>{const i=Date.now();n&&!document.hidden&&(t+=i-e),e=i};["click","scroll","keydown","mousemove","touchstart"].forEach(e=>{document.addEventListener(e,i)}),document.addEventListener("visibilitychange",()=>{n=!document.hidden,i()}),setInterval(()=>{i(),this.trackEvent("time_on_page",{totalTime:Date.now()-this.pageStartTime,activeTime:t})},3e4)},startSessionTracking:function(){const e=this,t=()=>{e.lastActivity=Date.now()};["click","scroll","keydown","mousemove","touchstart"].forEach(e=>{document.addEventListener(e,t)}),setInterval(()=>{Date.now()-e.lastActivity>e.config.sessionTimeout&&e.trackEvent("session_timeout",{duration:Date.now()-e.lastActivity})},6e4)},trackEvent:function(e,t={}){if(this.events.length>=this.config.maxEventsPerSession)return;const n={name:e,data:t,timestamp:Date.now(),sessionId:this.sessionId,userId:this.userId,url:window.location.href,botDetected:this.botDetected};this.events.push(n),this.sendToGoogleAnalytics(e,t),this.sendToCustomAnalytics(n)},trackError:function(e){this.trackEvent("javascript_error",{message:e.message,type:e.type,filename:e.filename,line:e.lineno,stack:e.stack?e.stack.substring(0,500):null})},sendToGoogleAnalytics:function(e,t){try{"undefined"==typeof gtag||this.botDetected||gtag("event",e,{custom_parameter:JSON.stringify(t).substring(0,100),session_id:this.sessionId,user_id:this.userId})}catch(e){console.warn("Failed to send to Google Analytics:",e)}},sendToCustomAnalytics:function(e){try{this.config.apiEndpoint&&!this.botDetected&&this.queueForBatchSend(e)}catch(e){console.warn("Failed to send to custom analytics:",e)}},queueForBatchSend:function(e){this.sendQueue||(this.sendQueue=[],setInterval(()=>{this.sendQueue.length>0&&this.sendBatch()},1e4)),this.sendQueue.push(e),this.sendQueue.length>=10&&this.sendBatch()},sendBatch:function(){if(!this.sendQueue||0===this.sendQueue.length)return;const e=this.sendQueue.splice(0,10);fetch(this.config.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({events:e,sessionId:this.sessionId,timestamp:Date.now()})}).catch(e=>{console.warn("Failed to send analytics batch:",e)})},sendSessionData:function(){const e={sessionId:this.sessionId,userId:this.userId,duration:Date.now()-this.lastActivity,eventsCount:this.events.length,botDetected:this.botDetected,url:window.location.href};navigator.sendBeacon&&this.config.apiEndpoint&&navigator.sendBeacon(this.config.apiEndpoint+"/session",JSON.stringify(e))},getAnalyticsData:function(){return{sessionId:this.sessionId,userId:this.userId,botDetected:this.botDetected,eventsCount:this.events.length,events:this.events.slice(-10)}},clearData:function(){this.events=[],localStorage.removeItem("userId")}};window.Analytics=e,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){e.init()}):e.init(),console.log("Analytics and bot detection system loaded successfully")}();