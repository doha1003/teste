/**
 * App Shell Manager
 * PWA App Shell ì•„í‚¤í…ì²˜ êµ¬í˜„
 * 
 * Features:
 * - Critical UI ë¹ ë¥¸ ë¡œë”©
 * - ì ì§„ì  ì½˜í…ì¸  ë¡œë”©
 * - ì˜¤í”„ë¼ì¸ shell ì§€ì›
 * - ë„¤ì´í‹°ë¸Œ ì•± ìˆ˜ì¤€ì˜ ì‚¬ìš©ì ê²½í—˜
 */

class AppShell {
  constructor() {
    this.config = {
      // App Shell ì»´í¬ë„ŒíŠ¸ë“¤
      shell: {
        navbar: '#navbar-placeholder',
        footer: '#footer-placeholder',
        mainContent: 'main',
        loadingIndicator: '.loading-indicator',
      },
      
      // ë¡œë”© ìƒíƒœ
      loading: {
        shellLoaded: false,
        contentLoaded: false,
        componentsLoaded: new Set(),
      },
      
      // ìºì‹œ ì„¤ì •
      cache: {
        shellComponents: [
          '/includes/navbar.html',
          '/includes/footer.html',
        ],
        criticalCSS: [
          '/dist/styles.min.css',
          '/css/design-system/tokens.css',
        ],
        criticalJS: [
          '/js/app.js',
          '/js/core/common-init.js',
        ],
      },
      
      // ì„±ëŠ¥ ì„ê³„ê°’
      performance: {
        shellTimeout: 2000,  // 2ì´ˆ ë‚´ Shell ë¡œë”©
        contentTimeout: 5000, // 5ì´ˆ ë‚´ ì½˜í…ì¸  ë¡œë”©
        criticalResourceTimeout: 3000, // 3ì´ˆ ë‚´ í•µì‹¬ ë¦¬ì†ŒìŠ¤
      },
      
      // ì• ë‹ˆë©”ì´ì…˜ ì„¤ì •
      animations: {
        shellFadeIn: 200,
        contentSlideIn: 300,
        skeletonPulse: 1500,
      },
    };
    
    this.loadStartTime = performance.now();
    this.metrics = {
      shellLoadTime: 0,
      contentLoadTime: 0,
      totalLoadTime: 0,
      resourceLoadTimes: new Map(),
    };
    
    this.init();
  }
  
  /**
   * App Shell ì´ˆê¸°í™”
   */
  init() {
    // ì„±ëŠ¥ ì¸¡ì • ì‹œì‘
    this.startPerformanceTracking();
    
    // Shell ìš°ì„  ë¡œë”©
    this.loadShell();
    
    // ì»¨í…ì¸  ì§€ì—° ë¡œë”©
    this.scheduleContentLoading();
    
    // ì˜¤í”„ë¼ì¸ ê°ì§€ ë° ì²˜ë¦¬
    this.setupOfflineHandling();
    
    // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ê´€ë¦¬
    this.setupInstallPrompt();
  }
  
  /**
   * App Shell ë¡œë”©
   */
  async loadShell() {
    try {
      // ìŠ¤ì¼ˆë ˆí†¤ UI í‘œì‹œ
      this.showSkeletonUI();
      
      // ë³‘ë ¬ë¡œ Shell ì»´í¬ë„ŒíŠ¸ ë¡œë”©
      const shellPromises = [
        this.loadComponent('navbar', this.config.shell.navbar),
        this.loadComponent('footer', this.config.shell.footer),
        this.preloadCriticalResources(),
      ];
      
      await Promise.allSettled(shellPromises);
      
      // Shell ë¡œë”© ì™„ë£Œ
      this.config.loading.shellLoaded = true;
      this.metrics.shellLoadTime = performance.now() - this.loadStartTime;
      
      // Shell UI í‘œì‹œ
      this.showShell();
      
      // Shell ë¡œë”© ì´ë²¤íŠ¸ ë°œì†¡
      this.dispatchEvent('shell:loaded', {
        loadTime: this.metrics.shellLoadTime,
        timestamp: Date.now(),
      });\n      \n    } catch (error) {\n      console.error('[App Shell] Shell ë¡œë”© ì‹¤íŒ¨:', error);\n      this.handleShellLoadError(error);\n    }\n  }\n  \n  /**\n   * ì»´í¬ë„ŒíŠ¸ ë¡œë”©\n   */\n  async loadComponent(name, selector) {\n    const startTime = performance.now();\n    \n    try {\n      const element = document.querySelector(selector);\n      if (!element) {\n        throw new Error(`Element not found: ${selector}`);\n      }\n      \n      // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸\n      let html = await this.getFromCache(`component:${name}`);\n      \n      if (!html) {\n        // ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë”©\n        const response = await fetch(`/includes/${name}.html`);\n        if (!response.ok) {\n          throw new Error(`HTTP ${response.status}`);\n        }\n        html = await response.text();\n        \n        // ìºì‹œì— ì €ì¥\n        await this.saveToCache(`component:${name}`, html);\n      }\n      \n      // DOMì— ì‚½ì…\n      element.innerHTML = html;\n      \n      // ì»´í¬ë„ŒíŠ¸ë³„ ì´ˆê¸°í™”\n      await this.initializeComponent(name, element);\n      \n      // ë¡œë”© ì™„ë£Œ í‘œì‹œ\n      this.config.loading.componentsLoaded.add(name);\n      \n      const loadTime = performance.now() - startTime;\n      this.metrics.resourceLoadTimes.set(name, loadTime);\n      \n      console.log(`[App Shell] ${name} ì»´í¬ë„ŒíŠ¸ ë¡œë”© ì™„ë£Œ (${loadTime.toFixed(2)}ms)`);\n      \n    } catch (error) {\n      console.error(`[App Shell] ${name} ì»´í¬ë„ŒíŠ¸ ë¡œë”© ì‹¤íŒ¨:`, error);\n      \n      // ì˜¤í”„ë¼ì¸ í´ë°±\n      await this.loadOfflineFallback(name, selector);\n    }\n  }\n  \n  /**\n   * í•µì‹¬ ë¦¬ì†ŒìŠ¤ í”„ë¦¬ë¡œë”©\n   */\n  async preloadCriticalResources() {\n    const preloadPromises = [];\n    \n    // CSS í”„ë¦¬ë¡œë”©\n    for (const cssUrl of this.config.cache.criticalCSS) {\n      preloadPromises.push(this.preloadResource(cssUrl, 'style'));\n    }\n    \n    // JS í”„ë¦¬ë¡œë”© (ì´ë¯¸ ë¡œë“œëœ ê²ƒ ì œì™¸)\n    for (const jsUrl of this.config.cache.criticalJS) {\n      if (!this.isScriptLoaded(jsUrl)) {\n        preloadPromises.push(this.preloadResource(jsUrl, 'script'));\n      }\n    }\n    \n    await Promise.allSettled(preloadPromises);\n  }\n  \n  /**\n   * ë¦¬ì†ŒìŠ¤ í”„ë¦¬ë¡œë”©\n   */\n  async preloadResource(url, type) {\n    return new Promise((resolve, reject) => {\n      const element = document.createElement('link');\n      element.rel = 'preload';\n      element.href = url;\n      element.as = type;\n      \n      if (type === 'style') {\n        element.onload = () => {\n          // CSSë¥¼ ì‹¤ì œë¡œ ì ìš©\n          const linkElement = document.createElement('link');\n          linkElement.rel = 'stylesheet';\n          linkElement.href = url;\n          document.head.appendChild(linkElement);\n          resolve();\n        };\n      } else {\n        element.onload = resolve;\n      }\n      \n      element.onerror = reject;\n      \n      // íƒ€ì„ì•„ì›ƒ ì„¤ì •\n      setTimeout(() => {\n        reject(new Error(`Preload timeout: ${url}`));\n      }, this.config.performance.criticalResourceTimeout);\n      \n      document.head.appendChild(element);\n    });\n  }\n  \n  /**\n   * ì»¨í…ì¸  ë¡œë”© ìŠ¤ì¼€ì¤„ë§\n   */\n  scheduleContentLoading() {\n    // Shell ë¡œë”© í›„ ì»¨í…ì¸  ë¡œë”©\n    const checkShellReady = () => {\n      if (this.config.loading.shellLoaded) {\n        this.loadContent();\n      } else {\n        setTimeout(checkShellReady, 50);\n      }\n    };\n    \n    setTimeout(checkShellReady, 100);\n  }\n  \n  /**\n   * ì»¨í…ì¸  ë¡œë”©\n   */\n  async loadContent() {\n    try {\n      const contentStartTime = performance.now();\n      \n      // í˜ì´ì§€ë³„ ì»¨í…ì¸  ë¡œë”©\n      await this.loadPageContent();\n      \n      // ë¹„í•µì‹¬ ë¦¬ì†ŒìŠ¤ ì§€ì—° ë¡œë”©\n      this.scheduleNonCriticalLoading();\n      \n      // ì»¨í…ì¸  ë¡œë”© ì™„ë£Œ\n      this.config.loading.contentLoaded = true;\n      this.metrics.contentLoadTime = performance.now() - contentStartTime;\n      this.metrics.totalLoadTime = performance.now() - this.loadStartTime;\n      \n      // ìŠ¤ì¼ˆë ˆí†¤ UI ìˆ¨ê¸°ê¸°\n      this.hideSkeletonUI();\n      \n      // ì»¨í…ì¸  í‘œì‹œ\n      this.showContent();\n      \n      // ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸\n      this.dispatchEvent('content:loaded', {\n        contentLoadTime: this.metrics.contentLoadTime,\n        totalLoadTime: this.metrics.totalLoadTime,\n      });\n      \n      // ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë³´ê³ \n      this.reportPerformanceMetrics();\n      \n    } catch (error) {\n      console.error('[App Shell] ì»¨í…ì¸  ë¡œë”© ì‹¤íŒ¨:', error);\n      this.handleContentLoadError(error);\n    }\n  }\n  \n  /**\n   * í˜ì´ì§€ë³„ ì»¨í…ì¸  ë¡œë”©\n   */\n  async loadPageContent() {\n    const page = document.documentElement.dataset.page || 'home';\n    \n    try {\n      // í˜ì´ì§€ë³„ ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë”©\n      const pageScript = `/js/pages/${page}.js`;\n      if (await this.resourceExists(pageScript)) {\n        await this.loadScript(pageScript);\n      }\n      \n      // í˜ì´ì§€ë³„ ì¶”ê°€ ë¦¬ì†ŒìŠ¤ ë¡œë”©\n      await this.loadPageSpecificResources(page);\n      \n    } catch (error) {\n      console.warn(`[App Shell] í˜ì´ì§€ ì»¨í…ì¸  ë¡œë”© ê²½ê³  (${page}):`, error);\n    }\n  }\n  \n  /**\n   * ìŠ¤ì¼ˆë ˆí†¤ UI í‘œì‹œ\n   */\n  showSkeletonUI() {\n    // ìŠ¤ì¼ˆë ˆí†¤ HTML ìƒì„±\n    const skeletonHTML = this.generateSkeletonHTML();\n    \n    // ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ì— ìŠ¤ì¼ˆë ˆí†¤ ì‚½ì…\n    const mainElement = document.querySelector(this.config.shell.mainContent);\n    if (mainElement) {\n      const skeletonContainer = document.createElement('div');\n      skeletonContainer.id = 'app-shell-skeleton';\n      skeletonContainer.innerHTML = skeletonHTML;\n      skeletonContainer.style.cssText = `\n        opacity: 1;\n        transition: opacity ${this.config.animations.shellFadeIn}ms ease;\n      `;\n      \n      mainElement.appendChild(skeletonContainer);\n    }\n  }\n  \n  /**\n   * ìŠ¤ì¼ˆë ˆí†¤ HTML ìƒì„±\n   */\n  generateSkeletonHTML() {\n    return `\n      <div class=\"skeleton-container\">\n        <div class=\"skeleton-header\">\n          <div class=\"skeleton-line skeleton-title\"></div>\n          <div class=\"skeleton-line skeleton-subtitle\"></div>\n        </div>\n        \n        <div class=\"skeleton-content\">\n          <div class=\"skeleton-card\">\n            <div class=\"skeleton-line\"></div>\n            <div class=\"skeleton-line\"></div>\n            <div class=\"skeleton-line short\"></div>\n          </div>\n          \n          <div class=\"skeleton-card\">\n            <div class=\"skeleton-line\"></div>\n            <div class=\"skeleton-line\"></div>\n            <div class=\"skeleton-line short\"></div>\n          </div>\n          \n          <div class=\"skeleton-card\">\n            <div class=\"skeleton-line\"></div>\n            <div class=\"skeleton-line\"></div>\n            <div class=\"skeleton-line short\"></div>\n          </div>\n        </div>\n      </div>\n      \n      <style>\n        .skeleton-container {\n          padding: 2rem 1rem;\n          max-width: 1200px;\n          margin: 0 auto;\n        }\n        \n        .skeleton-header {\n          margin-bottom: 2rem;\n          text-align: center;\n        }\n        \n        .skeleton-line {\n          height: 16px;\n          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);\n          background-size: 200% 100%;\n          animation: skeleton-loading ${this.config.animations.skeletonPulse}ms infinite;\n          border-radius: 4px;\n          margin-bottom: 12px;\n        }\n        \n        .skeleton-title {\n          height: 32px;\n          width: 60%;\n          margin: 0 auto 16px;\n        }\n        \n        .skeleton-subtitle {\n          height: 20px;\n          width: 40%;\n          margin: 0 auto;\n        }\n        \n        .skeleton-content {\n          display: grid;\n          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n          gap: 1.5rem;\n        }\n        \n        .skeleton-card {\n          padding: 1.5rem;\n          border: 1px solid #e5e7eb;\n          border-radius: 8px;\n          background: white;\n        }\n        \n        .skeleton-line.short {\n          width: 60%;\n        }\n        \n        @keyframes skeleton-loading {\n          0% { background-position: 200% 0; }\n          100% { background-position: -200% 0; }\n        }\n        \n        @media (max-width: 768px) {\n          .skeleton-container { padding: 1rem; }\n          .skeleton-content { grid-template-columns: 1fr; }\n        }\n      </style>\n    `;\n  }\n  \n  /**\n   * Shell í‘œì‹œ\n   */\n  showShell() {\n    document.body.classList.add('shell-loaded');\n    \n    // Shell ì»´í¬ë„ŒíŠ¸ë“¤ fade-in ì• ë‹ˆë©”ì´ì…˜\n    const shellElements = [\n      document.querySelector(this.config.shell.navbar),\n      document.querySelector(this.config.shell.footer),\n    ];\n    \n    shellElements.forEach((element, index) => {\n      if (element) {\n        element.style.cssText = `\n          opacity: 0;\n          transform: translateY(-10px);\n          transition: opacity ${this.config.animations.shellFadeIn}ms ease ${index * 100}ms,\n                      transform ${this.config.animations.shellFadeIn}ms ease ${index * 100}ms;\n        `;\n        \n        // ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°\n        setTimeout(() => {\n          element.style.opacity = '1';\n          element.style.transform = 'translateY(0)';\n        }, 50);\n      }\n    });\n  }\n  \n  /**\n   * ì»¨í…ì¸  í‘œì‹œ\n   */\n  showContent() {\n    const mainElement = document.querySelector(this.config.shell.mainContent);\n    if (mainElement) {\n      mainElement.classList.add('content-loaded');\n      \n      // ì»¨í…ì¸  slide-in ì• ë‹ˆë©”ì´ì…˜\n      const contentElements = mainElement.querySelectorAll(':scope > *:not(#app-shell-skeleton)');\n      \n      contentElements.forEach((element, index) => {\n        element.style.cssText = `\n          opacity: 0;\n          transform: translateY(20px);\n          transition: opacity ${this.config.animations.contentSlideIn}ms ease ${index * 50}ms,\n                      transform ${this.config.animations.contentSlideIn}ms ease ${index * 50}ms;\n        `;\n        \n        setTimeout(() => {\n          element.style.opacity = '1';\n          element.style.transform = 'translateY(0)';\n        }, 100);\n      });\n    }\n  }\n  \n  /**\n   * ìŠ¤ì¼ˆë ˆí†¤ UI ìˆ¨ê¸°ê¸°\n   */\n  hideSkeletonUI() {\n    const skeleton = document.getElementById('app-shell-skeleton');\n    if (skeleton) {\n      skeleton.style.opacity = '0';\n      \n      setTimeout(() => {\n        skeleton.remove();\n      }, this.config.animations.shellFadeIn);\n    }\n  }\n  \n  /**\n   * ì˜¤í”„ë¼ì¸ ì²˜ë¦¬ ì„¤ì •\n   */\n  setupOfflineHandling() {\n    window.addEventListener('online', () => {\n      this.handleOnlineStateChange(true);\n    });\n    \n    window.addEventListener('offline', () => {\n      this.handleOnlineStateChange(false);\n    });\n    \n    // ì´ˆê¸° ì˜¨ë¼ì¸ ìƒíƒœ í™•ì¸\n    this.updateOnlineStatus(navigator.onLine);\n  }\n  \n  /**\n   * ì˜¨ë¼ì¸ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬\n   */\n  handleOnlineStateChange(isOnline) {\n    this.updateOnlineStatus(isOnline);\n    \n    if (isOnline) {\n      // ì˜¨ë¼ì¸ ë³µêµ¬ ì‹œ ëŒ€ê¸° ì¤‘ì¸ ë¦¬ì†ŒìŠ¤ ë¡œë”©\n      this.retryFailedLoading();\n    } else {\n      // ì˜¤í”„ë¼ì¸ ëª¨ë“œ UI í‘œì‹œ\n      this.showOfflineIndicator();\n    }\n  }\n  \n  /**\n   * ì˜¨ë¼ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸\n   */\n  updateOnlineStatus(isOnline) {\n    document.body.classList.toggle('offline', !isOnline);\n    document.body.classList.toggle('online', isOnline);\n    \n    // ì´ë²¤íŠ¸ ë°œì†¡\n    this.dispatchEvent('connectivity:changed', {\n      online: isOnline,\n      timestamp: Date.now(),\n    });\n  }\n  \n  /**\n   * ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì„¤ì •\n   */\n  setupInstallPrompt() {\n    let deferredPrompt = null;\n    \n    window.addEventListener('beforeinstallprompt', (e) => {\n      e.preventDefault();\n      deferredPrompt = e;\n      \n      // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ UI í‘œì‹œ\n      this.showInstallPrompt(deferredPrompt);\n    });\n    \n    // ì„¤ì¹˜ ì™„ë£Œ ê°ì§€\n    window.addEventListener('appinstalled', () => {\n      this.handleAppInstalled();\n    });\n  }\n  \n  /**\n   * ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ\n   */\n  showInstallPrompt(deferredPrompt) {\n    // ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° í”„ë¡¬í”„íŠ¸ í‘œì‹œí•˜ì§€ ì•ŠìŒ\n    if (window.matchMedia('(display-mode: standalone)').matches) {\n      return;\n    }\n    \n    // ì‚¬ìš©ìê°€ ì´ë¯¸ ê±°ë¶€í•œ ê²½ìš° í™•ì¸\n    const dismissed = localStorage.getItem('pwa-install-dismissed');\n    if (dismissed && Date.now() - parseInt(dismissed) < 7 * 24 * 60 * 60 * 1000) {\n      return; // 7ì¼ ë™ì•ˆ í‘œì‹œí•˜ì§€ ì•ŠìŒ\n    }\n    \n    // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ UI ìƒì„±\n    const installBanner = this.createInstallPromptUI(deferredPrompt);\n    document.body.appendChild(installBanner);\n    \n    // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ í‘œì‹œ\n    setTimeout(() => {\n      installBanner.classList.add('visible');\n    }, 2000); // 2ì´ˆ í›„ í‘œì‹œ\n  }\n  \n  /**\n   * ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ UI ìƒì„±\n   */\n  createInstallPromptUI(deferredPrompt) {\n    const banner = document.createElement('div');\n    banner.id = 'pwa-install-banner';\n    banner.innerHTML = `\n      <div class=\"install-content\">\n        <div class=\"install-icon\">ğŸ“±</div>\n        <div class=\"install-text\">\n          <div class=\"install-title\">ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</div>\n          <div class=\"install-subtitle\">ë” ë¹ ë¥´ê³  í¸ë¦¬í•˜ê²Œ ì´ìš©í•˜ì„¸ìš”</div>\n        </div>\n        <div class=\"install-actions\">\n          <button class=\"install-btn install-btn--primary\" id=\"install-accept\">\n            ì„¤ì¹˜\n          </button>\n          <button class=\"install-btn install-btn--secondary\" id=\"install-dismiss\">\n            ë‚˜ì¤‘ì—\n          </button>\n        </div>\n      </div>\n    `;\n    \n    // ìŠ¤íƒ€ì¼ ì ìš©\n    banner.style.cssText = `\n      position: fixed;\n      bottom: -120px;\n      left: 16px;\n      right: 16px;\n      background: white;\n      border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);\n      z-index: 1000;\n      transition: bottom 300ms ease;\n      border: 1px solid #e5e7eb;\n      max-width: 400px;\n      margin: 0 auto;\n    `;\n    \n    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ\n    banner.querySelector('#install-accept').addEventListener('click', async () => {\n      try {\n        await deferredPrompt.prompt();\n        const choiceResult = await deferredPrompt.userChoice;\n        \n        this.trackInstallPromptResult(choiceResult.outcome);\n        banner.remove();\n        \n      } catch (error) {\n        console.error('ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì˜¤ë¥˜:', error);\n      }\n    });\n    \n    banner.querySelector('#install-dismiss').addEventListener('click', () => {\n      localStorage.setItem('pwa-install-dismissed', Date.now().toString());\n      banner.classList.remove('visible');\n      setTimeout(() => banner.remove(), 300);\n      \n      this.trackInstallPromptResult('dismissed');\n    });\n    \n    // CSS ì¶”ê°€\n    if (!document.getElementById('install-prompt-styles')) {\n      const styles = document.createElement('style');\n      styles.id = 'install-prompt-styles';\n      styles.textContent = `\n        #pwa-install-banner.visible { bottom: 16px; }\n        \n        .install-content {\n          display: flex;\n          align-items: center;\n          padding: 16px;\n          gap: 12px;\n        }\n        \n        .install-icon {\n          font-size: 24px;\n          flex-shrink: 0;\n        }\n        \n        .install-text {\n          flex: 1;\n          min-width: 0;\n        }\n        \n        .install-title {\n          font-size: 16px;\n          font-weight: 600;\n          color: #111827;\n          margin-bottom: 2px;\n        }\n        \n        .install-subtitle {\n          font-size: 14px;\n          color: #6b7280;\n        }\n        \n        .install-actions {\n          display: flex;\n          gap: 8px;\n          flex-shrink: 0;\n        }\n        \n        .install-btn {\n          padding: 8px 16px;\n          border-radius: 6px;\n          border: none;\n          font-size: 14px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 150ms ease;\n        }\n        \n        .install-btn--primary {\n          background: #6366f1;\n          color: white;\n        }\n        \n        .install-btn--primary:hover {\n          background: #5856eb;\n        }\n        \n        .install-btn--secondary {\n          background: #f3f4f6;\n          color: #374151;\n        }\n        \n        .install-btn--secondary:hover {\n          background: #e5e7eb;\n        }\n        \n        @media (max-width: 480px) {\n          .install-actions {\n            flex-direction: column;\n          }\n          \n          .install-btn {\n            width: 100%;\n          }\n        }\n      `;\n      document.head.appendChild(styles);\n    }\n    \n    return banner;\n  }\n  \n  /**\n   * ì•± ì„¤ì¹˜ ì™„ë£Œ ì²˜ë¦¬\n   */\n  handleAppInstalled() {\n    // ì„¤ì¹˜ ì™„ë£Œ ì•Œë¦¼\n    this.showInstallSuccessMessage();\n    \n    // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì œê±°\n    const installBanner = document.getElementById('pwa-install-banner');\n    if (installBanner) {\n      installBanner.remove();\n    }\n    \n    // ì„¤ì¹˜ ì™„ë£Œ ì¶”ì \n    this.trackEvent('pwa_installed', {\n      timestamp: Date.now(),\n      user_agent: navigator.userAgent,\n    });\n  }\n  \n  /**\n   * ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë³´ê³ \n   */\n  reportPerformanceMetrics() {\n    const metrics = {\n      ...this.metrics,\n      timestamp: Date.now(),\n      page: document.documentElement.dataset.page || 'unknown',\n      viewport: {\n        width: window.innerWidth,\n        height: window.innerHeight,\n      },\n      connection: this.getConnectionInfo(),\n    };\n    \n    // ë¶„ì„ ë„êµ¬ë¡œ ì „ì†¡\n    this.trackEvent('app_shell_performance', metrics);\n    \n    // ì½˜ì†”ì— ì„±ëŠ¥ ìš”ì•½ ì¶œë ¥\n    console.group('[App Shell] ì„±ëŠ¥ ë©”íŠ¸ë¦­');\n    console.log('Shell ë¡œë”© ì‹œê°„:', `${metrics.shellLoadTime.toFixed(2)}ms`);\n    console.log('ì»¨í…ì¸  ë¡œë”© ì‹œê°„:', `${metrics.contentLoadTime.toFixed(2)}ms`);\n    console.log('ì´ ë¡œë”© ì‹œê°„:', `${metrics.totalLoadTime.toFixed(2)}ms`);\n    console.log('ì»´í¬ë„ŒíŠ¸ ë¡œë”© ì‹œê°„:', Object.fromEntries(metrics.resourceLoadTimes));\n    console.groupEnd();\n  }\n  \n  /**\n   * ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë“¤\n   */\n  \n  async getFromCache(key) {\n    try {\n      const cache = await caches.open('app-shell-v1');\n      const response = await cache.match(key);\n      return response ? await response.text() : null;\n    } catch {\n      return null;\n    }\n  }\n  \n  async saveToCache(key, data) {\n    try {\n      const cache = await caches.open('app-shell-v1');\n      await cache.put(key, new Response(data));\n    } catch (error) {\n      console.warn('ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', error);\n    }\n  }\n  \n  isScriptLoaded(src) {\n    return Array.from(document.scripts).some(script => script.src.includes(src));\n  }\n  \n  async resourceExists(url) {\n    try {\n      const response = await fetch(url, { method: 'HEAD' });\n      return response.ok;\n    } catch {\n      return false;\n    }\n  }\n  \n  async loadScript(src) {\n    return new Promise((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = src;\n      script.type = 'module';\n      script.onload = resolve;\n      script.onerror = reject;\n      document.head.appendChild(script);\n    });\n  }\n  \n  getConnectionInfo() {\n    if ('connection' in navigator) {\n      const conn = navigator.connection;\n      return {\n        effectiveType: conn.effectiveType,\n        downlink: conn.downlink,\n        rtt: conn.rtt,\n      };\n    }\n    return null;\n  }\n  \n  dispatchEvent(eventName, detail) {\n    window.dispatchEvent(new CustomEvent(`appshell:${eventName}`, { detail }));\n  }\n  \n  trackEvent(eventName, eventData) {\n    if (typeof gtag !== 'undefined') {\n      gtag('event', eventName, eventData);\n    }\n  }\n  \n  trackInstallPromptResult(outcome) {\n    this.trackEvent('pwa_install_prompt', {\n      outcome,\n      timestamp: Date.now(),\n    });\n  }\n  \n  // ... ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë“¤\n  \n  /**\n   * ì˜¤ë¥˜ ì²˜ë¦¬ ë©”ì„œë“œë“¤\n   */\n  \n  handleShellLoadError(error) {\n    console.error('[App Shell] Shell ë¡œë”© ì‹¤íŒ¨, ê¸°ë³¸ UIë¡œ ì „í™˜');\n    \n    // ê¸°ë³¸ ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ\n    this.showFallbackNavigation();\n    \n    // ì˜¤ë¥˜ ì¶”ì \n    this.trackEvent('app_shell_error', {\n      type: 'shell_load_failed',\n      error: error.message,\n      timestamp: Date.now(),\n    });\n  }\n  \n  handleContentLoadError(error) {\n    console.error('[App Shell] ì»¨í…ì¸  ë¡œë”© ì‹¤íŒ¨');\n    \n    // ìŠ¤ì¼ˆë ˆí†¤ UIëŠ” ìœ ì§€í•˜ë˜ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ\n    this.showContentLoadError();\n    \n    // ì˜¤ë¥˜ ì¶”ì \n    this.trackEvent('app_shell_error', {\n      type: 'content_load_failed',\n      error: error.message,\n      timestamp: Date.now(),\n    });\n  }\n  \n  showFallbackNavigation() {\n    // ê°„ë‹¨í•œ ë„¤ë¹„ê²Œì´ì…˜ HTML ìƒì„±\n    const fallbackNav = `\n      <nav style=\"background: #6366f1; padding: 1rem; color: white;\">\n        <div style=\"max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;\">\n          <h1 style=\"margin: 0; font-size: 1.5rem;\">doha.kr</h1>\n          <div>\n            <a href=\"/\" style=\"color: white; text-decoration: none; margin: 0 1rem;\">í™ˆ</a>\n            <a href=\"/tests/\" style=\"color: white; text-decoration: none; margin: 0 1rem;\">í…ŒìŠ¤íŠ¸</a>\n            <a href=\"/tools/\" style=\"color: white; text-decoration: none; margin: 0 1rem;\">ë„êµ¬</a>\n          </div>\n        </div>\n      </nav>\n    `;\n    \n    const navElement = document.querySelector(this.config.shell.navbar);\n    if (navElement) {\n      navElement.innerHTML = fallbackNav;\n    }\n  }\n  \n  showContentLoadError() {\n    const mainElement = document.querySelector(this.config.shell.mainContent);\n    if (mainElement) {\n      const errorHTML = `\n        <div style=\"text-align: center; padding: 3rem 1rem; max-width: 500px; margin: 0 auto;\">\n          <div style=\"font-size: 3rem; margin-bottom: 1rem;\">âš ï¸</div>\n          <h2 style=\"color: #374151; margin-bottom: 1rem;\">ì»¨í…ì¸  ë¡œë”© ì‹¤íŒ¨</h2>\n          <p style=\"color: #6b7280; margin-bottom: 2rem;\">í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>\n          <button onclick=\"window.location.reload()\" \n                  style=\"background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;\">\n            í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨\n          </button>\n        </div>\n      `;\n      \n      mainElement.innerHTML = errorHTML;\n    }\n  }\n  \n  showInstallSuccessMessage() {\n    // ì„¤ì¹˜ ì„±ê³µ í† ìŠ¤íŠ¸ ë©”ì‹œì§€\n    const toast = document.createElement('div');\n    toast.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #10b981;\n      color: white;\n      padding: 16px;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      z-index: 1001;\n      font-weight: 500;\n      transform: translateX(100%);\n      transition: transform 300ms ease;\n    `;\n    \n    toast.textContent = 'ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!';\n    document.body.appendChild(toast);\n    \n    // ì• ë‹ˆë©”ì´ì…˜\n    setTimeout(() => {\n      toast.style.transform = 'translateX(0)';\n    }, 100);\n    \n    // 3ì´ˆ í›„ ì œê±°\n    setTimeout(() => {\n      toast.style.transform = 'translateX(100%)';\n      setTimeout(() => toast.remove(), 300);\n    }, 3000);\n  }\n  \n  // ... ê¸°íƒ€ ë©”ì„œë“œë“¤ ê³„ì†\n}\n\n// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±\nif (typeof window !== 'undefined') {\n  window.AppShell = AppShell;\n  \n  // DOM ì¤€ë¹„ ì‹œ ìë™ ì´ˆê¸°í™”\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      window.appShell = new AppShell();\n    });\n  } else {\n    window.appShell = new AppShell();\n  }\n}\n\nexport default AppShell;"