/**
 * PWA ì„¤ì¹˜ ê´€ë¦¬ì
 * í¬ë¡œìŠ¤ í”Œë«í¼ PWA ì„¤ì¹˜ ê²½í—˜ ê°œì„ 
 * 
 * Features:
 * - ë¸Œë¼ìš°ì €ë³„ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ìµœì í™”
 * - ì„¤ì¹˜ ìƒíƒœ ì¶”ì  ë° ë¶„ì„
 * - ì‚¬ìš©ì ì¹œí™”ì  ì„¤ì¹˜ ì•ˆë‚´
 * - A/B í…ŒìŠ¤íŠ¸ ì§€ì›
 */

class PWAInstallManager {
  constructor() {
    this.config = {
      // í”„ë¡¬í”„íŠ¸ ì„¤ì •
      prompt: {\n        minSessionTime: 30000, // 30ì´ˆ í›„ í”„ë¡¬í”„íŠ¸ í‘œì‹œ\n        minPageViews: 3, // 3í˜ì´ì§€ ë°©ë¬¸ í›„\n        cooldownPeriod: 7 * 24 * 60 * 60 * 1000, // 7ì¼ ì¿¨ë‹¤ìš´\n        maxDismissCount: 3, // ìµœëŒ€ 3íšŒ ê±°ë¶€ì‹œ ì˜êµ¬ ìˆ¨ê¹€\n        abTestVariants: ['default', 'benefit_focused', 'minimal'],\n      },\n      \n      // ë¸Œë¼ìš°ì €ë³„ ì„¤ì •\n      browsers: {\n        chrome: {\n          supportBeforeInstallPrompt: true,\n          customPromptDelay: 2000,\n        },\n        edge: {\n          supportBeforeInstallPrompt: true,\n          customPromptDelay: 2000,\n        },\n        firefox: {\n          supportBeforeInstallPrompt: false,\n          showInstructions: true,\n        },\n        safari: {\n          supportBeforeInstallPrompt: false,\n          showIOSInstructions: true,\n        },\n      },\n      \n      // ë©”íŠ¸ë¦­ ì¶”ì \n      analytics: {\n        trackPromptShown: true,\n        trackInstallAccepted: true,\n        trackInstallCompleted: true,\n        trackUsageAfterInstall: true,\n      },\n      \n      // UI ì„¤ì •\n      ui: {\n        animationDuration: 300,\n        backdropBlur: true,\n        preventBodyScroll: false,\n        autoHideDelay: 8000,\n      },\n    };\n    \n    this.state = {\n      browserInfo: null,\n      installPromptEvent: null,\n      isInstalled: false,\n      hasBeenPrompted: false,\n      dismissCount: 0,\n      sessionStartTime: Date.now(),\n      pageViewCount: 0,\n      currentVariant: null,\n      userEngagement: {\n        timeOnSite: 0,\n        interactionCount: 0,\n        scrollDepth: 0,\n      },\n    };\n    \n    this.elements = {\n      promptContainer: null,\n      backdropElement: null,\n    };\n    \n    this.init();\n  }\n  \n  /**\n   * ì´ˆê¸°í™”\n   */\n  init() {\n    this.detectBrowserEnvironment();\n    this.loadUserState();\n    this.setupEventListeners();\n    this.trackUserEngagement();\n    this.evaluateInstallPromptTrigger();\n    \n    console.log('[PWA Install] ì„¤ì¹˜ ê´€ë¦¬ì ì´ˆê¸°í™”ë¨:', this.state);\n  }\n  \n  /**\n   * ë¸Œë¼ìš°ì € í™˜ê²½ ê°ì§€\n   */\n  detectBrowserEnvironment() {\n    const userAgent = navigator.userAgent.toLowerCase();\n    \n    this.state.browserInfo = {\n      isChrome: /chrome/.test(userAgent) && !/edge/.test(userAgent),\n      isEdge: /edge/.test(userAgent),\n      isFirefox: /firefox/.test(userAgent),\n      isSafari: /safari/.test(userAgent) && !/chrome/.test(userAgent),\n      isIOSDevice: /ipad|iphone|ipod/.test(userAgent),\n      isAndroid: /android/.test(userAgent),\n      isPWAMode: window.matchMedia('(display-mode: standalone)').matches,\n      supportsInstallPrompt: 'BeforeInstallPromptEvent' in window,\n    };\n    \n    // A/B í…ŒìŠ¤íŠ¸ ë³€í˜• ì„ íƒ\n    this.selectABTestVariant();\n  }\n  \n  /**\n   * ì‚¬ìš©ì ìƒíƒœ ë¡œë“œ\n   */\n  loadUserState() {\n    try {\n      const storedState = localStorage.getItem('pwa-install-state');\n      if (storedState) {\n        const parsed = JSON.parse(storedState);\n        this.state.dismissCount = parsed.dismissCount || 0;\n        this.state.hasBeenPrompted = parsed.hasBeenPrompted || false;\n        this.state.currentVariant = parsed.currentVariant;\n      }\n      \n      // í˜ì´ì§€ ë·° ì¹´ìš´íŠ¸ ì¦ê°€\n      this.state.pageViewCount = this.getSessionPageViews() + 1;\n      this.saveSessionPageViews(this.state.pageViewCount);\n      \n    } catch (error) {\n      console.warn('[PWA Install] ì‚¬ìš©ì ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);\n    }\n  }\n  \n  /**\n   * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •\n   */\n  setupEventListeners() {\n    // beforeinstallprompt ì´ë²¤íŠ¸ (Chrome, Edge)\n    window.addEventListener('beforeinstallprompt', (e) => {\n      e.preventDefault();\n      this.state.installPromptEvent = e;\n      console.log('[PWA Install] beforeinstallprompt ì´ë²¤íŠ¸ ìºì¹˜ë¨');\n    });\n    \n    // ì•± ì„¤ì¹˜ ì™„ë£Œ ê°ì§€\n    window.addEventListener('appinstalled', () => {\n      this.handleInstallCompleted();\n    });\n    \n    // PWA ë””ìŠ¤í”Œë ˆì´ ëª¨ë“œ ë³€ê²½ ê°ì§€\n    window.matchMedia('(display-mode: standalone)').addEventListener('change', (e) => {\n      if (e.matches) {\n        this.handleInstallCompleted();\n      }\n    });\n    \n    // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ìƒíƒœ ì €ì¥\n    window.addEventListener('beforeunload', () => {\n      this.saveUserState();\n    });\n    \n    // ê°€ì‹œì„± ë³€ê²½ ì¶”ì  (ì‚¬ìš©ì ì°¸ì—¬ë„ ì¸¡ì •)\n    document.addEventListener('visibilitychange', () => {\n      this.trackVisibilityChange();\n    });\n  }\n  \n  /**\n   * ì‚¬ìš©ì ì°¸ì—¬ë„ ì¶”ì \n   */\n  trackUserEngagement() {\n    // ìŠ¤í¬ë¡¤ ê¹Šì´ ì¶”ì \n    let maxScrollDepth = 0;\n    window.addEventListener('scroll', this.throttle(() => {\n      const scrollPercent = (window.scrollY + window.innerHeight) / document.body.scrollHeight;\n      maxScrollDepth = Math.max(maxScrollDepth, scrollPercent);\n      this.state.userEngagement.scrollDepth = Math.min(maxScrollDepth, 1);\n    }, 1000));\n    \n    // í´ë¦­/í„°ì¹˜ ìƒí˜¸ì‘ìš© ì¶”ì \n    ['click', 'touchstart'].forEach(eventType => {\n      document.addEventListener(eventType, () => {\n        this.state.userEngagement.interactionCount++;\n      }, { passive: true });\n    });\n    \n    // ì‚¬ì´íŠ¸ ì²´ë¥˜ì‹œê°„ ì¶”ì \n    setInterval(() => {\n      if (!document.hidden) {\n        this.state.userEngagement.timeOnSite = Date.now() - this.state.sessionStartTime;\n      }\n    }, 5000);\n  }\n  \n  /**\n   * ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ íŠ¸ë¦¬ê±° í‰ê°€\n   */\n  evaluateInstallPromptTrigger() {\n    // ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° í”„ë¡¬í”„íŠ¸ í‘œì‹œí•˜ì§€ ì•ŠìŒ\n    if (this.state.browserInfo.isPWAMode || this.state.isInstalled) {\n      return;\n    }\n    \n    // ìµœëŒ€ ê±°ë¶€ íšŸìˆ˜ ì´ˆê³¼ì‹œ\n    if (this.state.dismissCount >= this.config.prompt.maxDismissCount) {\n      console.log('[PWA Install] ìµœëŒ€ ê±°ë¶€ íšŸìˆ˜ ì´ˆê³¼, í”„ë¡¬í”„íŠ¸ ë¹„í™œì„±í™”');\n      return;\n    }\n    \n    // ì¿¨ë‹¤ìš´ ê¸°ê°„ í™•ì¸\n    const lastDismissTime = this.getLastDismissTime();\n    if (lastDismissTime && Date.now() - lastDismissTime < this.config.prompt.cooldownPeriod) {\n      console.log('[PWA Install] ì¿¨ë‹¤ìš´ ê¸°ê°„ ì¤‘, í”„ë¡¬í”„íŠ¸ ëŒ€ê¸°');\n      return;\n    }\n    \n    // íŠ¸ë¦¬ê±° ì¡°ê±´ í™•ì¸\n    setTimeout(() => {\n      this.checkPromptTriggerConditions();\n    }, this.config.prompt.minSessionTime);\n  }\n  \n  /**\n   * í”„ë¡¬í”„íŠ¸ íŠ¸ë¦¬ê±° ì¡°ê±´ í™•ì¸\n   */\n  checkPromptTriggerConditions() {\n    const conditions = {\n      timeOnSite: this.state.userEngagement.timeOnSite >= this.config.prompt.minSessionTime,\n      pageViews: this.state.pageViewCount >= this.config.prompt.minPageViews,\n      userEngagement: this.state.userEngagement.interactionCount > 0,\n      scrollDepth: this.state.userEngagement.scrollDepth > 0.3,\n    };\n    \n    const conditionsMet = Object.values(conditions).filter(Boolean).length >= 2;\n    \n    if (conditionsMet) {\n      console.log('[PWA Install] í”„ë¡¬í”„íŠ¸ ì¡°ê±´ ì¶©ì¡±:', conditions);\n      this.showInstallPrompt();\n    } else {\n      console.log('[PWA Install] í”„ë¡¬í”„íŠ¸ ì¡°ê±´ ë¯¸ì¶©ì¡±:', conditions);\n    }\n  }\n  \n  /**\n   * ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ\n   */\n  async showInstallPrompt() {\n    if (this.state.hasBeenPrompted) {\n      return;\n    }\n    \n    this.state.hasBeenPrompted = true;\n    \n    try {\n      // ë¸Œë¼ìš°ì €ë³„ í”„ë¡¬í”„íŠ¸ ì²˜ë¦¬\n      if (this.state.browserInfo.isIOSDevice && this.state.browserInfo.isSafari) {\n        await this.showIOSInstallInstructions();\n      } else if (this.state.installPromptEvent) {\n        await this.showNativeInstallPrompt();\n      } else {\n        await this.showCustomInstallPrompt();\n      }\n      \n      // ë¶„ì„ ì¶”ì \n      this.trackEvent('install_prompt_shown', {\n        variant: this.state.currentVariant,\n        browser: this.getBrowserName(),\n        trigger_conditions: this.getEngagementMetrics(),\n      });\n      \n    } catch (error) {\n      console.error('[PWA Install] í”„ë¡¬í”„íŠ¸ í‘œì‹œ ì˜¤ë¥˜:', error);\n    }\n  }\n  \n  /**\n   * ë„¤ì´í‹°ë¸Œ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ\n   */\n  async showNativeInstallPrompt() {\n    try {\n      const promptResult = await this.state.installPromptEvent.prompt();\n      const choiceResult = await this.state.installPromptEvent.userChoice;\n      \n      console.log('[PWA Install] ë„¤ì´í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ê²°ê³¼:', choiceResult.outcome);\n      \n      if (choiceResult.outcome === 'accepted') {\n        this.handleInstallAccepted();\n      } else {\n        this.handleInstallDismissed();\n      }\n      \n      // ì´ë²¤íŠ¸ ê°ì²´ ì •ë¦¬\n      this.state.installPromptEvent = null;\n      \n    } catch (error) {\n      console.error('[PWA Install] ë„¤ì´í‹°ë¸Œ í”„ë¡¬í”„íŠ¸ ì˜¤ë¥˜:', error);\n      // í´ë°±ìœ¼ë¡œ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ í‘œì‹œ\n      await this.showCustomInstallPrompt();\n    }\n  }\n  \n  /**\n   * ì»¤ìŠ¤í…€ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ\n   */\n  async showCustomInstallPrompt() {\n    const promptElement = this.createCustomPromptElement();\n    this.elements.promptContainer = promptElement;\n    \n    // ë°±ë“œë¡­ ìƒì„±\n    if (this.config.ui.backdropBlur) {\n      this.createBackdrop();\n    }\n    \n    // ë°”ë”” ìŠ¤í¬ë¡¤ ë°©ì§€\n    if (this.config.ui.preventBodyScroll) {\n      document.body.style.overflow = 'hidden';\n    }\n    \n    // DOMì— ì¶”ê°€\n    document.body.appendChild(promptElement);\n    \n    // ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜ í‘œì‹œ\n    await this.animatePromptIn(promptElement);\n    \n    // ìë™ ìˆ¨ê¹€ íƒ€ì´ë¨¸\n    setTimeout(() => {\n      if (this.elements.promptContainer) {\n        this.hideInstallPrompt();\n      }\n    }, this.config.ui.autoHideDelay);\n  }\n  \n  /**\n   * ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ìš”ì†Œ ìƒì„±\n   */\n  createCustomPromptElement() {\n    const variant = this.state.currentVariant;\n    const content = this.getPromptContent(variant);\n    \n    const element = document.createElement('div');\n    element.id = 'pwa-install-prompt';\n    element.className = `pwa-prompt pwa-prompt--${variant}`;\n    \n    element.innerHTML = `\n      <div class=\"pwa-prompt__content\">\n        <div class=\"pwa-prompt__header\">\n          <div class=\"pwa-prompt__icon\">${content.icon}</div>\n          <h3 class=\"pwa-prompt__title\">${content.title}</h3>\n          <button class=\"pwa-prompt__close\" aria-label=\"ë‹«ê¸°\">&times;</button>\n        </div>\n        \n        <div class=\"pwa-prompt__body\">\n          <p class=\"pwa-prompt__description\">${content.description}</p>\n          \n          ${content.benefits ? `\n            <ul class=\"pwa-prompt__benefits\">\n              ${content.benefits.map(benefit => `\n                <li class=\"pwa-prompt__benefit\">\n                  <span class=\"benefit__icon\">${benefit.icon}</span>\n                  <span class=\"benefit__text\">${benefit.text}</span>\n                </li>\n              `).join('')}\n            </ul>\n          ` : ''}\n        </div>\n        \n        <div class=\"pwa-prompt__footer\">\n          <button class=\"pwa-prompt__button pwa-prompt__button--primary\" id=\"install-accept\">\n            ${content.acceptText}\n          </button>\n          <button class=\"pwa-prompt__button pwa-prompt__button--secondary\" id=\"install-dismiss\">\n            ${content.dismissText}\n          </button>\n        </div>\n      </div>\n    `;\n    \n    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°\n    this.attachPromptEventListeners(element);\n    \n    // ìŠ¤íƒ€ì¼ ì ìš©\n    this.applyPromptStyles();\n    \n    return element;\n  }\n  \n  /**\n   * í”„ë¡¬í”„íŠ¸ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸°\n   */\n  getPromptContent(variant) {\n    const contents = {\n      default: {\n        icon: 'ğŸ“±',\n        title: 'ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°',\n        description: 'doha.krì„ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ë” ë¹ ë¥´ê³  í¸ë¦¬í•˜ê²Œ ì´ìš©í•˜ì„¸ìš”.',\n        acceptText: 'ì„¤ì¹˜í•˜ê¸°',\n        dismissText: 'ë‚˜ì¤‘ì—',\n      },\n      \n      benefit_focused: {\n        icon: 'ğŸš€',\n        title: 'ë” ë‚˜ì€ ê²½í—˜ì„ ìœ„í•´',\n        description: 'ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜œíƒì„ ëˆ„ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:',\n        benefits: [\n          { icon: 'âš¡', text: 'ë” ë¹ ë¥¸ ë¡œë”© ì†ë„' },\n          { icon: 'ğŸ“µ', text: 'ì˜¤í”„ë¼ì¸ì—ì„œë„ ì´ìš© ê°€ëŠ¥' },\n          { icon: 'ğŸ””', text: 'ìƒˆë¡œìš´ ì½˜í…ì¸  ì•Œë¦¼' },\n          { icon: 'ğŸ ', text: 'í™ˆ í™”ë©´ì—ì„œ ë°”ë¡œ ì ‘ê·¼' },\n        ],\n        acceptText: 'ì§€ê¸ˆ ì„¤ì¹˜',\n        dismissText: 'ê±´ë„ˆë›°ê¸°',\n      },\n      \n      minimal: {\n        icon: 'â¬‡ï¸',\n        title: 'ì„¤ì¹˜',\n        description: 'í™ˆ í™”ë©´ì— ì¶”ê°€',\n        acceptText: 'ì¶”ê°€',\n        dismissText: 'ì·¨ì†Œ',\n      },\n    };\n    \n    return contents[variant] || contents.default;\n  }\n  \n  /**\n   * iOS ì„¤ì¹˜ ì•ˆë‚´ í‘œì‹œ\n   */\n  async showIOSInstallInstructions() {\n    const instructionsElement = this.createIOSInstructionsElement();\n    this.elements.promptContainer = instructionsElement;\n    \n    document.body.appendChild(instructionsElement);\n    await this.animatePromptIn(instructionsElement);\n  }\n  \n  /**\n   * iOS ì„¤ì¹˜ ì•ˆë‚´ ìš”ì†Œ ìƒì„±\n   */\n  createIOSInstructionsElement() {\n    const element = document.createElement('div');\n    element.id = 'ios-install-instructions';\n    element.className = 'ios-instructions';\n    \n    element.innerHTML = `\n      <div class=\"ios-instructions__content\">\n        <div class=\"ios-instructions__header\">\n          <h3>í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°</h3>\n          <button class=\"ios-instructions__close\">&times;</button>\n        </div>\n        \n        <div class=\"ios-instructions__body\">\n          <p>Safariì—ì„œ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ì•±ì²˜ëŸ¼ ì‚¬ìš©í•˜ì„¸ìš”:</p>\n          \n          <div class=\"ios-instructions__steps\">\n            <div class=\"step\">\n              <div class=\"step__number\">1</div>\n              <div class=\"step__content\">\n                <div class=\"step__icon\">ğŸ“¤</div>\n                <p>í•˜ë‹¨ì˜ <strong>ê³µìœ </strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</p>\n              </div>\n            </div>\n            \n            <div class=\"step\">\n              <div class=\"step__number\">2</div>\n              <div class=\"step__content\">\n                <div class=\"step__icon\">â•</div>\n                <p><strong>\"í™ˆ í™”ë©´ì— ì¶”ê°€\"</strong>ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>\n              </div>\n            </div>\n            \n            <div class=\"step\">\n              <div class=\"step__number\">3</div>\n              <div class=\"step__content\">\n                <div class=\"step__icon\">âœ…</div>\n                <p><strong>\"ì¶”ê°€\"</strong>ë¥¼ ëˆŒëŸ¬ ì™„ë£Œí•˜ì„¸ìš”</p>\n              </div>\n            </div>\n          </div>\n        </div>\n        \n        <div class=\"ios-instructions__footer\">\n          <button class=\"ios-instructions__dismiss\">í™•ì¸í–ˆìŠµë‹ˆë‹¤</button>\n        </div>\n      </div>\n    `;\n    \n    // iOS ì „ìš© ìŠ¤íƒ€ì¼ ì ìš©\n    this.applyIOSInstructionStyles();\n    \n    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ\n    element.querySelector('.ios-instructions__close').addEventListener('click', () => {\n      this.hideInstallPrompt();\n      this.handleInstallDismissed();\n    });\n    \n    element.querySelector('.ios-instructions__dismiss').addEventListener('click', () => {\n      this.hideInstallPrompt();\n      this.handleInstallDismissed();\n    });\n    \n    return element;\n  }\n  \n  /**\n   * ì„¤ì¹˜ ìˆ˜ë½ ì²˜ë¦¬\n   */\n  handleInstallAccepted() {\n    console.log('[PWA Install] ì„¤ì¹˜ ìˆ˜ë½ë¨');\n    \n    this.trackEvent('install_accepted', {\n      variant: this.state.currentVariant,\n      browser: this.getBrowserName(),\n      session_metrics: this.getEngagementMetrics(),\n    });\n    \n    this.hideInstallPrompt();\n  }\n  \n  /**\n   * ì„¤ì¹˜ ê±°ë¶€ ì²˜ë¦¬\n   */\n  handleInstallDismissed() {\n    console.log('[PWA Install] ì„¤ì¹˜ ê±°ë¶€ë¨');\n    \n    this.state.dismissCount++;\n    this.setLastDismissTime(Date.now());\n    \n    this.trackEvent('install_dismissed', {\n      variant: this.state.currentVariant,\n      dismiss_count: this.state.dismissCount,\n      browser: this.getBrowserName(),\n    });\n    \n    this.hideInstallPrompt();\n    this.saveUserState();\n  }\n  \n  /**\n   * ì„¤ì¹˜ ì™„ë£Œ ì²˜ë¦¬\n   */\n  handleInstallCompleted() {\n    console.log('[PWA Install] ì„¤ì¹˜ ì™„ë£Œë¨');\n    \n    this.state.isInstalled = true;\n    \n    this.trackEvent('install_completed', {\n      variant: this.state.currentVariant,\n      browser: this.getBrowserName(),\n      installation_method: this.getInstallationMethod(),\n    });\n    \n    // ì„¤ì¹˜ ì™„ë£Œ ì•Œë¦¼ í‘œì‹œ\n    this.showInstallSuccessMessage();\n    \n    // ì„¤ì¹˜ í›„ ì‚¬ìš© ì¶”ì  ì‹œì‘\n    this.startPostInstallTracking();\n    \n    this.saveUserState();\n  }\n  \n  /**\n   * í”„ë¡¬í”„íŠ¸ ìˆ¨ê¸°ê¸°\n   */\n  async hideInstallPrompt() {\n    if (!this.elements.promptContainer) return;\n    \n    await this.animatePromptOut(this.elements.promptContainer);\n    \n    // DOMì—ì„œ ì œê±°\n    if (this.elements.promptContainer.parentNode) {\n      this.elements.promptContainer.parentNode.removeChild(this.elements.promptContainer);\n    }\n    \n    // ë°±ë“œë¡­ ì œê±°\n    if (this.elements.backdropElement) {\n      this.elements.backdropElement.remove();\n      this.elements.backdropElement = null;\n    }\n    \n    // ë°”ë”” ìŠ¤í¬ë¡¤ ë³µì›\n    if (this.config.ui.preventBodyScroll) {\n      document.body.style.overflow = '';\n    }\n    \n    this.elements.promptContainer = null;\n  }\n  \n  /**\n   * í”„ë¡¬í”„íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì¸\n   */\n  async animatePromptIn(element) {\n    element.style.cssText = `\n      opacity: 0;\n      transform: translateY(100%);\n      transition: all ${this.config.ui.animationDuration}ms ease;\n    `;\n    \n    // ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘\n    await new Promise(resolve => requestAnimationFrame(resolve));\n    \n    element.style.opacity = '1';\n    element.style.transform = 'translateY(0)';\n    \n    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ ëŒ€ê¸°\n    await new Promise(resolve => \n      setTimeout(resolve, this.config.ui.animationDuration)\n    );\n  }\n  \n  /**\n   * í”„ë¡¬í”„íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì•„ì›ƒ\n   */\n  async animatePromptOut(element) {\n    element.style.opacity = '0';\n    element.style.transform = 'translateY(100%)';\n    \n    await new Promise(resolve => \n      setTimeout(resolve, this.config.ui.animationDuration)\n    );\n  }\n  \n  /**\n   * ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë“¤\n   */\n  \n  selectABTestVariant() {\n    if (!this.state.currentVariant) {\n      const variants = this.config.prompt.abTestVariants;\n      const randomIndex = Math.floor(Math.random() * variants.length);\n      this.state.currentVariant = variants[randomIndex];\n    }\n  }\n  \n  getBrowserName() {\n    const info = this.state.browserInfo;\n    if (info.isChrome) return 'chrome';\n    if (info.isEdge) return 'edge';\n    if (info.isFirefox) return 'firefox';\n    if (info.isSafari) return 'safari';\n    return 'unknown';\n  }\n  \n  getEngagementMetrics() {\n    return {\n      time_on_site: this.state.userEngagement.timeOnSite,\n      interaction_count: this.state.userEngagement.interactionCount,\n      scroll_depth: this.state.userEngagement.scrollDepth,\n      page_views: this.state.pageViewCount,\n    };\n  }\n  \n  getInstallationMethod() {\n    if (this.state.installPromptEvent) return 'native_prompt';\n    if (this.state.browserInfo.isIOSDevice) return 'ios_manual';\n    return 'unknown';\n  }\n  \n  saveUserState() {\n    try {\n      const stateToSave = {\n        dismissCount: this.state.dismissCount,\n        hasBeenPrompted: this.state.hasBeenPrompted,\n        currentVariant: this.state.currentVariant,\n        isInstalled: this.state.isInstalled,\n      };\n      \n      localStorage.setItem('pwa-install-state', JSON.stringify(stateToSave));\n    } catch (error) {\n      console.warn('[PWA Install] ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error);\n    }\n  }\n  \n  getSessionPageViews() {\n    return parseInt(sessionStorage.getItem('pwa-session-page-views') || '0');\n  }\n  \n  saveSessionPageViews(count) {\n    sessionStorage.setItem('pwa-session-page-views', count.toString());\n  }\n  \n  getLastDismissTime() {\n    const stored = localStorage.getItem('pwa-install-last-dismiss');\n    return stored ? parseInt(stored) : null;\n  }\n  \n  setLastDismissTime(timestamp) {\n    localStorage.setItem('pwa-install-last-dismiss', timestamp.toString());\n  }\n  \n  throttle(func, limit) {\n    let inThrottle;\n    return function() {\n      const args = arguments;\n      const context = this;\n      if (!inThrottle) {\n        func.apply(context, args);\n        inThrottle = true;\n        setTimeout(() => inThrottle = false, limit);\n      }\n    };\n  }\n  \n  trackEvent(eventName, eventData) {\n    if (typeof gtag !== 'undefined') {\n      gtag('event', eventName, {\n        ...eventData,\n        timestamp: Date.now(),\n      });\n    }\n    \n    console.log(`[PWA Install] Event: ${eventName}`, eventData);\n  }\n  \n  // ... ê¸°íƒ€ ë©”ì„œë“œë“¤ (ìŠ¤íƒ€ì¼ ì ìš©, ì´ë²¤íŠ¸ ì²˜ë¦¬ ë“±)\n  \n  applyPromptStyles() {\n    if (document.getElementById('pwa-prompt-styles')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'pwa-prompt-styles';\n    style.textContent = `\n      /* PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ìŠ¤íƒ€ì¼ */\n      .pwa-prompt {\n        position: fixed;\n        bottom: 0;\n        left: 0;\n        right: 0;\n        z-index: 10000;\n        max-width: 500px;\n        margin: 0 auto;\n        background: white;\n        border-radius: 16px 16px 0 0;\n        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.15);\n        border: 1px solid #e5e7eb;\n      }\n      \n      .pwa-prompt__content {\n        padding: 24px;\n      }\n      \n      .pwa-prompt__header {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        margin-bottom: 16px;\n      }\n      \n      .pwa-prompt__icon {\n        font-size: 24px;\n        flex-shrink: 0;\n      }\n      \n      .pwa-prompt__title {\n        flex: 1;\n        margin: 0;\n        font-size: 18px;\n        font-weight: 600;\n        color: #111827;\n      }\n      \n      .pwa-prompt__close {\n        background: none;\n        border: none;\n        font-size: 24px;\n        color: #6b7280;\n        cursor: pointer;\n        padding: 4px;\n        border-radius: 4px;\n        flex-shrink: 0;\n      }\n      \n      .pwa-prompt__close:hover {\n        background: #f3f4f6;\n      }\n      \n      .pwa-prompt__description {\n        margin: 0 0 16px;\n        color: #374151;\n        line-height: 1.6;\n      }\n      \n      .pwa-prompt__benefits {\n        list-style: none;\n        margin: 0 0 20px;\n        padding: 0;\n      }\n      \n      .pwa-prompt__benefit {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin-bottom: 8px;\n        font-size: 14px;\n        color: #374151;\n      }\n      \n      .benefit__icon {\n        font-size: 16px;\n        flex-shrink: 0;\n      }\n      \n      .pwa-prompt__footer {\n        display: flex;\n        gap: 12px;\n      }\n      \n      .pwa-prompt__button {\n        flex: 1;\n        padding: 12px 16px;\n        border-radius: 8px;\n        border: none;\n        font-size: 16px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 150ms ease;\n      }\n      \n      .pwa-prompt__button--primary {\n        background: #6366f1;\n        color: white;\n      }\n      \n      .pwa-prompt__button--primary:hover {\n        background: #5856eb;\n      }\n      \n      .pwa-prompt__button--secondary {\n        background: #f3f4f6;\n        color: #374151;\n        border: 1px solid #d1d5db;\n      }\n      \n      .pwa-prompt__button--secondary:hover {\n        background: #e5e7eb;\n      }\n      \n      @media (max-width: 480px) {\n        .pwa-prompt {\n          left: 8px;\n          right: 8px;\n          border-radius: 16px;\n          bottom: 8px;\n        }\n        \n        .pwa-prompt__footer {\n          flex-direction: column;\n        }\n      }\n    `;\n    \n    document.head.appendChild(style);\n  }\n  \n  attachPromptEventListeners(element) {\n    element.querySelector('#install-accept').addEventListener('click', () => {\n      this.handleInstallAccepted();\n    });\n    \n    element.querySelector('#install-dismiss').addEventListener('click', () => {\n      this.handleInstallDismissed();\n    });\n    \n    element.querySelector('.pwa-prompt__close').addEventListener('click', () => {\n      this.handleInstallDismissed();\n    });\n  }\n  \n  createBackdrop() {\n    const backdrop = document.createElement('div');\n    backdrop.style.cssText = `\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n      backdrop-filter: blur(4px);\n      z-index: 9999;\n      opacity: 0;\n      transition: opacity ${this.config.ui.animationDuration}ms ease;\n    `;\n    \n    document.body.appendChild(backdrop);\n    this.elements.backdropElement = backdrop;\n    \n    // ì• ë‹ˆë©”ì´ì…˜\n    requestAnimationFrame(() => {\n      backdrop.style.opacity = '1';\n    });\n    \n    // í´ë¦­ì‹œ ë‹«ê¸°\n    backdrop.addEventListener('click', () => {\n      this.hideInstallPrompt();\n      this.handleInstallDismissed();\n    });\n  }\n  \n  showInstallSuccessMessage() {\n    const toast = document.createElement('div');\n    toast.style.cssText = `\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #10b981;\n      color: white;\n      padding: 16px 20px;\n      border-radius: 8px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      z-index: 10001;\n      font-weight: 500;\n      transform: translateX(100%);\n      transition: transform 300ms ease;\n    `;\n    \n    toast.textContent = 'âœ… ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤!';\n    document.body.appendChild(toast);\n    \n    setTimeout(() => {\n      toast.style.transform = 'translateX(0)';\n    }, 100);\n    \n    setTimeout(() => {\n      toast.style.transform = 'translateX(100%)';\n      setTimeout(() => toast.remove(), 300);\n    }, 4000);\n  }\n  \n  startPostInstallTracking() {\n    // ì„¤ì¹˜ í›„ ì‚¬ìš© íŒ¨í„´ ì¶”ì \n    const trackingData = {\n      installDate: Date.now(),\n      sessionCount: 0,\n      totalUsageTime: 0,\n    };\n    \n    localStorage.setItem('pwa-post-install-tracking', JSON.stringify(trackingData));\n    \n    // ì¼ì£¼ì¼ í›„ ë§Œì¡±ë„ ì¡°ì‚¬ (ì˜ˆì‹œ)\n    setTimeout(() => {\n      this.showPostInstallSurvey();\n    }, 7 * 24 * 60 * 60 * 1000);\n  }\n  \n  // ... ê¸°íƒ€ ë©”ì„œë“œë“¤ ê³„ì†\n}\n\n// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±\nif (typeof window !== 'undefined') {\n  window.PWAInstallManager = PWAInstallManager;\n  \n  // ìë™ ì´ˆê¸°í™”\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      window.pwaInstallManager = new PWAInstallManager();\n    });\n  } else {\n    window.pwaInstallManager = new PWAInstallManager();\n  }\n}\n\nexport default PWAInstallManager;"