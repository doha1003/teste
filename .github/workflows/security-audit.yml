name: Security Audit & Dependency Check

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œì— ì‹¤í–‰
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'package*.json'
      - '.github/workflows/security-audit.yml'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    name: "ğŸ”’ Security & Dependency Audit"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: |
        echo "ğŸ” NPM ë³´ì•ˆ ê°ì‚¬ ì‹¤í–‰..."
        npm audit --audit-level=low --json > audit-results.json || true
        
        # ì‹¬ê°ë„ë³„ ì·¨ì•½ì  ì¹´ìš´íŠ¸
        HIGH_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
        CRITICAL_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
        
        echo "ğŸ“Š ë³´ì•ˆ ê°ì‚¬ ê²°ê³¼:"
        echo "- Critical: $CRITICAL_VULNS"
        echo "- High: $HIGH_VULNS"
        
        # Critical ì·¨ì•½ì ì´ ìˆìœ¼ë©´ ì‹¤íŒ¨
        if [ "$CRITICAL_VULNS" -gt 0 ]; then
          echo "âŒ Critical ì·¨ì•½ì  ë°œê²¬! ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."
          exit 1
        fi
        
        # High ì·¨ì•½ì ì´ ìˆìœ¼ë©´ ê²½ê³ 
        if [ "$HIGH_VULNS" -gt 0 ]; then
          echo "âš ï¸  High ì·¨ì•½ì  ë°œê²¬. ìˆ˜ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤."
        fi
        
        echo "âœ… ë³´ì•ˆ ê°ì‚¬ ì™„ë£Œ"
        
    - name: Check for outdated dependencies
      run: |
        echo "ğŸ“¦ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ í™•ì¸..."
        npm outdated --json > outdated.json || true
        
        # ì£¼ìš” ì˜ì¡´ì„± ì²´í¬
        OUTDATED_COUNT=$(cat outdated.json | jq 'length')
        echo "ğŸ“Š ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€: $OUTDATED_COUNT"
        
        if [ "$OUTDATED_COUNT" -gt 0 ]; then
          echo "ğŸ“‹ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ë“¤:"
          cat outdated.json | jq -r 'keys[]'
        fi
        
    - name: License compliance check
      run: |
        echo "ğŸ“„ ë¼ì´ì„ ìŠ¤ ì»´í”Œë¼ì´ì–¸ìŠ¤ í™•ì¸..."
        npx license-checker --json > licenses.json
        
        # ë¬¸ì œê°€ ë  ìˆ˜ ìˆëŠ” ë¼ì´ì„ ìŠ¤ í™•ì¸
        PROBLEMATIC_LICENSES=$(cat licenses.json | jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|LGPL")) | .key')
        
        if [ -n "$PROBLEMATIC_LICENSES" ]; then
          echo "âš ï¸  ì£¼ì˜ê°€ í•„ìš”í•œ ë¼ì´ì„ ìŠ¤ë¥¼ ê°€ì§„ íŒ¨í‚¤ì§€:"
          echo "$PROBLEMATIC_LICENSES"
        else
          echo "âœ… ë¼ì´ì„ ìŠ¤ ì»´í”Œë¼ì´ì–¸ìŠ¤ í™•ì¸ ì™„ë£Œ"
        fi
        
    - name: Code quality analysis
      run: |
        echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ë¶„ì„..."
        
        # TypeScript íƒ€ì… ê²€ì‚¬
        npm run typecheck
        
        # ESLint ê²€ì‚¬
        npm run lint
        
        echo "âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ"
        
    - name: Bundle analysis
      run: |
        echo "ğŸ“¦ ë²ˆë“¤ í¬ê¸° ë¶„ì„..."
        npm run build:ts
        
        # ê° íŒŒì¼ í¬ê¸° ì²´í¬
        echo "ğŸ“Š ì£¼ìš” íŒŒì¼ í¬ê¸°:"
        ls -lh js/*.js | awk '{print "- " $9 ": " $5}'
        
        # ì´ JavaScript í¬ê¸° ê³„ì‚°
        TOTAL_SIZE=$(du -ch js/*.js | tail -1 | cut -f1)
        echo "ğŸ“Š ì´ JavaScript í¬ê¸°: $TOTAL_SIZE"
        
    - name: Performance budget check
      run: |
        echo "ğŸš€ ì„±ëŠ¥ ì˜ˆì‚° í™•ì¸..."
        
        # ê° íŒŒì¼ì˜ í¬ê¸° ì œí•œ ê²€ì‚¬
        check_file_size() {
          local file=$1
          local limit=$2
          local actual=$(stat -c%s "$file" 2>/dev/null || echo "0")
          
          if [ "$actual" -gt "$limit" ]; then
            echo "âŒ $file í¬ê¸° ì´ˆê³¼: ${actual}B (ì œí•œ: ${limit}B)"
            return 1
          else
            echo "âœ… $file í¬ê¸° ì ì ˆ: ${actual}B"
            return 0
          fi
        }
        
        # ì„±ëŠ¥ ì˜ˆì‚° í™•ì¸
        ALL_GOOD=true
        check_file_size "js/main.js" 51200 || ALL_GOOD=false  # 50KB
        check_file_size "js/manseryeok-api-client.js" 20480 || ALL_GOOD=false  # 20KB
        check_file_size "js/image-optimizer.js" 25600 || ALL_GOOD=false  # 25KB
        check_file_size "js/bundle-optimizer.js" 30720 || ALL_GOOD=false  # 30KB
        
        if [ "$ALL_GOOD" = true ]; then
          echo "âœ… ëª¨ë“  íŒŒì¼ì´ ì„±ëŠ¥ ì˜ˆì‚° ë‚´ì— ìˆìŠµë‹ˆë‹¤"
        else
          echo "âŒ ì¼ë¶€ íŒŒì¼ì´ ì„±ëŠ¥ ì˜ˆì‚°ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          exit 1
        fi

  # ë§Œì„¸ë ¥ ë°ì´í„° ë¬´ê²°ì„± ì²´í¬ (ë§¤ìš° ì¤‘ìš”!)
  manseryeok-integrity-check:
    runs-on: ubuntu-latest
    name: "ğŸ—“ï¸ ë§Œì„¸ë ¥ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Critical manseryeok data verification
      run: |
        echo "ğŸ” ë§Œì„¸ë ¥ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ì‹œì‘..."
        echo "âš ï¸  ì¤‘ìš”: ë§Œì„¸ë ¥ ì •í™•ì„±ì€ ì ˆëŒ€ íƒ€í˜‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
        
        # ë§Œì„¸ë ¥ ê´€ë ¨ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
        npm test -- tests/manseryeok.test.ts --run
        
        # ë§Œì„¸ë ¥ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì²´í¬
        if [ -f "js/manseryeok-database.js" ]; then
          echo "âœ… ë§Œì„¸ë ¥ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì¡´ì¬ í™•ì¸"
        else
          echo "âŒ ë§Œì„¸ë ¥ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… ë§Œì„¸ë ¥ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ì™„ë£Œ"
        
    - name: API endpoint validation
      run: |
        echo "ğŸŒ ë§Œì„¸ë ¥ API ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦..."
        
        # API ì—”ë“œí¬ì¸íŠ¸ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if grep -q "doha-kr-ap.vercel.app/api/manseryeok" js/manseryeok-api-client.js; then
          echo "âœ… API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • í™•ì¸"
        else
          echo "âŒ API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • ì˜¤ë¥˜!"
          exit 1
        fi
        
        echo "âœ… API ì„¤ì • ê²€ì¦ ì™„ë£Œ"

  # ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ê²€ì¦
  monitoring-validation:
    runs-on: ubuntu-latest
    name: "ğŸ“Š Monitoring System Validation"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build and validate monitoring system
      run: |
        echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ê²€ì¦..."
        npm run build:ts
        
        # ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ -f "js/monitoring-system.js" ]; then
          echo "âœ… ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ íŒŒì¼ ë¹Œë“œ í™•ì¸"
        else
          echo "âŒ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        # ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í•µì‹¬ ê¸°ëŠ¥ í™•ì¸
        if grep -q "MonitoringSystem" js/monitoring-system.js; then
          echo "âœ… ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í´ë˜ìŠ¤ ì¡´ì¬ í™•ì¸"
        else
          echo "âŒ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í´ë˜ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ê²€ì¦ ì™„ë£Œ"

  # ì „ì²´ ê²°ê³¼ ìš”ì•½
  summary:
    runs-on: ubuntu-latest
    name: "ğŸ“‹ Security Audit Summary"
    needs: [security-audit, manseryeok-integrity-check, monitoring-validation]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "ğŸ“‹ ë³´ì•ˆ ê°ì‚¬ ë° ë¬´ê²°ì„± ê²€ì¦ ìš”ì•½"
        echo "================================"
        echo ""
        
        if [ "${{ needs.security-audit.result }}" = "success" ]; then
          echo "âœ… ë³´ì•ˆ ê°ì‚¬: í†µê³¼"
        else
          echo "âŒ ë³´ì•ˆ ê°ì‚¬: ì‹¤íŒ¨"
        fi
        
        if [ "${{ needs.manseryeok-integrity-check.result }}" = "success" ]; then
          echo "âœ… ë§Œì„¸ë ¥ ë¬´ê²°ì„±: í†µê³¼"
        else
          echo "âŒ ë§Œì„¸ë ¥ ë¬´ê²°ì„±: ì‹¤íŒ¨"
        fi
        
        if [ "${{ needs.monitoring-validation.result }}" = "success" ]; then
          echo "âœ… ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ: í†µê³¼"
        else
          echo "âŒ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ: ì‹¤íŒ¨"
        fi
        
        echo ""
        echo "ğŸ—“ï¸  ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„± ë³´ì¥ì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤!"
        echo "ğŸ”’ ì •ê¸°ì ì¸ ë³´ì•ˆ ì ê²€ì„ í†µí•´ ì‹œìŠ¤í…œ ì•ˆì „ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤."