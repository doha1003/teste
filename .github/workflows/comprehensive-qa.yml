name: Comprehensive QA Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Daily QA run at 2 AM KST
    - cron: '0 17 * * *'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ë° ì •ì  ë¶„ì„
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality & Static Analysis
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        npm run playwright:install --with-deps

    - name: Code formatting check
      run: |
        npm run format:check
        echo "ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ ì™„ë£Œ"

    - name: ESLint analysis
      run: |
        npm run lint 2>&1 | tee eslint-report.txt
        echo "ESLint ë¶„ì„ ì™„ë£Œ"

    - name: CSS validation
      run: |
        npm run validate:css 2>&1 | tee css-validation.txt
        echo "CSS ìœ íš¨ì„± ê²€ì‚¬ ì™„ë£Œ"

    - name: HTML validation
      run: |
        npm run validate:html 2>&1 | tee html-validation.txt || true
        echo "HTML ìœ íš¨ì„± ê²€ì‚¬ ì™„ë£Œ"

    - name: Security audit
      run: |
        npm audit --audit-level high 2>&1 | tee security-audit.txt || true
        echo "ë³´ì•ˆ ê°ì‚¬ ì™„ë£Œ"

    - name: Upload code quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          eslint-report.txt
          css-validation.txt
          html-validation.txt
          security-audit.txt
        retention-days: 30

  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° í†µí•© í…ŒìŠ¤íŠ¸
  unit-integration-tests:
    runs-on: ubuntu-latest
    name: Unit & Integration Tests
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: |
        npm run build
        npm run update:html

    - name: Run unit tests
      run: |
        npm run test:unit -- --reporter=verbose --coverage
        echo "ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

    - name: Run integration tests
      run: |
        npm run test:integration -- --reporter=verbose
        echo "í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

    - name: Upload test coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-integration-results
        path: |
          coverage/
          test-results/
        retention-days: 30

  # E2E í…ŒìŠ¤íŠ¸ (í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì €)
  e2e-tests:
    runs-on: ubuntu-latest
    name: E2E Tests (Cross-Browser)
    needs: unit-integration-tests
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit, mobile-chrome]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        npm run playwright:install --with-deps

    - name: Build project
      run: |
        npm run build
        npm run update:html

    - name: Start local server
      run: |
        npm run serve &
        sleep 10
      env:
        CI: true

    - name: Wait for server
      run: |
        npx wait-on http://localhost:3000 --timeout 60000

    - name: Run E2E tests
      run: |
        npx playwright test --project=${{ matrix.browser }} --reporter=html
        echo "${{ matrix.browser }} E2E í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      env:
        PLAYWRIGHT_HTML_REPORT: playwright-report-${{ matrix.browser }}

    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-results-${{ matrix.browser }}
        path: |
          playwright-report-${{ matrix.browser }}/
          test-results/
        retention-days: 30

  # ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
  accessibility-tests:
    runs-on: ubuntu-latest
    name: Accessibility Tests (WCAG 2.1)
    needs: unit-integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        npm run playwright:install --with-deps

    - name: Build project
      run: |
        npm run build
        npm run update:html

    - name: Start local server
      run: |
        npm run serve &
        sleep 10

    - name: Run accessibility tests
      run: |
        npx playwright test --project=chromium tests/accessibility/ --reporter=html
        echo "ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      env:
        PLAYWRIGHT_HTML_REPORT: accessibility-report

    - name: Upload accessibility results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-results
        path: |
          accessibility-report/
          test-results/
        retention-days: 30

  # ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  security-tests:
    runs-on: ubuntu-latest
    name: Security Vulnerability Tests
    needs: unit-integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        npm run playwright:install --with-deps

    - name: Build project
      run: |
        npm run build
        npm run update:html

    - name: Start local server
      run: |
        npm run serve &
        sleep 10

    - name: Run security tests
      run: |
        npx playwright test --project=chromium tests/security/ --reporter=html
        echo "ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      env:
        PLAYWRIGHT_HTML_REPORT: security-report

    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:3000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
      continue-on-error: true

    - name: Upload security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-results
        path: |
          security-report/
          report_html.html
          report_md.md
          test-results/
        retention-days: 30

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-tests:
    runs-on: ubuntu-latest
    name: Performance Tests (Lighthouse CI)
    needs: unit-integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        npm run playwright:install --with-deps

    - name: Build project
      run: |
        npm run build
        npm run update:html

    - name: Start local server
      run: |
        npm run serve &
        sleep 10

    - name: Wait for server
      run: |
        npx wait-on http://localhost:3000 --timeout 60000

    - name: Run Lighthouse CI (Desktop)
      run: |
        npm install -g @lhci/cli@0.13.x
        lhci autorun
        echo "ë°ìŠ¤í¬í†± Lighthouse í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}

    - name: Run Lighthouse CI (Mobile)
      run: |
        lhci autorun --config=./lighthouserc-mobile.js
        echo "ëª¨ë°”ì¼ Lighthouse í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}

    - name: Run custom performance tests
      run: |
        npx playwright test --project=performance tests/performance/ --reporter=html
        echo "ì»¤ìŠ¤í…€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      env:
        PLAYWRIGHT_HTML_REPORT: performance-report

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          .lighthouseci/
          performance-report/
          test-results/
        retention-days: 30

  # í•œêµ­ì–´ íŠ¹í™” í…ŒìŠ¤íŠ¸
  korean-localization-tests:
    runs-on: ubuntu-latest
    name: Korean Localization Tests
    needs: unit-integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Korean fonts
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra

    - name: Install dependencies
      run: |
        npm ci
        npm run playwright:install --with-deps

    - name: Build project
      run: |
        npm run build
        npm run update:html

    - name: Start local server
      run: |
        npm run serve &
        sleep 10

    - name: Set Korean locale
      run: |
        sudo locale-gen ko_KR.UTF-8
        export LANG=ko_KR.UTF-8
        export LC_ALL=ko_KR.UTF-8

    - name: Run Korean localization tests
      run: |
        npx playwright test --project=localization tests/localization/ --reporter=html
        echo "í•œêµ­ì–´ íŠ¹í™” í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
      env:
        LANG: ko_KR.UTF-8
        LC_ALL: ko_KR.UTF-8
        TZ: Asia/Seoul
        PLAYWRIGHT_HTML_REPORT: korean-localization-report

    - name: Upload localization results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: korean-localization-results
        path: |
          korean-localization-report/
          test-results/
        retention-days: 30

  # ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
  generate-qa-report:
    runs-on: ubuntu-latest
    name: Generate QA Report
    needs: [
      code-quality,
      unit-integration-tests,
      e2e-tests,
      accessibility-tests,
      security-tests,
      performance-tests,
      korean-localization-tests
    ]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./qa-artifacts

    - name: Generate comprehensive QA report
      run: |
        mkdir -p qa-report
        node scripts/generate-qa-report.js
        echo "ì¢…í•© QA ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"

    - name: Upload QA report
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-qa-report
        path: |
          qa-report/
          qa-artifacts/
        retention-days: 90

    - name: Comment PR with QA summary
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const path = './qa-report/summary.md';
          
          if (fs.existsSync(path)) {
            const summary = fs.readFileSync(path, 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ” í’ˆì§ˆ ê²€ì¦ ê²°ê³¼\n\n${summary}\n\nðŸ¤– ìžë™í™”ëœ QA íŒŒì´í”„ë¼ì¸ì— ì˜í•´ ìƒì„±ë¨`
            });
          }

  # ë°°í¬ ì „ ìµœì¢… ê²€ì¦ (main ë¸Œëžœì¹˜ë§Œ)
  deployment-readiness:
    runs-on: ubuntu-latest
    name: Deployment Readiness Check
    needs: generate-qa-report
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Download QA report
      uses: actions/download-artifact@v4
      with:
        name: comprehensive-qa-report
        path: ./qa-results

    - name: Check deployment criteria
      run: |
        node scripts/check-deployment-readiness.js
        echo "ë°°í¬ ì¤€ë¹„ ìƒíƒœ í™•ì¸ ì™„ë£Œ"

    - name: Create deployment summary
      run: |
        echo "# ðŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… ëª¨ë“  í’ˆì§ˆ ê²€ì¦ ë‹¨ê³„ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ê²€ì¦ ì™„ë£Œ í•­ëª©" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ì½”ë“œ í’ˆì§ˆ ë° ì •ì  ë¶„ì„" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë° í†µí•© í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… E2E í…ŒìŠ¤íŠ¸ (í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì €)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ (WCAG 2.1)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (Lighthouse)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… í•œêµ­ì–´ íŠ¹í™” í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **doha.kr**ì´ í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY