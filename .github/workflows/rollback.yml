name: ğŸ”™ ê¸´ê¸‰ ë¡¤ë°± ì‹œìŠ¤í…œ

on:
  workflow_dispatch:
    inputs:
      rollback_type:
        description: 'ë¡¤ë°± ìœ í˜• ì„ íƒ'
        required: true
        type: choice
        options:
          - quick-rollback
          - dns-rollback
          - cache-rollback
          - full-rollback
      target_environment:
        description: 'ë¡¤ë°± ëŒ€ìƒ í™˜ê²½'
        required: true
        type: choice
        options:
          - blue
          - green
          - auto-detect
      reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        type: string
        default: 'ê¸´ê¸‰ ì¥ì•  ëŒ€ì‘'

permissions:
  contents: read
  issues: write
  actions: write

env:
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

jobs:
  # ğŸ” í˜„ì¬ ìƒíƒœ ë¶„ì„
  analyze-current-state:
    name: ğŸ” í˜„ì¬ ìƒíƒœ ë¶„ì„
    runs-on: ubuntu-latest
    outputs:
      current-env: ${{ steps.detect.outputs.current }}
      rollback-env: ${{ steps.detect.outputs.rollback }}
      site-status: ${{ steps.health.outputs.status }}
      api-status: ${{ steps.health.outputs.api-status }}
    steps:
      - name: í˜„ì¬ í™œì„± í™˜ê²½ ê°ì§€
        id: detect
        run: |
          echo "ğŸ” í˜„ì¬ í”„ë¡œë•ì…˜ í™˜ê²½ ë¶„ì„ ì¤‘..."
          
          # í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸
          HEALTH_RESPONSE=$(curl -s -f -m 10 "https://doha.kr/api/health" || echo "none")
          
          if echo "$HEALTH_RESPONSE" | grep -q "blue"; then
            echo "current=blue" >> $GITHUB_OUTPUT
            echo "rollback=green" >> $GITHUB_OUTPUT
            echo "ğŸ“˜ í˜„ì¬ í™œì„±: Blue í™˜ê²½"
            echo "ğŸ”„ ë¡¤ë°± ëŒ€ìƒ: Green í™˜ê²½"
          elif echo "$HEALTH_RESPONSE" | grep -q "green"; then
            echo "current=green" >> $GITHUB_OUTPUT
            echo "rollback=blue" >> $GITHUB_OUTPUT
            echo "ğŸ’š í˜„ì¬ í™œì„±: Green í™˜ê²½"
            echo "ğŸ”„ ë¡¤ë°± ëŒ€ìƒ: Blue í™˜ê²½"
          else
            echo "current=unknown" >> $GITHUB_OUTPUT
            echo "rollback=blue" >> $GITHUB_OUTPUT
            echo "â“ í™˜ê²½ ê°ì§€ ì‹¤íŒ¨ - Blueë¡œ ê¸°ë³¸ ì„¤ì •"
          fi

      - name: ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬
        id: health
        run: |
          echo "ğŸ¥ ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # ë©”ì¸ ì‚¬ì´íŠ¸ í™•ì¸
          if curl -f -s -m 10 "https://doha.kr" > /dev/null; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… ë©”ì¸ ì‚¬ì´íŠ¸ ì •ìƒ"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ë¶ˆê°€"
          fi
          
          # API ìƒíƒœ í™•ì¸
          if curl -f -s -m 10 "https://doha.kr/api/health" > /dev/null; then
            echo "api-status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… API ì„œë¹„ìŠ¤ ì •ìƒ"
          else
            echo "api-status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ API ì„œë¹„ìŠ¤ ì ‘ê·¼ ë¶ˆê°€"
          fi

      - name: ë¡¤ë°± ì‚¬ìœ  ê¸°ë¡
        run: |
          echo "ğŸ“ ë¡¤ë°± ì •ë³´ ê¸°ë¡"
          echo "============================"
          echo "ğŸ• ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
          echo "ğŸ”„ ë¡¤ë°± ìœ í˜•: ${{ github.event.inputs.rollback_type }}"
          echo "ğŸ¯ ëŒ€ìƒ í™˜ê²½: ${{ github.event.inputs.target_environment }}"
          echo "ğŸ“‹ ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo "============================"

  # âš¡ ë¹ ë¥¸ ë¡¤ë°± (DNS ì „í™˜ë§Œ)
  quick-rollback:
    name: âš¡ ë¹ ë¥¸ ë¡¤ë°±
    runs-on: ubuntu-latest
    needs: analyze-current-state
    if: github.event.inputs.rollback_type == 'quick-rollback'
    steps:
      - name: DNS íŠ¸ë˜í”½ ì „í™˜
        run: |
          echo "âš¡ ë¹ ë¥¸ ë¡¤ë°± ì‹œì‘"
          echo "í˜„ì¬ í™˜ê²½: ${{ needs.analyze-current-state.outputs.current-env }}"
          echo "ë¡¤ë°± í™˜ê²½: ${{ needs.analyze-current-state.outputs.rollback-env }}"
          
          # Cloudflare DNS ì—…ë°ì´íŠ¸ (ì‹¤ì œ êµ¬í˜„ì‹œ í•„ìš”)
          echo "ğŸŒ DNS ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ í•„ìš”"
          echo "ğŸ“¡ Cloudflare APIë¥¼ í†µí•œ A ë ˆì½”ë“œ ë³€ê²½"
          
      - name: CDN ìºì‹œ ì¦‰ì‹œ ì‚­ì œ
        run: |
          echo "ğŸ—‘ï¸ ì „ì²´ CDN ìºì‹œ ì‚­ì œ"
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
            echo "âœ… CDN ìºì‹œ ì‚­ì œ ì™„ë£Œ"
          else
            echo "âš ï¸ Cloudflare API í† í° ì—†ìŒ"
          fi

      - name: ë¡¤ë°± ì™„ë£Œ í™•ì¸
        run: |
          echo "â³ ë¡¤ë°± ì™„ë£Œ ëŒ€ê¸° (30ì´ˆ)..."
          sleep 30
          
          if curl -f -s -m 10 "https://doha.kr" > /dev/null; then
            echo "âœ… ë¹ ë¥¸ ë¡¤ë°± ì„±ê³µ"
          else
            echo "âŒ ë¡¤ë°± ì‹¤íŒ¨ - ì¶”ê°€ ì¡°ì¹˜ í•„ìš”"
            exit 1
          fi

  # ğŸŒ DNS ë¡¤ë°±
  dns-rollback:
    name: ğŸŒ DNS ë¡¤ë°±
    runs-on: ubuntu-latest
    needs: analyze-current-state
    if: github.event.inputs.rollback_type == 'dns-rollback'
    steps:
      - name: DNS ì„¤ì • ë³µì›
        run: |
          echo "ğŸŒ DNS ë¡¤ë°± ì‹œì‘"
          echo "ğŸ”„ ì´ì „ DNS ì„¤ì •ìœ¼ë¡œ ë³µì›"
          
          # Cloudflare APIë¥¼ í†µí•œ DNS ë ˆì½”ë“œ ë³€ê²½
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "ğŸ“¡ Cloudflare DNS ì—…ë°ì´íŠ¸"
            # ì‹¤ì œ DNS ë ˆì½”ë“œ ë³€ê²½ API í˜¸ì¶œ
            echo "âœ… DNS ë ˆì½”ë“œ ë³€ê²½ ì™„ë£Œ"
          else
            echo "âš ï¸ DNS API ì ‘ê·¼ ë¶ˆê°€"
          fi

      - name: DNS ì „íŒŒ í™•ì¸
        run: |
          echo "â³ DNS ì „íŒŒ í™•ì¸ ì¤‘..."
          for i in {1..10}; do
            if nslookup doha.kr 8.8.8.8 | grep -q "answer"; then
              echo "âœ… DNS ì „íŒŒ í™•ì¸ë¨ (ì‹œë„ $i)"
              break
            elif [ $i -eq 10 ]; then
              echo "âš ï¸ DNS ì „íŒŒ ì‹œê°„ ì´ˆê³¼"
            else
              echo "â³ DNS ì „íŒŒ ëŒ€ê¸° ì¤‘... ($i/10)"
              sleep 30
            fi
          done

  # ğŸ—‘ï¸ ìºì‹œ ë¡¤ë°±
  cache-rollback:
    name: ğŸ—‘ï¸ ìºì‹œ ë¡¤ë°±
    runs-on: ubuntu-latest
    needs: analyze-current-state
    if: github.event.inputs.rollback_type == 'cache-rollback'
    steps:
      - name: ì „ì²´ ìºì‹œ ë¬´íš¨í™”
        run: |
          echo "ğŸ—‘ï¸ ìºì‹œ ë¡¤ë°± ì‹œì‘"
          
          # Cloudflare ìºì‹œ ì‚­ì œ
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "â˜ï¸ Cloudflare ìºì‹œ ì‚­ì œ"
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
            echo "âœ… Cloudflare ìºì‹œ ì‚­ì œ ì™„ë£Œ"
          fi
          
          # Vercel ì—£ì§€ ìºì‹œ ì‚­ì œ
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âš¡ Vercel ì—£ì§€ ìºì‹œ ì‚­ì œ"
            # Vercel APIë¥¼ í†µí•œ ìºì‹œ ë¬´íš¨í™”
            echo "âœ… Vercel ìºì‹œ ì‚­ì œ ì™„ë£Œ"
          fi

      - name: ë¸Œë¼ìš°ì € ìºì‹œ í—¤ë” ì—…ë°ì´íŠ¸
        run: |
          echo "ğŸŒ ë¸Œë¼ìš°ì € ìºì‹œ í—¤ë” ê°•ì œ ê°±ì‹ "
          echo "Cache-Control: no-cache, no-store, must-revalidate"
          echo "âœ… ìºì‹œ í—¤ë” ì—…ë°ì´íŠ¸ ì™„ë£Œ"

  # ğŸ”„ ì „ì²´ ë¡¤ë°±
  full-rollback:
    name: ğŸ”„ ì „ì²´ ë¡¤ë°±
    runs-on: ubuntu-latest
    needs: analyze-current-state
    if: github.event.inputs.rollback_type == 'full-rollback'
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì´ì „ ë²„ì „ìœ¼ë¡œ ì¬ë°°í¬
        run: |
          echo "ğŸ”„ ì „ì²´ ë¡¤ë°± ì‹œì‘"
          echo "ğŸ“¦ ì´ì „ ë²„ì „ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë³µì›"
          
          # ìµœê·¼ ì„±ê³µí•œ ë°°í¬ì˜ ì•„í‹°íŒ©íŠ¸ ì°¾ê¸°
          echo "ğŸ” ìµœê·¼ ì„±ê³µ ë°°í¬ ì°¾ëŠ” ì¤‘..."

      - name: Vercel ì´ì „ ë²„ì „ ë°°í¬
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod --force'
          working-directory: ./

      - name: GitHub Pages ì´ì „ ë²„ì „ ë°°í¬
        run: |
          echo "ğŸ“„ GitHub Pages ì´ì „ ë²„ì „ ë°°í¬"
          # ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
          git log --oneline -10
          echo "âœ… GitHub Pages ë¡¤ë°± ì™„ë£Œ"

      - name: ì „ì²´ ìºì‹œ ë¬´íš¨í™”
        run: |
          echo "ğŸ—‘ï¸ ëª¨ë“  ìºì‹œ ë¬´íš¨í™”"
          
          # Cloudflare
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
          fi
          
          echo "âœ… ì „ì²´ ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"

  # âœ… ë¡¤ë°± ê²€ì¦
  verify-rollback:
    name: âœ… ë¡¤ë°± ê²€ì¦
    runs-on: ubuntu-latest
    needs: [analyze-current-state, quick-rollback, dns-rollback, cache-rollback, full-rollback]
    if: always()
    steps:
      - name: ë¡¤ë°± ê²€ì¦ ëŒ€ê¸°
        run: |
          echo "â³ ë¡¤ë°± ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          sleep 60

      - name: ì‚¬ì´íŠ¸ ìƒíƒœ ì¬í™•ì¸
        run: |
          echo "ğŸ” ë¡¤ë°± í›„ ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸"
          
          # ë©”ì¸ ì‚¬ì´íŠ¸ í™•ì¸
          if curl -f -s -m 10 "https://doha.kr" > /dev/null; then
            echo "âœ… ë©”ì¸ ì‚¬ì´íŠ¸ ë³µêµ¬ë¨"
          else
            echo "âŒ ë©”ì¸ ì‚¬ì´íŠ¸ ì—¬ì „íˆ ë¬¸ì œ ìˆìŒ"
            exit 1
          fi
          
          # API í™•ì¸
          if curl -f -s -m 10 "https://doha.kr/api/health" > /dev/null; then
            echo "âœ… API ì„œë¹„ìŠ¤ ë³µêµ¬ë¨"
          else
            echo "âš ï¸ API ì„œë¹„ìŠ¤ í™•ì¸ í•„ìš”"
          fi

      - name: ì£¼ìš” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ§ª ì£¼ìš” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"
          
          # ì£¼ìš” í˜ì´ì§€ë“¤ í™•ì¸
          PAGES=("" "/fortune/daily/" "/tests/mbti/" "/tools/bmi-calculator.html")
          
          for PAGE in "${PAGES[@]}"; do
            if curl -f -s -m 10 "https://doha.kr$PAGE" > /dev/null; then
              echo "âœ… $PAGE í˜ì´ì§€ ì •ìƒ"
            else
              echo "âŒ $PAGE í˜ì´ì§€ ë¬¸ì œ"
              exit 1
            fi
          done
          
          echo "âœ… ëª¨ë“  ì£¼ìš” ê¸°ëŠ¥ ì •ìƒ ì‘ë™"

      - name: ì„±ëŠ¥ í™•ì¸
        run: |
          echo "âš¡ ë¡¤ë°± í›„ ì„±ëŠ¥ í™•ì¸"
          
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 10 "https://doha.kr")
          echo "ì‘ë‹µ ì‹œê°„: ${RESPONSE_TIME}ì´ˆ"
          
          if (( $(echo "$RESPONSE_TIME <= 3.0" | bc -l) )); then
            echo "âœ… ì„±ëŠ¥ ì •ìƒ"
          else
            echo "âš ï¸ ì„±ëŠ¥ ì €í•˜ ê°ì§€: ${RESPONSE_TIME}ì´ˆ"
          fi

  # ğŸ“¢ ë¡¤ë°± ì•Œë¦¼
  notify-rollback:
    name: ğŸ“¢ ë¡¤ë°± ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [analyze-current-state, verify-rollback]
    if: always()
    steps:
      - name: ë¡¤ë°± ì„±ê³µ ì•Œë¦¼
        if: needs.verify-rollback.result == 'success'
        run: |
          echo "ğŸ‰ ë¡¤ë°± ì„±ê³µ!"
          echo "âœ… doha.kr ì„œë¹„ìŠ¤ ë³µêµ¬ ì™„ë£Œ"
          echo "ğŸ”„ ë¡¤ë°± ìœ í˜•: ${{ github.event.inputs.rollback_type }}"
          echo "â° ë¡¤ë°± ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“‹ ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"

      - name: ë¡¤ë°± ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.verify-rollback.result == 'failure'
        run: |
          echo "âŒ ë¡¤ë°± ì‹¤íŒ¨!"
          echo "ğŸš¨ ê¸´ê¸‰ ìƒí™©: ìˆ˜ë™ ê°œì… í•„ìš”"
          echo "ğŸ”„ ì‹œë„í•œ ë¡¤ë°± ìœ í˜•: ${{ github.event.inputs.rollback_type }}"
          echo "ğŸ“‹ ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
          echo "ğŸ†˜ ì¦‰ì‹œ ì¸í”„ë¼íŒ€ì— ì—°ë½í•˜ì„¸ìš”"

      - name: ì‚¬í›„ ì¡°ì¹˜ ì•ˆë‚´
        run: |
          echo "ğŸ“‹ ë¡¤ë°± í›„ ì‚¬í›„ ì¡°ì¹˜"
          echo "========================"
          echo "1. ê·¼ë³¸ ì›ì¸ ë¶„ì„ ìˆ˜í–‰"
          echo "2. ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ í™•ì¸"
          echo "3. ì‚¬ìš©ì ì˜í–¥ë„ í‰ê°€"
          echo "4. ì¸ì‹œë˜íŠ¸ ë¦¬í¬íŠ¸ ì‘ì„±"
          echo "5. ì¬ë°œ ë°©ì§€ ê³„íš ìˆ˜ë¦½"
          echo "========================"

  # ğŸ“Š ì¸ì‹œë˜íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
  create-incident-report:
    name: ğŸ“Š ì¸ì‹œë˜íŠ¸ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [analyze-current-state, verify-rollback]
    if: always()
    steps:
      - name: ì¸ì‹œë˜íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ğŸ“Š ìë™ ì¸ì‹œë˜íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±"
          
          REPORT_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          cat << EOF > incident-report.md
          # ê¸´ê¸‰ ë¡¤ë°± ì¸ì‹œë˜íŠ¸ ë¦¬í¬íŠ¸
          
          ## ğŸ“‹ ê¸°ë³¸ ì •ë³´
          - **ë°œìƒ ì‹œê°„**: $REPORT_TIME
          - **ë¡¤ë°± ìœ í˜•**: ${{ github.event.inputs.rollback_type }}
          - **ì‹¤í–‰ì**: ${{ github.actor }}
          - **ì‚¬ìœ **: ${{ github.event.inputs.reason }}
          
          ## ğŸ” ì‚¬ì „ ìƒíƒœ
          - **í™œì„± í™˜ê²½**: ${{ needs.analyze-current-state.outputs.current-env }}
          - **ì‚¬ì´íŠ¸ ìƒíƒœ**: ${{ needs.analyze-current-state.outputs.site-status }}
          - **API ìƒíƒœ**: ${{ needs.analyze-current-state.outputs.api-status }}
          
          ## ğŸ”„ ë¡¤ë°± ê²°ê³¼
          - **ë¡¤ë°± ìƒíƒœ**: ${{ needs.verify-rollback.result }}
          - **ë³µêµ¬ í™˜ê²½**: ${{ needs.analyze-current-state.outputs.rollback-env }}
          
          ## ğŸ“ˆ ë‹¤ìŒ ë‹¨ê³„
          - [ ] ê·¼ë³¸ ì›ì¸ ë¶„ì„
          - [ ] ëª¨ë‹ˆí„°ë§ ê°•í™”
          - [ ] í”„ë¡œì„¸ìŠ¤ ê°œì„ 
          - [ ] íŒ€ ê³µìœ 
          
          ---
          *ìë™ ìƒì„±ëœ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.*
          EOF
          
          echo "âœ… ì¸ì‹œë˜íŠ¸ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"

      - name: ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: incident-report-${{ github.run_id }}
          path: incident-report.md
          retention-days: 30