name: ğŸ“Š Vercel ë°°í¬ ëª¨ë‹ˆí„°ë§

on:
  schedule:
    # ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (í”„ë¡œë•ì…˜ í™˜ê²½ ëª¨ë‹ˆí„°ë§)
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'ê°•ì œ ì „ì²´ ê²€ì‚¬ ìˆ˜í–‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

env:
  MONITORING_TIMEOUT: 30

jobs:
  # 1ï¸âƒ£ ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬
  health-monitoring:
    name: ğŸ¥ ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬
    runs-on: ubuntu-latest
    outputs:
      site-status: ${{ steps.health.outputs.status }}
      api-status: ${{ steps.api.outputs.status }}
      performance-status: ${{ steps.performance.outputs.status }}
    steps:
      - name: ë©”ì¸ ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬
        id: health
        run: |
          echo "ğŸŒ doha.kr ë©”ì¸ ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸..."
          
          # ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼ í™•ì¸ (3íšŒ ì¬ì‹œë„)
          for i in {1..3}; do
            if curl -f -L -m ${{ env.MONITORING_TIMEOUT }} -s https://doha.kr -o /dev/null; then
              echo "status=healthy" >> $GITHUB_OUTPUT
              echo "âœ… ë©”ì¸ ì‚¬ì´íŠ¸ ì •ìƒ (ì‹œë„ $i)"
              break
            elif [ $i -eq 3 ]; then
              echo "status=unhealthy" >> $GITHUB_OUTPUT
              echo "âŒ ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ë¶ˆê°€ (3íšŒ ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨)"
            else
              echo "âš ï¸ ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ì‹¤íŒ¨ (ì‹œë„ $i/3), 10ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 10
            fi
          done

      - name: API ì—”ë“œí¬ì¸íŠ¸ í—¬ìŠ¤ì²´í¬
        id: api
        run: |
          echo "ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸ ìƒíƒœ í™•ì¸..."
          
          # Health API í™•ì¸
          if curl -f -L -m 15 -s https://doha.kr/api/health -o /dev/null; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Health API ì •ìƒ"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Health API ì ‘ê·¼ ë¶ˆê°€"
          fi
          
          # Fortune API ê°„ë‹¨ í…ŒìŠ¤íŠ¸
          FORTUNE_TEST=$(curl -s -X POST https://doha.kr/api/fortune \
            -H "Content-Type: application/json" \
            -d '{"type":"daily","userData":{"name":"ëª¨ë‹ˆí„°ë§","birthDate":"1990-01-01","gender":"male"}}' \
            -m 25 | jq -r '.success' 2>/dev/null || echo "false")
          
          if [ "$FORTUNE_TEST" = "true" ]; then
            echo "âœ… Fortune API ì •ìƒ"
          else
            echo "âš ï¸ Fortune API ì‘ë‹µ ì´ìƒ: $FORTUNE_TEST"
          fi

      - name: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
        id: performance
        run: |
          echo "âš¡ ì‚¬ì´íŠ¸ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§..."
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m ${{ env.MONITORING_TIMEOUT }} https://doha.kr)
          echo "ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì‹œê°„: ${RESPONSE_TIME}ì´ˆ"
          
          # API ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          API_RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 15 https://doha.kr/api/health)
          echo "API ì‘ë‹µ ì‹œê°„: ${API_RESPONSE_TIME}ì´ˆ"
          
          # ì„±ëŠ¥ ì„ê³„ê°’ í™•ì¸ (ë©”ì¸: 5ì´ˆ, API: 3ì´ˆ)
          if (( $(echo "$RESPONSE_TIME > 5.0" | bc -l) )) || (( $(echo "$API_RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "status=degraded" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì„±ëŠ¥ ì €í•˜ ê°ì§€"
          else
            echo "status=good" >> $GITHUB_OUTPUT
            echo "âœ… ì„±ëŠ¥ ìƒíƒœ ì–‘í˜¸"
          fi

  # 2ï¸âƒ£ Vercel ë°°í¬ ìƒíƒœ í™•ì¸
  vercel-status:
    name: âš¡ Vercel ë°°í¬ ìƒíƒœ
    runs-on: ubuntu-latest
    needs: health-monitoring
    if: github.event.inputs.force_check == 'true' || needs.health-monitoring.outputs.site-status == 'unhealthy'
    steps:
      - name: ìµœê·¼ ë°°í¬ ìƒíƒœ í™•ì¸
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ğŸ“‹ Vercel ìµœê·¼ ë°°í¬ ìƒíƒœ í™•ì¸..."
          
          if [ -n "$VERCEL_TOKEN" ]; then
            # Vercel APIë¥¼ í†µí•œ ë°°í¬ ìƒíƒœ í™•ì¸
            DEPLOYMENTS=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
              "https://api.vercel.com/v6/deployments?projectId=${{ secrets.PROJECT_ID }}&limit=5")
            
            echo "ìµœê·¼ 5ê°œ ë°°í¬ ìƒíƒœ:"
            echo "$DEPLOYMENTS" | jq -r '.deployments[] | "\(.created | strftime("%Y-%m-%d %H:%M:%S")) - \(.state) - \(.url)"' 2>/dev/null || echo "ë°°í¬ ì •ë³´ íŒŒì‹± ì‹¤íŒ¨"
          else
            echo "âš ï¸ VERCEL_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ Vercel API í™•ì¸ ë¶ˆê°€"
          fi

  # 3ï¸âƒ£ í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
  critical-functions-test:
    name: ğŸ§ª í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: health-monitoring
    if: github.event.inputs.force_check == 'true' || needs.health-monitoring.outputs.api-status == 'unhealthy'
    steps:
      - name: ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ í™•ì¸
        run: |
          echo "ğŸ§  ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì ‘ê·¼ í™•ì¸..."
          
          # ì£¼ìš” í…ŒìŠ¤íŠ¸ í˜ì´ì§€ë“¤ í™•ì¸
          TEST_PAGES=("/tests/mbti/" "/tests/love-dna/" "/tests/teto-egen/")
          
          for page in "${TEST_PAGES[@]}"; do
            if curl -f -L -m 20 -s "https://doha.kr$page" -o /dev/null; then
              echo "âœ… $page ì •ìƒ"
            else
              echo "âŒ $page ì ‘ê·¼ ì‹¤íŒ¨"
            fi
          done

      - name: ìš´ì„¸ ì„œë¹„ìŠ¤ í™•ì¸
        run: |
          echo "ğŸ”® ìš´ì„¸ ì„œë¹„ìŠ¤ í˜ì´ì§€ ì ‘ê·¼ í™•ì¸..."
          
          # ìš´ì„¸ í˜ì´ì§€ë“¤ í™•ì¸
          FORTUNE_PAGES=("/fortune/daily/" "/fortune/saju/" "/fortune/tarot/")
          
          for page in "${FORTUNE_PAGES[@]}"; do
            if curl -f -L -m 20 -s "https://doha.kr$page" -o /dev/null; then
              echo "âœ… $page ì •ìƒ"
            else
              echo "âŒ $page ì ‘ê·¼ ì‹¤íŒ¨"
            fi
          done

      - name: ë„êµ¬ ì„œë¹„ìŠ¤ í™•ì¸
        run: |
          echo "ğŸ› ï¸ ë„êµ¬ ì„œë¹„ìŠ¤ í˜ì´ì§€ ì ‘ê·¼ í™•ì¸..."
          
          # ë„êµ¬ í˜ì´ì§€ë“¤ í™•ì¸
          TOOL_PAGES=("/tools/bmi-calculator.html" "/tools/salary-calculator.html" "/tools/text-counter.html")
          
          for page in "${TOOL_PAGES[@]}"; do
            if curl -f -L -m 20 -s "https://doha.kr$page" -o /dev/null; then
              echo "âœ… $page ì •ìƒ"
            else
              echo "âŒ $page ì ‘ê·¼ ì‹¤íŒ¨"
            fi
          done

  # 4ï¸âƒ£ ë¬¸ì œ ê°ì§€ì‹œ ì•Œë¦¼
  alert-on-issues:
    name: ğŸš¨ ë¬¸ì œ ê°ì§€ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [health-monitoring, critical-functions-test]
    if: |
      always() && (
        needs.health-monitoring.outputs.site-status == 'unhealthy' ||
        needs.health-monitoring.outputs.api-status == 'unhealthy' ||
        needs.critical-functions-test.result == 'failure'
      )
    steps:
      - name: ë¬¸ì œ ìƒí™© ì•Œë¦¼
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "ğŸš¨ doha.kr ë¬¸ì œ ìƒí™© ê°ì§€"
          
          # ë¬¸ì œ ìƒí™© ë¶„ì„
          ISSUES=""
          if [ "${{ needs.health-monitoring.outputs.site-status }}" = "unhealthy" ]; then
            ISSUES="$ISSUES\nâ€¢ ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ë¶ˆê°€"
          fi
          if [ "${{ needs.health-monitoring.outputs.api-status }}" = "unhealthy" ]; then
            ISSUES="$ISSUES\nâ€¢ API ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ë¶ˆê°€"
          fi
          if [ "${{ needs.critical-functions-test.result }}" = "failure" ]; then
            ISSUES="$ISSUES\nâ€¢ í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          fi
          
          ALERT_MESSAGE="ğŸš¨ doha.kr ëª¨ë‹ˆí„°ë§ ì•Œë¦¼
          
          âŒ ê°ì§€ëœ ë¬¸ì œ:$ISSUES
          
          ğŸ“Š ìƒíƒœ ì •ë³´:
          â€¢ ì‚¬ì´íŠ¸ ìƒíƒœ: ${{ needs.health-monitoring.outputs.site-status }}
          â€¢ API ìƒíƒœ: ${{ needs.health-monitoring.outputs.api-status }}
          â€¢ ì„±ëŠ¥ ìƒíƒœ: ${{ needs.health-monitoring.outputs.performance-status }}
          â€¢ ê°ì§€ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          ğŸ” í™•ì¸ í•„ìš” ì‚¬í•­:
          â€¢ Vercel ëŒ€ì‹œë³´ë“œ ìƒíƒœ
          â€¢ DNS ì„¤ì • í™•ì¸
          â€¢ CDN ìºì‹œ ìƒíƒœ
          â€¢ ì„œë²„ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
          
          ğŸŒ ì‚¬ì´íŠ¸: https://doha.kr
          ğŸ“Š ëª¨ë‹ˆí„°ë§ ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Slack ì•Œë¦¼
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$ALERT_MESSAGE\", \"channel\": \"#alerts\"}" \
              "$SLACK_WEBHOOK_URL" || echo "âš ï¸ Slack ì•Œë¦¼ ì‹¤íŒ¨"
          fi
          
          # Discord ì•Œë¦¼
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$ALERT_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL" || echo "âš ï¸ Discord ì•Œë¦¼ ì‹¤íŒ¨"
          fi

      - name: ìë™ ì´ìŠˆ ìƒì„±
        if: needs.health-monitoring.outputs.site-status == 'unhealthy'
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            const title = `ğŸš¨ ì‚¬ì´íŠ¸ ë‹¤ìš´ ê°ì§€ - ${now}`;
            const body = `## ğŸš¨ doha.kr ì‚¬ì´íŠ¸ ë‹¤ìš´ ê°ì§€
            
            **ê°ì§€ ì‹œê°„:** ${now}
            
            **ìƒíƒœ ì •ë³´:**
            - ì‚¬ì´íŠ¸ ìƒíƒœ: ${{ needs.health-monitoring.outputs.site-status }}
            - API ìƒíƒœ: ${{ needs.health-monitoring.outputs.api-status }}
            - ì„±ëŠ¥ ìƒíƒœ: ${{ needs.health-monitoring.outputs.performance-status }}
            
            **í™•ì¸ ì‚¬í•­:**
            - [ ] Vercel ëŒ€ì‹œë³´ë“œ ìƒíƒœ í™•ì¸
            - [ ] DNS ì„¤ì • í™•ì¸
            - [ ] ìµœê·¼ ë°°í¬ ìƒíƒœ í™•ì¸
            - [ ] ì„œë²„ ë¦¬ì†ŒìŠ¤ í™•ì¸
            - [ ] CDN ìƒíƒœ í™•ì¸
            
            **ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ì´ ì´ìŠˆëŠ” ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['monitoring', 'site-down', 'urgent']
            });

  # 5ï¸âƒ£ ë³µêµ¬ í™•ì¸ ë° ì´ìŠˆ ìë™ ë‹«ê¸°
  recovery-check:
    name: âœ… ë³µêµ¬ í™•ì¸
    runs-on: ubuntu-latest
    needs: health-monitoring
    if: needs.health-monitoring.outputs.site-status == 'healthy' && needs.health-monitoring.outputs.api-status == 'healthy'
    steps:
      - name: ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ì´ìŠˆ ìë™ ë‹«ê¸°
        uses: actions/github-script@v7
        with:
          script: |
            // ìµœê·¼ 24ì‹œê°„ ë‚´ì˜ ëª¨ë‹ˆí„°ë§ ê´€ë ¨ ì—´ë¦° ì´ìŠˆë“¤ ì¡°íšŒ
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'monitoring,site-down',
              state: 'open',
              since: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
            });
            
            // ê° ì´ìŠˆì— ë³µêµ¬ ì™„ë£Œ ì½”ë©˜íŠ¸ ì¶”ê°€ í›„ ë‹«ê¸°
            for (const issue of issues) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ‰ **ì‚¬ì´íŠ¸ ë³µêµ¬ ì™„ë£Œ**
                
                ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì—ì„œ ì‚¬ì´íŠ¸ê°€ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬ëœ ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.
                
                **ë³µêµ¬ í™•ì¸ ì‹œê°„:** ${new Date().toISOString()}
                **í˜„ì¬ ìƒíƒœ:**
                - ì‚¬ì´íŠ¸ ìƒíƒœ: âœ… ì •ìƒ
                - API ìƒíƒœ: âœ… ì •ìƒ
                
                ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.`
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
            
            console.log(`${issues.length}ê°œì˜ ëª¨ë‹ˆí„°ë§ ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ë‹«ì•˜ìŠµë‹ˆë‹¤.`);

      - name: ë³µêµ¬ ì•Œë¦¼ (í•„ìš”ì‹œ)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "âœ… ì‚¬ì´íŠ¸ ì •ìƒ ìƒíƒœ í™•ì¸ë¨"
          
          # ë§Œì•½ ì´ì „ì— ë¬¸ì œê°€ ìˆì—ˆë‹¤ë©´ ë³µêµ¬ ì•Œë¦¼
          # (ì‹¤ì œë¡œëŠ” ìƒíƒœ ì¶”ì  ë¡œì§ í•„ìš”)
          if [ -n "$SLACK_WEBHOOK_URL" ] && [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RECOVERY_MESSAGE="âœ… doha.kr ìƒíƒœ ì •ìƒ í™•ì¸
            
            ğŸ“Š í˜„ì¬ ìƒíƒœ:
            â€¢ ì‚¬ì´íŠ¸ ìƒíƒœ: ì •ìƒ âœ…
            â€¢ API ìƒíƒœ: ì •ìƒ âœ…
            â€¢ ì„±ëŠ¥ ìƒíƒœ: ì–‘í˜¸ âœ…
            â€¢ í™•ì¸ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
            
            ğŸŒ ì‚¬ì´íŠ¸: https://doha.kr"
            
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$RECOVERY_MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL" || echo "âš ï¸ ë³µêµ¬ ì•Œë¦¼ ì‹¤íŒ¨"
          fi