# í’ˆì§ˆ ëª¨ë‹ˆí„°ë§ ë° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìë™í™”
name: Quality Monitoring & Performance Tests

on:
  # ë§¤ì¼ ìƒˆë²½ 1ì‹œì— ì‹¤í–‰ (ë³´ì•ˆ ê°ì‚¬ì™€ ì‹œê°„ ë¶„ë¦¬)
  schedule:
    - cron: '0 1 * * *'
  
  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  push:
    branches: [ main ]
  
  # PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ì‹¤í–‰
  pull_request:
    branches: [ main ]
  
  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-tests:
    name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë° Lighthouse ê°ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        npm ci
        npx playwright install --with-deps
    
    - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: |
        npm run build
        npm run update:html
    
    - name: ë¡œì»¬ ì„œë²„ ì‹œì‘
      run: |
        npm run serve &
        sleep 10
        curl -f http://localhost:3000 || exit 1
    
    - name: Lighthouse CI ì‹¤í–‰
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouse-ci.json'
        uploadArtifacts: true
        temporaryPublicStorage: true
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
    
    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        npm run test:performance
      continue-on-error: true
    
    - name: Lighthouse ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-reports
        path: |
          .lighthouseci/
          lighthouse-*.html
          playwright-report/
        retention-days: 30
    
    - name: ì„±ëŠ¥ íšŒê·€ ê²€ì‚¬
      run: |
        node .github/scripts/check-performance-regression.js
      continue-on-error: true

  # ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
  accessibility-tests:
    name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        npm ci
        npx playwright install --with-deps
    
    - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: npm run build
    
    - name: ë¡œì»¬ ì„œë²„ ì‹œì‘
      run: |
        npm run serve &
        sleep 10
    
    - name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:accessibility
    
    - name: ì ‘ê·¼ì„± ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-reports
        path: playwright-report/
        retention-days: 30

  # í’ˆì§ˆ ë³´ì¦ í…ŒìŠ¤íŠ¸
  quality-assurance:
    name: í’ˆì§ˆ ë³´ì¦ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        npm ci
        npx playwright install --with-deps
    
    - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: npm run build
    
    - name: ë¡œì»¬ ì„œë²„ ì‹œì‘
      run: |
        npm run serve &
        sleep 10
    
    - name: ì „ì²´ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:e2e
    
    - name: ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:security
    
    - name: í•œêµ­ì–´ ë¡œì»¬ë¼ì´ì œì´ì…˜ í…ŒìŠ¤íŠ¸
      run: npm run test:korean
    
    - name: í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: npm run test:cross-browser
    
    - name: API í†µí•© í…ŒìŠ¤íŠ¸
      run: npm run test:integration
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    - name: í’ˆì§ˆ í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-test-reports
        path: |
          playwright-report/
          test-results/
        retention-days: 30

  # PWA ê²€ì¦
  pwa-validation:
    name: PWA ê²€ì¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
      run: npm run build
    
    - name: PWA ë¹Œë“œ
      run: npm run build:pwa
    
    - name: ë¡œì»¬ ì„œë²„ ì‹œì‘
      run: |
        npm run serve &
        sleep 10
    
    - name: PWA Lighthouse ê°ì‚¬
      run: |
        npx lighthouse http://localhost:3000 \
          --only-categories=pwa \
          --output=html \
          --output-path=./pwa-audit-report.html \
          --chrome-flags="--headless --no-sandbox --disable-gpu"
    
    - name: Manifest ê²€ì¦
      run: |
        curl -f http://localhost:3000/manifest.json > manifest-check.json
        node -e "
          const manifest = require('./manifest-check.json');
          if (!manifest.name || !manifest.short_name || !manifest.start_url) {
            console.error('PWA manifest validation failed');
            process.exit(1);
          }
          console.log('PWA manifest validation passed');
        "
    
    - name: Service Worker ê²€ì¦
      run: |
        curl -f http://localhost:3000/sw.js > /dev/null
        echo "Service Worker validation passed"
    
    - name: PWA ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pwa-reports
        path: |
          pwa-audit-report.html
          manifest-check.json
        retention-days: 30

  # í’ˆì§ˆ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
  quality-metrics:
    name: í’ˆì§ˆ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
    runs-on: ubuntu-latest
    needs: [performance-tests, accessibility-tests, quality-assurance, pwa-validation]
    if: always()
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: í’ˆì§ˆ ë³´ê³ ì„œ ìƒì„±
      run: |
        node .github/scripts/generate-quality-report.js
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RUN_ID: ${{ github.run_id }}
        RUN_NUMBER: ${{ github.run_number }}
        COMMIT_SHA: ${{ github.sha }}
        BRANCH_NAME: ${{ github.ref_name }}
    
    - name: í’ˆì§ˆ ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: quality-summary-report
        path: |
          quality-report.html
          quality-metrics.json
        retention-days: 90
    
    - name: í’ˆì§ˆ ë©”íŠ¸ë¦­ì„ GitHub Pagesì— ë°°í¬
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./quality-reports
        destination_dir: quality-reports
        keep_files: true
    
    - name: Slack ì•Œë¦¼ (ì„±ëŠ¥ íšŒê·€ ê°ì§€ì‹œ)
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: "ğŸš¨ doha.kr í’ˆì§ˆ íšŒê·€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ GitHub Actionsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
  update-monitoring:
    name: ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    needs: [quality-metrics]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
    
    - name: í’ˆì§ˆ ë©”íŠ¸ë¦­ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: quality-summary-report
        path: ./quality-data
    
    - name: ëª¨ë‹ˆí„°ë§ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
      run: |
        node .github/scripts/update-monitoring-db.js
      env:
        MONITORING_DB_URL: ${{ secrets.MONITORING_DB_URL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ íŠ¸ë¦¬ê±°
      run: |
        curl -X POST "${{ secrets.MONITORING_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d '{"source": "github-actions", "run_id": "${{ github.run_id }}", "status": "completed"}'