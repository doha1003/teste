name: CI/CD Pipeline for doha.kr

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # 1ë‹¨ê³„: íƒ€ì… ê²€ì‚¬ ë° ë¦°íŒ…
  type-check:
    runs-on: ubuntu-latest
    name: "ğŸ” Type Check & Lint"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: TypeScript type checking
      run: npm run typecheck
      
    - name: ESLint checking
      run: npm run lint
      
    - name: Prettier format checking
      run: npx prettier --check "**/*.{ts,js,css,html,md}"

  # 2ë‹¨ê³„: ë¹Œë“œ ê²€ì¦
  build:
    runs-on: ubuntu-latest
    name: "ğŸ—ï¸ Build Verification"
    needs: type-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build TypeScript
      run: npm run build:ts
      
    - name: Verify build artifacts
      run: |
        echo "Checking required JavaScript files..."
        test -f js/main.js || (echo "âŒ main.js not found" && exit 1)
        test -f js/api-config.js || (echo "âŒ api-config.js not found" && exit 1)
        test -f js/manseryeok-api-client.js || (echo "âŒ manseryeok-api-client.js not found" && exit 1)
        test -f js/image-optimizer.js || (echo "âŒ image-optimizer.js not found" && exit 1)
        test -f js/bundle-optimizer.js || (echo "âŒ bundle-optimizer.js not found" && exit 1)
        test -f js/performance-optimizer.js || (echo "âŒ performance-optimizer.js not found" && exit 1)
        test -f js/monitoring-system.js || (echo "âŒ monitoring-system.js not found" && exit 1)
        echo "âœ… All required files built successfully"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          js/
          types/
        retention-days: 1

  # 3ë‹¨ê³„: ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„± í…ŒìŠ¤íŠ¸ (ê°€ì¥ ì¤‘ìš”!)
  manseryeok-accuracy-test:
    runs-on: ubuntu-latest
    name: "ğŸ—“ï¸ ë§Œì„¸ë ¥ ì •í™•ì„± ê²€ì¦ (CRITICAL)"
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: Run Manseryeok accuracy tests
      run: |
        echo "ğŸ” ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„± í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        echo "âš ï¸  ì¤‘ìš”: ë§Œì„¸ë ¥ì´ ì¶•ì†Œí•˜ë‹¤ê°€ ì˜ëª»ë˜ê²Œ ë‚˜ì˜¤ë©´ ì ˆëŒ€ì•ˆë¨!"
        npm test -- tests/manseryeok.test.ts --run --reporter=verbose
        
    - name: Verify Manseryeok test results
      run: |
        echo "âœ… ë§Œì„¸ë ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê²€ì¦ ì™„ë£Œ"
        echo "ğŸ“Š ëª¨ë“  ë§Œì„¸ë ¥ ë°ì´í„°ê°€ ì •í™•í•¨ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤"

  # 4ë‹¨ê³„: ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
  test:
    runs-on: ubuntu-latest
    name: "ğŸ§ª Full Test Suite"
    needs: manseryeok-accuracy-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: Run all tests
      run: npm test -- --run --reporter=verbose
      
    - name: Generate test coverage
      run: npm run test:coverage
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # 5ë‹¨ê³„: ì„±ëŠ¥ ê²€ì¦
  performance-test:
    runs-on: ubuntu-latest
    name: "ğŸš€ Performance Validation"
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: Bundle size analysis
      run: |
        echo "ğŸ“¦ Bundle size analysis..."
        npm run build:ts
        
        # Check main.js size (should be < 50KB)
        MAIN_SIZE=$(stat -c%s "js/main.js")
        if [ $MAIN_SIZE -gt 51200 ]; then
          echo "âŒ main.js is too large: ${MAIN_SIZE} bytes (limit: 50KB)"
          exit 1
        fi
        
        # Check manseryeok-api-client.js size (should be < 20KB after optimization)
        MANSERYEOK_SIZE=$(stat -c%s "js/manseryeok-api-client.js")
        if [ $MANSERYEOK_SIZE -gt 20480 ]; then
          echo "âŒ manseryeok-api-client.js is too large: ${MANSERYEOK_SIZE} bytes (limit: 20KB)"
          exit 1
        fi
        
        echo "âœ… Bundle sizes within acceptable limits"
        echo "ğŸ“Š main.js: ${MAIN_SIZE} bytes"
        echo "ğŸ“Š manseryeok-api-client.js: ${MANSERYEOK_SIZE} bytes"

  # 6ë‹¨ê³„: ë³´ì•ˆ ê²€ì‚¬
  security:
    runs-on: ubuntu-latest
    name: "ğŸ”’ Security Audit"
    needs: type-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: npm audit --audit-level=moderate
      
    - name: Check for secrets in code
      run: |
        echo "ğŸ” Checking for potential secrets..."
        if grep -r "sk-" src/ || grep -r "api_key" src/ || grep -r "secret" src/; then
          echo "âŒ Potential secrets found in source code!"
          exit 1
        fi
        echo "âœ… No secrets detected in source code"

  # 7ë‹¨ê³„: ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
  deploy:
    runs-on: ubuntu-latest
    name: "ğŸš€ Deploy to Production"
    needs: [manseryeok-accuracy-test, test, performance-test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        
    - name: Final manseryeok verification before deploy
      run: |
        echo "ğŸ” ë°°í¬ ì „ ìµœì¢… ë§Œì„¸ë ¥ ì •í™•ì„± ê²€ì¦..."
        npm test -- tests/manseryeok.test.ts --run
        echo "âœ… ë°°í¬ ì „ ë§Œì„¸ë ¥ ê²€ì¦ ì™„ë£Œ"
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: |
          node_modules/
          src/
          tests/
          .git/
          .github/
          *.md
          package*.json
          tsconfig.json
          vitest.config.ts
          .eslintrc.json
          .prettierrc
          
    - name: Deployment notification
      run: |
        echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
        echo "ğŸŒ ì‚¬ì´íŠ¸: https://doha.kr"
        echo "ğŸ“Š ëª¨ë“  ê²€ì¦ ë‹¨ê³„ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤"
        echo "âœ… ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„± ë³´ì¥ë¨"

  # 8ë‹¨ê³„: ë°°í¬ í›„ ê²€ì¦
  post-deploy-verification:
    runs-on: ubuntu-latest
    name: "âœ… Post-Deploy Verification"
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Wait for deployment
      run: sleep 60
      
    - name: Verify site accessibility
      run: |
        echo "ğŸŒ ë°°í¬ëœ ì‚¬ì´íŠ¸ ì ‘ê·¼ì„± í™•ì¸..."
        curl -f https://doha.kr || (echo "âŒ ì‚¬ì´íŠ¸ ì ‘ê·¼ ì‹¤íŒ¨" && exit 1)
        echo "âœ… ì‚¬ì´íŠ¸ ì •ìƒ ì ‘ê·¼ í™•ì¸"
        
    - name: Basic functionality test
      run: |
        echo "âš¡ ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."
        # Check if main JavaScript files are accessible
        curl -f https://doha.kr/js/main.js > /dev/null || (echo "âŒ main.js ë¡œë“œ ì‹¤íŒ¨" && exit 1)
        curl -f https://doha.kr/js/manseryeok-api-client.js > /dev/null || (echo "âŒ manseryeok-api-client.js ë¡œë“œ ì‹¤íŒ¨" && exit 1)
        echo "âœ… ì£¼ìš” JavaScript íŒŒì¼ ë¡œë“œ í™•ì¸"
        
    - name: Performance check
      run: |
        echo "ğŸš€ ì„±ëŠ¥ ì²´í¬..."
        # Basic response time check
        RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://doha.kr)
        echo "ğŸ“Š ì‘ë‹µ ì‹œê°„: ${RESPONSE_TIME}ì´ˆ"
        
        # Check if response time is under 3 seconds
        if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
          echo "âš ï¸  ì‘ë‹µ ì‹œê°„ì´ 3ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
        else
          echo "âœ… ì‘ë‹µ ì‹œê°„ ì–‘í˜¸"
        fi

  # 9ë‹¨ê³„: ì•Œë¦¼
  notify:
    runs-on: ubuntu-latest
    name: "ğŸ“¢ Notification"
    needs: [post-deploy-verification]
    if: always()
    
    steps:
    - name: Success notification
      if: needs.post-deploy-verification.result == 'success'
      run: |
        echo "ğŸ‰ CI/CD íŒŒì´í”„ë¼ì¸ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ!"
        echo "âœ… ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„± ê²€ì¦ ì™„ë£Œ"
        echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
        echo "âœ… ì„±ëŠ¥ ê²€ì¦ ì™„ë£Œ" 
        echo "âœ… ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"
        echo "âœ… ë°°í¬ ë° ê²€ì¦ ì™„ë£Œ"
        echo "ğŸŒ ì‚¬ì´íŠ¸: https://doha.kr"
        
    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”"
        echo "âš ï¸  íŠ¹íˆ ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„±ì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”"