name: ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

on:
  schedule:
    # ë§¤ 15ë¶„ë§ˆë‹¤ ì‹¤í–‰
    - cron: '*/15 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'ëª¨ë‹ˆí„°ë§ íƒ€ì… ì„ íƒ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - uptime
          - performance
          - security
          - api

permissions:
  contents: read
  issues: write

jobs:
  # 1ï¸âƒ£ ì—…íƒ€ì„ ëª¨ë‹ˆí„°ë§
  uptime-check:
    name: ğŸŒ ì‚¬ì´íŠ¸ ê°€ìš©ì„± í™•ì¸
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'uptime' || github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    outputs:
      site-status: ${{ steps.check.outputs.status }}
      response-time: ${{ steps.check.outputs.response-time }}
    steps:
      - name: ë©”ì¸ ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸
        id: check
        run: |
          echo "ğŸŒ doha.kr ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸..."
          
          # ë©”ì¸ ì‚¬ì´íŠ¸ í™•ì¸
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://doha.kr || echo "000")
          MAIN_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://doha.kr || echo "999")
          
          echo "main-status=${MAIN_STATUS}" >> $GITHUB_OUTPUT
          echo "main-time=${MAIN_TIME}" >> $GITHUB_OUTPUT
          
          # API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://doha.kr/api/health || echo "000")
          echo "api-status=${API_STATUS}" >> $GITHUB_OUTPUT
          
          # ì „ì²´ ìƒíƒœ íŒë‹¨
          if [[ "${MAIN_STATUS}" == "200" && "${API_STATUS}" == "200" ]]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "response-time=${MAIN_TIME}" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "response-time=999" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… ìƒíƒœ ì²´í¬ ì™„ë£Œ"
          echo "ğŸ“Š ë©”ì¸ ì‚¬ì´íŠ¸: ${MAIN_STATUS} (${MAIN_TIME}s)"
          echo "ğŸ“Š API ìƒíƒœ: ${API_STATUS}"

      - name: ì£¼ìš” í˜ì´ì§€ ìƒíƒœ í™•ì¸
        run: |
          echo "ğŸ” ì£¼ìš” í˜ì´ì§€ ìƒíƒœ í™•ì¸..."
          
          PAGES=("/fortune/daily" "/tests/mbti" "/tools/bmi-calculator.html")
          FAILED_PAGES=()
          
          for page in "${PAGES[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://doha.kr${page}" || echo "000")
            if [[ "${STATUS}" != "200" ]]; then
              FAILED_PAGES+=("${page}")
              echo "âŒ ${page}: ${STATUS}"
            else
              echo "âœ… ${page}: ${STATUS}"
            fi
          done
          
          if [[ ${#FAILED_PAGES[@]} -gt 0 ]]; then
            echo "::warning::ì¼ë¶€ í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${FAILED_PAGES[*]}"
          fi

  # 2ï¸âƒ£ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  performance-check:
    name: ğŸš€ ì„±ëŠ¥ ë¶„ì„
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'performance' || github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    needs: uptime-check
    steps:
      - name: í˜ì´ì§€ ì†ë„ í…ŒìŠ¤íŠ¸
        run: |
          echo "âš¡ í˜ì´ì§€ ë¡œë”© ì†ë„ ë¶„ì„..."
          
          # ë©”ì¸ í˜ì´ì§€ ì„±ëŠ¥ ì¸¡ì •
          LOAD_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://doha.kr)
          TTFB=$(curl -s -o /dev/null -w "%{time_starttransfer}" https://doha.kr)
          DNS_TIME=$(curl -s -o /dev/null -w "%{time_namelookup}" https://doha.kr)
          
          echo "ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­:"
          echo "- ì „ì²´ ë¡œë”© ì‹œê°„: ${LOAD_TIME}ì´ˆ"
          echo "- TTFB: ${TTFB}ì´ˆ"
          echo "- DNS ì¡°íšŒ: ${DNS_TIME}ì´ˆ"
          
          # ì„±ëŠ¥ ì„ê³„ê°’ í™•ì¸ (3ì´ˆ)
          if (( $(echo "$LOAD_TIME > 3.0" | bc -l) )); then
            echo "::warning::í˜ì´ì§€ ë¡œë”© ì‹œê°„ì´ 3ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤: ${LOAD_TIME}ì´ˆ"
          else
            echo "âœ… í˜ì´ì§€ ë¡œë”© ì‹œê°„ ì–‘í˜¸: ${LOAD_TIME}ì´ˆ"
          fi

      - name: API ì‘ë‹µ ì‹œê°„ ì¸¡ì •
        run: |
          echo "ğŸ“¡ API ì‘ë‹µ ì‹œê°„ ì¸¡ì •..."
          
          # Health API ì‘ë‹µ ì‹œê°„
          HEALTH_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://doha.kr/api/health)
          echo "ğŸ¥ Health API: ${HEALTH_TIME}ì´ˆ"
          
          # Fortune API í…ŒìŠ¤íŠ¸ (ê°€ë²¼ìš´ ìš”ì²­)
          FORTUNE_TIME=$(curl -s -o /dev/null -w "%{time_total}" -X POST \
            -H "Content-Type: application/json" \
            -d '{"type":"daily","userData":{"name":"í…ŒìŠ¤íŠ¸"}}' \
            https://doha.kr/api/fortune || echo "999")
          echo "ğŸ”® Fortune API: ${FORTUNE_TIME}ì´ˆ"
          
          # API ì„±ëŠ¥ ê²½ê³  (5ì´ˆ)
          if (( $(echo "$HEALTH_TIME > 5.0" | bc -l) )); then
            echo "::warning::Health API ì‘ë‹µì´ ëŠë¦½ë‹ˆë‹¤: ${HEALTH_TIME}ì´ˆ"
          fi

  # 3ï¸âƒ£ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§
  security-check:
    name: ğŸ”’ ë³´ì•ˆ ìƒíƒœ í™•ì¸
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'security' || github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    steps:
      - name: SSL ì¸ì¦ì„œ í™•ì¸
        run: |
          echo "ğŸ” SSL ì¸ì¦ì„œ ìƒíƒœ í™•ì¸..."
          
          # SSL ì¸ì¦ì„œ ë§Œë£Œì¼ í™•ì¸
          CERT_INFO=$(echo | openssl s_client -servername doha.kr -connect doha.kr:443 2>/dev/null | openssl x509 -noout -dates)
          echo "ğŸ“‹ ì¸ì¦ì„œ ì •ë³´:"
          echo "${CERT_INFO}"
          
          # ë§Œë£Œì¼ ì¶”ì¶œ ë° í™•ì¸
          EXPIRE_DATE=$(echo "${CERT_INFO}" | grep "notAfter" | cut -d= -f2)
          EXPIRE_TIMESTAMP=$(date -d "${EXPIRE_DATE}" +%s)
          CURRENT_TIMESTAMP=$(date +%s)
          DAYS_LEFT=$(( (EXPIRE_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
          echo "ğŸ“… ì¸ì¦ì„œ ë§Œë£Œê¹Œì§€: ${DAYS_LEFT}ì¼"
          
          if [[ ${DAYS_LEFT} -lt 30 ]]; then
            echo "::warning::SSL ì¸ì¦ì„œ ë§Œë£Œê°€ 30ì¼ ì´ë‚´ì…ë‹ˆë‹¤: ${DAYS_LEFT}ì¼ ë‚¨ìŒ"
          else
            echo "âœ… SSL ì¸ì¦ì„œ ìƒíƒœ ì–‘í˜¸: ${DAYS_LEFT}ì¼ ë‚¨ìŒ"
          fi

      - name: ë³´ì•ˆ í—¤ë” í™•ì¸
        run: |
          echo "ğŸ›¡ï¸ ë³´ì•ˆ í—¤ë” í™•ì¸..."
          
          HEADERS=$(curl -s -I https://doha.kr)
          
          # í•„ìˆ˜ ë³´ì•ˆ í—¤ë” í™•ì¸
          SECURITY_HEADERS=(
            "Strict-Transport-Security"
            "X-Content-Type-Options"
            "X-Frame-Options"
            "Content-Security-Policy"
            "Referrer-Policy"
          )
          
          MISSING_HEADERS=()
          
          for header in "${SECURITY_HEADERS[@]}"; do
            if echo "${HEADERS}" | grep -qi "${header}"; then
              echo "âœ… ${header}: ì„¤ì •ë¨"
            else
              MISSING_HEADERS+=("${header}")
              echo "âŒ ${header}: ëˆ„ë½"
            fi
          done
          
          if [[ ${#MISSING_HEADERS[@]} -gt 0 ]]; then
            echo "::warning::ëˆ„ë½ëœ ë³´ì•ˆ í—¤ë”: ${MISSING_HEADERS[*]}"
          else
            echo "âœ… ëª¨ë“  ë³´ì•ˆ í—¤ë” ì„¤ì • ì™„ë£Œ"
          fi

  # 4ï¸âƒ£ API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
  api-functionality:
    name: ğŸ”§ API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'api' || github.event.inputs.check_type == 'all' || github.event_name == 'schedule'
    steps:
      - name: Fortune API í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”® Fortune API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."
          
          # ì¼ì¼ ìš´ì„¸ API í…ŒìŠ¤íŠ¸
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "type": "daily",
              "userData": {
                "name": "ëª¨ë‹ˆí„°ë§í…ŒìŠ¤íŠ¸",
                "birthDate": "1990-01-01",
                "gender": "male"
              }
            }' \
            https://doha.kr/api/fortune)
          
          if echo "${RESPONSE}" | grep -q "fortune\|ìš´ì„¸\|ì˜¤ëŠ˜"; then
            echo "âœ… Fortune API ì •ìƒ ì‘ë™"
          else
            echo "âŒ Fortune API ì‘ë‹µ ì´ìƒ"
            echo "Response: ${RESPONSE}"
            echo "::error::Fortune APIê°€ ì˜ˆìƒëœ ì‘ë‹µì„ ë°˜í™˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          fi

      - name: Manseryeok API í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ“… Manseryeok API ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."
          
          # ë§Œì„¸ë ¥ API í…ŒìŠ¤íŠ¸
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "year": 1990,
              "month": 5,
              "day": 15,
              "hour": 12,
              "minute": 0,
              "isLunar": false
            }' \
            https://doha.kr/api/manseryeok)
          
          if echo "${RESPONSE}" | grep -q "year\|month\|day"; then
            echo "âœ… Manseryeok API ì •ìƒ ì‘ë™"
          else
            echo "âŒ Manseryeok API ì‘ë‹µ ì´ìƒ"
            echo "Response: ${RESPONSE}"
            echo "::error::Manseryeok APIê°€ ì˜ˆìƒëœ ì‘ë‹µì„ ë°˜í™˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          fi

  # 5ï¸âƒ£ ì¢…í•© ìƒíƒœ ë¦¬í¬íŠ¸
  monitoring-report:
    name: ğŸ“‹ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [uptime-check, performance-check, security-check, api-functionality]
    if: always()
    steps:
      - name: ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ğŸ“Š doha.kr ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ìƒì„±..."
          
          # í˜„ì¬ ì‹œê° (í•œêµ­ ì‹œê°„)
          CURRENT_TIME=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')
          echo "â° ëª¨ë‹ˆí„°ë§ ì‹œê°„: ${CURRENT_TIME}"
          
          # ì „ì²´ ìƒíƒœ ìš”ì•½
          echo ""
          echo "## ğŸ¥ ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½"
          echo "- ì‚¬ì´íŠ¸ ìƒíƒœ: ${{ needs.uptime-check.outputs.site-status || 'í™•ì¸ í•„ìš”' }}"
          echo "- ì‘ë‹µ ì‹œê°„: ${{ needs.uptime-check.outputs.response-time || 'ì¸¡ì • ì‹¤íŒ¨' }}ì´ˆ"
          
          # ê° ì‘ì—… ìƒíƒœ í™•ì¸
          UPTIME_STATUS="${{ needs.uptime-check.result }}"
          PERF_STATUS="${{ needs.performance-check.result }}"
          SECURITY_STATUS="${{ needs.security-check.result }}"
          API_STATUS="${{ needs.api-functionality.result }}"
          
          echo ""
          echo "## ğŸ“‹ ì„¸ë¶€ ê²€ì‚¬ ê²°ê³¼"
          echo "- ğŸŒ ì—…íƒ€ì„ ì²´í¬: ${UPTIME_STATUS}"
          echo "- ğŸš€ ì„±ëŠ¥ ì²´í¬: ${PERF_STATUS}"
          echo "- ğŸ”’ ë³´ì•ˆ ì²´í¬: ${SECURITY_STATUS}"
          echo "- ğŸ”§ API ì²´í¬: ${API_STATUS}"
          
          # ì‹¤íŒ¨í•œ ì‘ì—…ì´ ìˆëŠ”ì§€ í™•ì¸
          if [[ "${UPTIME_STATUS}" == "failure" || "${PERF_STATUS}" == "failure" || "${SECURITY_STATUS}" == "failure" || "${API_STATUS}" == "failure" ]]; then
            echo ""
            echo "âš ï¸ ì¼ë¶€ ëª¨ë‹ˆí„°ë§ í•­ëª©ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ìì„¸í•œ ë‚´ìš©ì€ ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            exit 1
          else
            echo ""
            echo "âœ… ëª¨ë“  ëª¨ë‹ˆí„°ë§ í•­ëª©ì´ ì •ìƒì…ë‹ˆë‹¤."
          fi

      - name: ì‹¤íŒ¨ ì‹œ ì´ìŠˆ ìƒì„±
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ ëª¨ë‹ˆí„°ë§ ì•Œë¦¼: doha.kr ì‹œìŠ¤í…œ ì´ìƒ ê°ì§€`;
            const body = `## ğŸš¨ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì•Œë¦¼
            
            **ê°ì§€ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
            
            ### ğŸ“Š ìƒíƒœ ìš”ì•½
            - ì—…íƒ€ì„ ì²´í¬: ${{ needs.uptime-check.result }}
            - ì„±ëŠ¥ ì²´í¬: ${{ needs.performance-check.result }}
            - ë³´ì•ˆ ì²´í¬: ${{ needs.security-check.result }}
            - API ì²´í¬: ${{ needs.api-functionality.result }}
            
            ### ğŸ” í™•ì¸ í•„ìš”ì‚¬í•­
            1. ì‚¬ì´íŠ¸ ì ‘ê·¼ì„± í™•ì¸
            2. API ì‘ë‹µ ìƒíƒœ ì ê²€
            3. ì„±ëŠ¥ ì§€í‘œ ë¶„ì„
            4. ë³´ì•ˆ ì„¤ì • ê²€í† 
            
            ### ğŸ“ ëŒ€ì‘ ì ˆì°¨
            - [ ] ì¦‰ì‹œ ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸
            - [ ] ë¡œê·¸ ë¶„ì„ ë° ì›ì¸ íŒŒì•…
            - [ ] í•„ìš”ì‹œ ê¸´ê¸‰ íŒ¨ì¹˜ ì ìš©
            - [ ] ì‚¬ìš©ì ê³µì§€ ì—¬ë¶€ ê²°ì •
            
            **ì›Œí¬í”Œë¡œìš°**: [ë§í¬](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *ìë™ ìƒì„±ëœ ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ì…ë‹ˆë‹¤.*`;
            
            // ê¸°ì¡´ì— ì—´ë¦° ëª¨ë‹ˆí„°ë§ ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'monitoring,alert'
            });
            
            const existingIssue = issues.find(issue => issue.title.includes('ëª¨ë‹ˆí„°ë§ ì•Œë¦¼'));
            
            if (existingIssue) {
              // ê¸°ì¡´ ì´ìŠˆì— ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ”„ ëª¨ë‹ˆí„°ë§ ì—…ë°ì´íŠ¸\n\n${body}`
              });
            } else {
              // ìƒˆ ì´ìŠˆ ìƒì„±
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['monitoring', 'alert', 'high-priority']
              });
            }
            
      - name: ì„±ê³µ ì‹œ ê¸°ì¡´ ì´ìŠˆ ë‹«ê¸°
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            // ì—´ë¦° ëª¨ë‹ˆí„°ë§ ì´ìŠˆë“¤ ì°¾ê¸°
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'monitoring,alert'
            });
            
            const monitoringIssues = issues.filter(issue => 
              issue.title.includes('ëª¨ë‹ˆí„°ë§ ì•Œë¦¼')
            );
            
            // ëª¨ë‹ˆí„°ë§ ì´ìŠˆë“¤ ë‹«ê¸°
            for (const issue of monitoringIssues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âœ… **ëª¨ë‹ˆí„°ë§ ì •ìƒí™” í™•ì¸**\n\nëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n**í™•ì¸ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}`
              });
            }