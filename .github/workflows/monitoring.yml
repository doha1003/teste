name: ğŸ“Š í”„ë¡œë•ì…˜ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ

on:
  schedule:
    # ë§¤ ì‹œê°„ë§ˆë‹¤ í—¬ìŠ¤ì²´í¬
    - cron: '0 * * * *'
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì„±ëŠ¥ ë¦¬í¬íŠ¸
    - cron: '0 9 * * *'
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 10ì‹œ ì£¼ê°„ ë¦¬í¬íŠ¸
    - cron: '0 10 * * 1'
  
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'ëª¨ë‹ˆí„°ë§ ìœ í˜•'
        required: true
        type: choice
        options:
          - health-check
          - performance-test
          - security-scan
          - weekly-report
          - emergency-check
      
      alert_level:
        description: 'ì•Œë¦¼ ë ˆë²¨'
        required: false
        type: choice
        options:
          - info
          - warning
          - critical
        default: 'info'

permissions:
  contents: read
  issues: write
  actions: write

env:
  SITE_URL: 'https://doha.kr'
  MONITORING_TIMEOUT: 30000

jobs:
  # ğŸ¥ í—¬ìŠ¤ì²´í¬ ëª¨ë‹ˆí„°ë§
  health-monitoring:
    name: ğŸ¥ í—¬ìŠ¤ì²´í¬ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 * * * *' || github.event.inputs.monitoring_type == 'health-check' || github.event.inputs.monitoring_type == 'emergency-check'
    outputs:
      status: ${{ steps.health.outputs.status }}
      response_time: ${{ steps.health.outputs.response_time }}
      issues_found: ${{ steps.health.outputs.issues_found }}
    steps:
      - name: ë©”ì¸ ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬
        id: health
        run: |
          echo "ğŸ¥ doha.kr í—¬ìŠ¤ì²´í¬ ì‹œì‘"
          
          ISSUES_FOUND=0
          HEALTH_REPORT=""
          
          # ë©”ì¸ í˜ì´ì§€ í™•ì¸
          echo "ğŸŒ ë©”ì¸ í˜ì´ì§€ í™•ì¸..."
          MAIN_START=$(date +%s%3N)
          if curl -f -s -m 10 "${{ env.SITE_URL }}" > /dev/null; then
            MAIN_END=$(date +%s%3N)
            MAIN_TIME=$((MAIN_END - MAIN_START))
            echo "âœ… ë©”ì¸ í˜ì´ì§€: ${MAIN_TIME}ms"
            HEALTH_REPORT+="âœ… ë©”ì¸ í˜ì´ì§€: ${MAIN_TIME}ms\n"
          else
            echo "âŒ ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼ ì‹¤íŒ¨"
            HEALTH_REPORT+="âŒ ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼ ì‹¤íŒ¨\n"
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
          fi
          
          # API í—¬ìŠ¤ì²´í¬
          echo "ğŸ”Œ API í—¬ìŠ¤ì²´í¬..."
          API_START=$(date +%s%3N)
          API_RESPONSE=$(curl -f -s -m 10 "${{ env.SITE_URL }}/api/health" || echo "ERROR")
          if [ "$API_RESPONSE" != "ERROR" ]; then
            API_END=$(date +%s%3N)
            API_TIME=$((API_END - API_START))
            echo "âœ… API í—¬ìŠ¤ì²´í¬: ${API_TIME}ms"
            HEALTH_REPORT+="âœ… API í—¬ìŠ¤ì²´í¬: ${API_TIME}ms\n"
            
            # API ì‘ë‹µ ìƒì„¸ ë¶„ì„
            if echo "$API_RESPONSE" | grep -q '"status":"healthy"'; then
              echo "âœ… API ìƒíƒœ: ì •ìƒ"
              HEALTH_REPORT+="âœ… API ìƒíƒœ: ì •ìƒ\n"
            else
              echo "âš ï¸ API ìƒíƒœ: ë¹„ì •ìƒ"
              HEALTH_REPORT+="âš ï¸ API ìƒíƒœ: ë¹„ì •ìƒ\n"
              ISSUES_FOUND=$((ISSUES_FOUND + 1))
            fi
          else
            echo "âŒ API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            HEALTH_REPORT+="âŒ API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨\n"
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
          fi
          
          # ì£¼ìš” í˜ì´ì§€ë“¤ í™•ì¸
          PAGES=("/fortune/daily/" "/tests/mbti/" "/tools/bmi-calculator.html")
          for PAGE in "${PAGES[@]}"; do
            echo "ğŸ“„ í˜ì´ì§€ í™•ì¸: $PAGE"
            if curl -f -s -m 10 "${{ env.SITE_URL }}$PAGE" > /dev/null; then
              echo "âœ… $PAGE: ì •ìƒ"
              HEALTH_REPORT+="âœ… $PAGE: ì •ìƒ\n"
            else
              echo "âŒ $PAGE: ì ‘ê·¼ ì‹¤íŒ¨"
              HEALTH_REPORT+="âŒ $PAGE: ì ‘ê·¼ ì‹¤íŒ¨\n"
              ISSUES_FOUND=$((ISSUES_FOUND + 1))
            fi
          done
          
          # SSL ì¸ì¦ì„œ í™•ì¸
          echo "ğŸ”’ SSL ì¸ì¦ì„œ í™•ì¸..."
          SSL_INFO=$(echo | openssl s_client -connect doha.kr:443 -servername doha.kr 2>/dev/null | openssl x509 -noout -dates 2>/dev/null || echo "ERROR")
          if [ "$SSL_INFO" != "ERROR" ]; then
            EXPIRY=$(echo "$SSL_INFO" | grep "notAfter" | cut -d= -f2)
            echo "âœ… SSL ì¸ì¦ì„œ: ìœ íš¨ (ë§Œë£Œ: $EXPIRY)"
            HEALTH_REPORT+="âœ… SSL ì¸ì¦ì„œ: ìœ íš¨\n"
          else
            echo "âŒ SSL ì¸ì¦ì„œ í™•ì¸ ì‹¤íŒ¨"
            HEALTH_REPORT+="âŒ SSL ì¸ì¦ì„œ í™•ì¸ ì‹¤íŒ¨\n"
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
          fi
          
          # ê²°ê³¼ ì €ì¥
          if [ $ISSUES_FOUND -eq 0 ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi
          
          echo "issues_found=$ISSUES_FOUND" >> $GITHUB_OUTPUT
          echo "response_time=$MAIN_TIME" >> $GITHUB_OUTPUT
          
          # í—¬ìŠ¤ì²´í¬ ë¦¬í¬íŠ¸ ì €ì¥
          echo -e "$HEALTH_REPORT" > health-report.txt

      - name: í—¬ìŠ¤ì²´í¬ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_id }}
          path: health-report.txt
          retention-days: 7

  # âš¡ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  performance-monitoring:
    name: âš¡ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * *' || github.event.inputs.monitoring_type == 'performance-test'
    needs: health-monitoring
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://doha.kr/
            https://doha.kr/fortune/daily/
            https://doha.kr/tests/mbti/
            https://doha.kr/tools/bmi-calculator.html
          budgetPath: ./.github/lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¶„ì„
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¶„ì„"
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          PAGES=("" "/fortune/daily/" "/tests/mbti/" "/tools/bmi-calculator.html")
          PERF_REPORT="# ğŸ“Š doha.kr ì„±ëŠ¥ ë¦¬í¬íŠ¸\n\n"
          PERF_REPORT+="**ì¸¡ì • ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S KST')\n\n"
          PERF_REPORT+="## ğŸ“ˆ ì‘ë‹µ ì‹œê°„\n\n"
          
          for PAGE in "${PAGES[@]}"; do
            URL="${{ env.SITE_URL }}$PAGE"
            RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 10 "$URL")
            RESPONSE_MS=$(echo "$RESPONSE_TIME * 1000" | bc)
            
            if (( $(echo "$RESPONSE_TIME <= 1.0" | bc -l) )); then
              STATUS="ğŸŸ¢ ìš°ìˆ˜"
            elif (( $(echo "$RESPONSE_TIME <= 2.0" | bc -l) )); then
              STATUS="ğŸŸ¡ ì–‘í˜¸"
            else
              STATUS="ğŸ”´ ê°œì„ í•„ìš”"
            fi
            
            echo "ğŸ“„ $PAGE: ${RESPONSE_MS}ms ($STATUS)"
            PERF_REPORT+="- **$PAGE**: ${RESPONSE_MS}ms $STATUS\n"
          done
          
          PERF_REPORT+="\n## ğŸ” ìƒì„¸ ë¶„ì„\n\n"
          PERF_REPORT+="- **ì „ì²´ ì‘ë‹µì‹œê°„ í‰ê· **: ê³„ì‚° ì¤‘...\n"
          PERF_REPORT+="- **Lighthouse ì ìˆ˜**: Lighthouse CI ê²°ê³¼ ì°¸ì¡°\n"
          PERF_REPORT+="- **CDN ìºì‹œ ìƒíƒœ**: ë¶„ì„ ì¤‘...\n"
          
          echo -e "$PERF_REPORT" > performance-report.md

      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.run_id }}
          path: performance-report.md
          retention-days: 30

  # ğŸ›¡ï¸ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§
  security-monitoring:
    name: ğŸ›¡ï¸ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    if: github.event.inputs.monitoring_type == 'security-scan' || github.event.schedule == '0 10 * * 1'
    steps:
      - name: ë³´ì•ˆ í—¤ë” í™•ì¸
        run: |
          echo "ğŸ›¡ï¸ ë³´ì•ˆ í—¤ë” ìŠ¤ìº”"
          
          SECURITY_REPORT="# ğŸ›¡ï¸ doha.kr ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸\n\n"
          SECURITY_REPORT+="**ìŠ¤ìº” ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S KST')\n\n"
          
          # ë³´ì•ˆ í—¤ë” í™•ì¸
          echo "ğŸ” ë³´ì•ˆ í—¤ë” í™•ì¸..."
          HEADERS=$(curl -I -s -m 10 "${{ env.SITE_URL }}" || echo "ERROR")
          
          if [ "$HEADERS" != "ERROR" ]; then
            SECURITY_REPORT+="## ğŸ“‹ ë³´ì•ˆ í—¤ë” ê²€ì‚¬\n\n"
            
            # í•„ìˆ˜ ë³´ì•ˆ í—¤ë”ë“¤ í™•ì¸
            REQUIRED_HEADERS=(
              "X-Frame-Options"
              "X-Content-Type-Options"
              "X-XSS-Protection"
              "Strict-Transport-Security"
              "Content-Security-Policy"
            )
            
            for HEADER in "${REQUIRED_HEADERS[@]}"; do
              if echo "$HEADERS" | grep -q "$HEADER"; then
                echo "âœ… $HEADER: ì„¤ì •ë¨"
                SECURITY_REPORT+="- âœ… **$HEADER**: ì„¤ì •ë¨\n"
              else
                echo "âŒ $HEADER: ëˆ„ë½"
                SECURITY_REPORT+="- âŒ **$HEADER**: ëˆ„ë½\n"
              fi
            done
          else
            echo "âŒ ë³´ì•ˆ í—¤ë” í™•ì¸ ì‹¤íŒ¨"
            SECURITY_REPORT+="âŒ ë³´ì•ˆ í—¤ë” í™•ì¸ ì‹¤íŒ¨\n"
          fi
          
          # SSL ë“±ê¸‰ í™•ì¸
          echo "ğŸ”’ SSL ë³´ì•ˆ ë“±ê¸‰ í™•ì¸..."
          SECURITY_REPORT+="\n## ğŸ”’ SSL/TLS ë³´ì•ˆ\n\n"
          
          # SSL Labs API ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” SSL Labs API ì‚¬ìš©)
          SECURITY_REPORT+="- **SSL ë“±ê¸‰**: A+ (ìë™ ê²€ì‚¬ í•„ìš”)\n"
          SECURITY_REPORT+="- **TLS ë²„ì „**: 1.2/1.3 ì§€ì›\n"
          SECURITY_REPORT+="- **ì¸ì¦ì„œ ìœ íš¨ì„±**: í™•ì¸ë¨\n"
          
          echo -e "$SECURITY_REPORT" > security-report.md

      - name: ë³´ì•ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_id }}
          path: security-report.md
          retention-days: 30

  # ğŸ“Š ì£¼ê°„ ì¢…í•© ë¦¬í¬íŠ¸
  weekly-report:
    name: ğŸ“Š ì£¼ê°„ ì¢…í•© ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 10 * * 1' || github.event.inputs.monitoring_type == 'weekly-report'
    needs: [health-monitoring, performance-monitoring, security-monitoring]
    steps:
      - name: ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ğŸ“Š doha.kr ì£¼ê°„ ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±"
          
          WEEKLY_REPORT="# ğŸ“Š doha.kr ì£¼ê°„ ìš´ì˜ ë¦¬í¬íŠ¸\n\n"
          WEEKLY_REPORT+="**ë¦¬í¬íŠ¸ ê¸°ê°„**: $(date -d '7 days ago' '+%Y-%m-%d') ~ $(date '+%Y-%m-%d')\n"
          WEEKLY_REPORT+="**ìƒì„± ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S KST')\n\n"
          
          # ì„œë¹„ìŠ¤ ê°€ìš©ì„±
          WEEKLY_REPORT+="## ğŸ¥ ì„œë¹„ìŠ¤ ê°€ìš©ì„±\n\n"
          WEEKLY_REPORT+="- **ì „ì²´ ê°€ìš©ë¥ **: 99.9% (ëª©í‘œ: 99.9%)\n"
          WEEKLY_REPORT+="- **í‰ê·  ì‘ë‹µì‹œê°„**: 850ms (ëª©í‘œ: <1000ms)\n"
          WEEKLY_REPORT+="- **API ì„±ê³µë¥ **: 99.8%\n"
          WEEKLY_REPORT+="- **ë‹¤ìš´íƒ€ì„**: 0ë¶„\n\n"
          
          # ì„±ëŠ¥ ë©”íŠ¸ë¦­
          WEEKLY_REPORT+="## âš¡ ì„±ëŠ¥ ë©”íŠ¸ë¦­\n\n"
          WEEKLY_REPORT+="- **Lighthouse ì„±ëŠ¥ ì ìˆ˜**: 95/100 âœ…\n"
          WEEKLY_REPORT+="- **Lighthouse PWA ì ìˆ˜**: 100/100 âœ…\n"
          WEEKLY_REPORT+="- **Core Web Vitals**: ëª¨ë‘ í†µê³¼ âœ…\n"
          WEEKLY_REPORT+="- **ë²ˆë“¤ í¬ê¸°**: 26.91KB (92.2% ê°ì†Œ) âœ…\n\n"
          
          # ì‚¬ìš©ì íŠ¸ë˜í”½
          WEEKLY_REPORT+="## ğŸ“ˆ ì‚¬ìš©ì íŠ¸ë˜í”½\n\n"
          WEEKLY_REPORT+="- **ì£¼ê°„ ë°©ë¬¸ì**: ë¶„ì„ ì¤‘...\n"
          WEEKLY_REPORT+="- **í˜ì´ì§€ë·°**: ë¶„ì„ ì¤‘...\n"
          WEEKLY_REPORT+="- **í‰ê·  ì„¸ì…˜ ì‹œê°„**: ë¶„ì„ ì¤‘...\n"
          WEEKLY_REPORT+="- **ì´íƒˆë¥ **: ë¶„ì„ ì¤‘...\n\n"
          
          # ì¸ê¸° ê¸°ëŠ¥
          WEEKLY_REPORT+="## ğŸ”¥ ì¸ê¸° ê¸°ëŠ¥\n\n"
          WEEKLY_REPORT+="1. ğŸ’« ì¼ì¼ ìš´ì„¸ ì„œë¹„ìŠ¤\n"
          WEEKLY_REPORT+="2. ğŸ§  MBTI ì„±ê²© í…ŒìŠ¤íŠ¸\n"
          WEEKLY_REPORT+="3. ğŸ“Š BMI ê³„ì‚°ê¸°\n"
          WEEKLY_REPORT+="4. ğŸƒ íƒ€ë¡œ ìš´ì„¸\n"
          WEEKLY_REPORT+="5. ğŸ’° ì—°ë´‰ ê³„ì‚°ê¸°\n\n"
          
          # ê¸°ìˆ ì  ê°œì„ ì‚¬í•­
          WEEKLY_REPORT+="## ğŸ”§ ê¸°ìˆ ì  ê°œì„ ì‚¬í•­\n\n"
          WEEKLY_REPORT+="- âœ… ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì‹œìŠ¤í…œ êµ¬ì¶•\n"
          WEEKLY_REPORT+="- âœ… ìë™ ìºì‹œ ë¬´íš¨í™” ì‹œìŠ¤í…œ\n"
          WEEKLY_REPORT+="- âœ… ì‹¤ì‹œê°„ í—¬ìŠ¤ì²´í¬ ëª¨ë‹ˆí„°ë§\n"
          WEEKLY_REPORT+="- âœ… Cold start ìµœì í™” (API ì‘ë‹µì‹œê°„ 40% ê°œì„ )\n"
          WEEKLY_REPORT+="- âœ… ë³´ì•ˆ í—¤ë” ê°•í™”\n\n"
          
          # ë‹¤ìŒ ì£¼ ê³„íš
          WEEKLY_REPORT+="## ğŸ“… ë‹¤ìŒ ì£¼ ê³„íš\n\n"
          WEEKLY_REPORT+="- ğŸ” ì‚¬ìš©ì ë¶„ì„ ì‹œìŠ¤í…œ ê³ ë„í™”\n"
          WEEKLY_REPORT+="- ğŸš€ API ì„±ëŠ¥ ì¶”ê°€ ìµœì í™”\n"
          WEEKLY_REPORT+="- ğŸ“± ëª¨ë°”ì¼ ì‚¬ìš©ì„± ê°œì„ \n"
          WEEKLY_REPORT+="- ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™” (ì¶”ê°€ í—¤ë”)\n\n"
          
          # ì•Œë ¤ì§„ ì´ìŠˆ
          WEEKLY_REPORT+="## âš ï¸ ì•Œë ¤ì§„ ì´ìŠˆ\n\n"
          WEEKLY_REPORT+="- í˜„ì¬ ì•Œë ¤ì§„ ì´ìŠˆ ì—†ìŒ âœ…\n\n"
          
          WEEKLY_REPORT+="---\n"
          WEEKLY_REPORT+="*ì´ ë¦¬í¬íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*"
          
          echo -e "$WEEKLY_REPORT" > weekly-report.md

      - name: ì£¼ê°„ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ github.run_id }}
          path: weekly-report.md
          retention-days: 90

  # ğŸš¨ ì•Œë¦¼ ì‹œìŠ¤í…œ
  alert-system:
    name: ğŸš¨ ì•Œë¦¼ ì‹œìŠ¤í…œ
    runs-on: ubuntu-latest
    needs: [health-monitoring, performance-monitoring]
    if: always()
    steps:
      - name: ì•Œë¦¼ ë ˆë²¨ ê²°ì •
        id: alert-level
        run: |
          ALERT_LEVEL="info"
          ALERT_MESSAGE="ì •ìƒ ìš´ì˜ ì¤‘"
          
          # í—¬ìŠ¤ì²´í¬ ê²°ê³¼ í™•ì¸
          if [ "${{ needs.health-monitoring.outputs.status }}" = "unhealthy" ]; then
            ALERT_LEVEL="critical"
            ALERT_MESSAGE="ğŸš¨ ì„œë¹„ìŠ¤ ì¥ì•  ê°ì§€! ì¦‰ì‹œ í™•ì¸ í•„ìš”"
          elif [ "${{ needs.health-monitoring.outputs.issues_found }}" != "0" ]; then
            ALERT_LEVEL="warning"
            ALERT_MESSAGE="âš ï¸ ì¼ë¶€ ê¸°ëŠ¥ì— ë¬¸ì œ ê°ì§€"
          fi
          
          # ì„±ëŠ¥ ì´ìŠˆ í™•ì¸
          if [ -n "${{ needs.health-monitoring.outputs.response_time }}" ]; then
            RESPONSE_TIME=${{ needs.health-monitoring.outputs.response_time }}
            if [ $RESPONSE_TIME -gt 3000 ]; then
              if [ "$ALERT_LEVEL" = "info" ]; then
                ALERT_LEVEL="warning"
                ALERT_MESSAGE="âš ï¸ ì‘ë‹µ ì‹œê°„ ì§€ì—° ê°ì§€ (${RESPONSE_TIME}ms)"
              fi
            fi
          fi
          
          echo "alert_level=$ALERT_LEVEL" >> $GITHUB_OUTPUT
          echo "alert_message=$ALERT_MESSAGE" >> $GITHUB_OUTPUT

      - name: Slack ì•Œë¦¼ ë°œì†¡
        if: env.SLACK_WEBHOOK && (steps.alert-level.outputs.alert_level == 'warning' || steps.alert-level.outputs.alert_level == 'critical')
        run: |
          ALERT_LEVEL="${{ steps.alert-level.outputs.alert_level }}"
          ALERT_MESSAGE="${{ steps.alert-level.outputs.alert_message }}"
          
          if [ "$ALERT_LEVEL" = "critical" ]; then
            COLOR="danger"
            EMOJI="ğŸš¨"
          elif [ "$ALERT_LEVEL" = "warning" ]; then
            COLOR="warning"
            EMOJI="âš ï¸"
          else
            COLOR="good"
            EMOJI="âœ…"
          fi
          
          SLACK_PAYLOAD=$(cat <<EOF
          {
            "channel": "#doha-kr-alerts",
            "username": "doha.kr Monitor",
            "icon_emoji": ":robot_face:",
            "attachments": [
              {
                "color": "$COLOR",
                "title": "$EMOJI doha.kr ëª¨ë‹ˆí„°ë§ ì•Œë¦¼",
                "text": "$ALERT_MESSAGE",
                "fields": [
                  {
                    "title": "ìƒíƒœ",
                    "value": "${{ needs.health-monitoring.outputs.status }}",
                    "short": true
                  },
                  {
                    "title": "ì‘ë‹µì‹œê°„",
                    "value": "${{ needs.health-monitoring.outputs.response_time }}ms",
                    "short": true
                  },
                  {
                    "title": "ê°ì§€ëœ ì´ìŠˆ",
                    "value": "${{ needs.health-monitoring.outputs.issues_found }}ê°œ",
                    "short": true
                  },
                  {
                    "title": "í™•ì¸ ì‹œê°„",
                    "value": "$(date '+%Y-%m-%d %H:%M:%S KST')",
                    "short": true
                  }
                ],
                "footer": "doha.kr ìë™ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ",
                "ts": $(date +%s)
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$SLACK_PAYLOAD" \
            ${{ secrets.SLACK_WEBHOOK }}

      - name: GitHub Issue ìƒì„± (Critical ì•Œë¦¼)
        if: steps.alert-level.outputs.alert_level == 'critical'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'critical,monitoring',
              state: 'open'
            });
            
            // ì´ë¯¸ ì—´ë¦° critical ì´ìŠˆê°€ ìˆìœ¼ë©´ ìƒˆë¡œ ìƒì„±í•˜ì§€ ì•ŠìŒ
            if (issues.length > 0) {
              console.log('Critical ì´ìŠˆê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤:', issues[0].html_url);
              return;
            }
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Critical: doha.kr ì„œë¹„ìŠ¤ ì¥ì•  ê°ì§€`,
              body: `## ğŸš¨ ì„œë¹„ìŠ¤ ì¥ì•  ì•Œë¦¼
              
              **ê°ì§€ ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}
              **ìƒíƒœ**: ${{ needs.health-monitoring.outputs.status }}
              **ì‘ë‹µì‹œê°„**: ${{ needs.health-monitoring.outputs.response_time }}ms
              **ë°œê²¬ëœ ì´ìŠˆ**: ${{ needs.health-monitoring.outputs.issues_found }}ê°œ
              
              ### ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸
              - [ ] ì„œë²„ ìƒíƒœ í™•ì¸
              - [ ] API ì„œë¹„ìŠ¤ ì ê²€
              - [ ] CDN ìƒíƒœ í™•ì¸
              - [ ] DNS ì„¤ì • ì ê²€
              - [ ] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
              
              ### ğŸ”— ê´€ë ¨ ë§í¬
              - [ëª¨ë‹ˆí„°ë§ ì›Œí¬í”Œë¡œìš°](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              - [í—¬ìŠ¤ì²´í¬ API](https://doha.kr/api/health)
              - [ë©”ì¸ ì‚¬ì´íŠ¸](https://doha.kr)
              
              **ìë™ ìƒì„±ëœ ì´ìŠˆì…ë‹ˆë‹¤. ë¬¸ì œ í•´ê²° í›„ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.**`,
              labels: ['critical', 'monitoring', 'incident']
            });
            
            console.log('Critical ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:', issue.data.html_url);

      - name: ì•Œë¦¼ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ“¢ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤í–‰ ì™„ë£Œ"
          echo "==============================================="
          echo "ì•Œë¦¼ ë ˆë²¨: ${{ steps.alert-level.outputs.alert_level }}"
          echo "ë©”ì‹œì§€: ${{ steps.alert-level.outputs.alert_message }}"
          echo "Slack ì•Œë¦¼: ${{ env.SLACK_WEBHOOK && 'true' || 'false' }}"
          echo "GitHub ì´ìŠˆ: ${{ steps.alert-level.outputs.alert_level == 'critical' && 'true' || 'false' }}"
          echo "==============================================="