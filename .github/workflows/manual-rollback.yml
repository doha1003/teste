name: ğŸ”™ ê¸´ê¸‰ ìˆ˜ë™ ë¡¤ë°±

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        type: string
      target_env:
        description: 'ë¡¤ë°±í•  í™˜ê²½'
        required: true
        default: 'blue'
        type: choice
        options:
          - blue
          - green
      skip_confirmation:
        description: 'í™•ì¸ ë‹¨ê³„ ê±´ë„ˆë›°ê¸° (ê¸´ê¸‰ì‹œì—ë§Œ ì‚¬ìš©)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '20.x'

jobs:
  # 1ï¸âƒ£ ì‚¬ì „ í™•ì¸
  pre-rollback-check:
    name: ğŸ” ë¡¤ë°± ì‚¬ì „ í™•ì¸
    runs-on: ubuntu-latest
    outputs:
      current-env: ${{ steps.check-env.outputs.current }}
      target-env: ${{ github.event.inputs.target_env }}
      can-rollback: ${{ steps.check-env.outputs.can-rollback }}
    steps:
      - name: í˜„ì¬ í™˜ê²½ ìƒíƒœ í™•ì¸
        id: check-env
        run: |
          echo "ğŸ” í˜„ì¬ í”„ë¡œë•ì…˜ í™˜ê²½ ìƒíƒœ í™•ì¸..."
          
          # í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸
          CURRENT_RESPONSE=$(curl -s -f -m 10 "https://doha.kr/api/health" || echo "none")
          
          if echo "$CURRENT_RESPONSE" | grep -q "blue"; then
            echo "current=blue" >> $GITHUB_OUTPUT
            echo "ğŸ“ í˜„ì¬ í™˜ê²½: Blue"
          elif echo "$CURRENT_RESPONSE" | grep -q "green"; then
            echo "current=green" >> $GITHUB_OUTPUT
            echo "ğŸ“ í˜„ì¬ í™˜ê²½: Green"
          else
            echo "current=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ í˜„ì¬ í™˜ê²½ì„ í™•ì¸í•  ìˆ˜ ì—†ìŒ"
          fi
          
          # ë¡¤ë°± ê°€ëŠ¥ì„± í™•ì¸
          TARGET_ENV="${{ github.event.inputs.target_env }}"
          CURRENT_ENV=$(echo "$GITHUB_OUTPUT" | grep current= | cut -d= -f2)
          
          if [ "$TARGET_ENV" != "$CURRENT_ENV" ]; then
            echo "can-rollback=true" >> $GITHUB_OUTPUT
            echo "âœ… ë¡¤ë°± ê°€ëŠ¥: $CURRENT_ENV â†’ $TARGET_ENV"
          else
            echo "can-rollback=false" >> $GITHUB_OUTPUT
            echo "âŒ ë¡¤ë°± ë¶ˆê°€ëŠ¥: í˜„ì¬ì™€ ë™ì¼í•œ í™˜ê²½"
            exit 1
          fi

      - name: ë¡¤ë°± ì‚¬ìœ  ê¸°ë¡
        run: |
          echo "ğŸ“ ë¡¤ë°± ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo "ğŸ‘¤ ìš”ì²­ì: ${{ github.actor }}"
          echo "â° ìš”ì²­ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC"

  # 2ï¸âƒ£ ë¡¤ë°± í™•ì¸ (ê±´ë„ˆë›°ê¸° ê°€ëŠ¥)
  rollback-confirmation:
    name: âš ï¸ ë¡¤ë°± í™•ì¸
    runs-on: ubuntu-latest
    needs: pre-rollback-check
    if: github.event.inputs.skip_confirmation != 'true' && needs.pre-rollback-check.outputs.can-rollback == 'true'
    steps:
      - name: ë¡¤ë°± ì˜í–¥ ë¶„ì„
        run: |
          echo "âš ï¸ ìˆ˜ë™ ë¡¤ë°± ì˜í–¥ ë¶„ì„"
          echo "================================"
          echo "í˜„ì¬ í™˜ê²½: ${{ needs.pre-rollback-check.outputs.current-env }}"
          echo "íƒ€ê²Ÿ í™˜ê²½: ${{ needs.pre-rollback-check.outputs.target-env }}"
          echo "ë¡¤ë°± ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo ""
          echo "ğŸ“‹ ì˜ˆìƒ ì˜í–¥:"
          echo "â€¢ ì‚¬ìš©ìëŠ” ì¼ì‹œì ìœ¼ë¡œ ì´ì „ ë²„ì „ ê²½í—˜"
          echo "â€¢ CDN ìºì‹œ ë¬´íš¨í™”ë¡œ ì¸í•œ ì¼ì‹œì  ì„±ëŠ¥ ì €í•˜"
          echo "â€¢ ëª¨ë‹ˆí„°ë§ ë° ë¡œê·¸ ì‹œìŠ¤í…œì— ë¡¤ë°± ê¸°ë¡"
          echo ""
          echo "â³ 30ì´ˆ ëŒ€ê¸° í›„ ìë™ ì§„í–‰..."
          sleep 30

  # 3ï¸âƒ£ DNS íŠ¸ë˜í”½ ì „í™˜
  execute-rollback:
    name: ğŸ”™ ë¡¤ë°± ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, rollback-confirmation]
    if: |
      always() && 
      needs.pre-rollback-check.outputs.can-rollback == 'true' && 
      (needs.rollback-confirmation.result == 'success' || github.event.inputs.skip_confirmation == 'true')
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: DNS íŠ¸ë˜í”½ ì „í™˜ ì‹œì‘
        run: |
          echo "ğŸ”„ DNS íŠ¸ë˜í”½ ì „í™˜ ì‹œì‘"
          echo "í˜„ì¬ í™˜ê²½: ${{ needs.pre-rollback-check.outputs.current-env }}"
          echo "íƒ€ê²Ÿ í™˜ê²½: ${{ needs.pre-rollback-check.outputs.target-env }}"
          
          # ì‹¤ì œ DNS ì „í™˜ì€ Cloudflare APIë¥¼ í†µí•´ ìˆ˜í–‰
          # ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë§Œ ì¶œë ¥ (ì‹¤ì œ êµ¬í˜„ì‹œ DNS API í˜¸ì¶œ í•„ìš”)
          echo "ğŸ“¡ Cloudflare DNS ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ í•„ìš”"

      - name: CDN ìºì‹œ ë¬´íš¨í™”
        run: |
          echo "ğŸ—‘ï¸ CDN ìºì‹œ ë¬´íš¨í™”"
          
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "ğŸŒ Cloudflare ìºì‹œ í¼ì§€ ì‹¤í–‰..."
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' || echo "âš ï¸ CDN ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨"
            echo "âœ… CDN ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"
          else
            echo "âš ï¸ Cloudflare API í† í°ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          fi

      - name: ë¡¤ë°± ì™„ë£Œ ëŒ€ê¸°
        run: |
          echo "â³ ë¡¤ë°± ì „í™˜ ì™„ë£Œ ëŒ€ê¸°..."
          sleep 60

  # 4ï¸âƒ£ ë¡¤ë°± ê²€ì¦
  verify-rollback:
    name: âœ… ë¡¤ë°± ê²€ì¦
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, execute-rollback]
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ë¡¤ë°± í™˜ê²½ í™•ì¸
        run: |
          echo "ğŸ” ë¡¤ë°± í™˜ê²½ í™•ì¸..."
          
          # ìµœëŒ€ 10íšŒ ì¬ì‹œë„ë¡œ í™˜ê²½ í™•ì¸
          for i in {1..10}; do
            CURRENT_RESPONSE=$(curl -s -f -m 10 "https://doha.kr/api/health" || echo "none")
            
            if echo "$CURRENT_RESPONSE" | grep -q "${{ needs.pre-rollback-check.outputs.target-env }}"; then
              echo "âœ… ë¡¤ë°± ì„±ê³µ: ${{ needs.pre-rollback-check.outputs.target-env }} í™˜ê²½ í™œì„±í™” (ì‹œë„ $i)"
              break
            elif [ $i -eq 10 ]; then
              echo "âŒ ë¡¤ë°± ê²€ì¦ ì‹¤íŒ¨: 10íšŒ ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨"
              exit 1
            else
              echo "âš ï¸ ë¡¤ë°± í™˜ê²½ í™•ì¸ ì¤‘... (ì‹œë„ $i/10)"
              sleep 30
            fi
          done

      - name: ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ§ª ë¡¤ë°± í›„ ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸..."
          
          # ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼ í™•ì¸
          curl -f -L -m 30 https://doha.kr -o /dev/null || (echo "âŒ ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼ ì‹¤íŒ¨" && exit 1)
          echo "âœ… ë©”ì¸ í˜ì´ì§€ ì ‘ê·¼ ì„±ê³µ"
          
          # API ê¸°ë³¸ ê¸°ëŠ¥ í™•ì¸
          curl -f -L -m 15 https://doha.kr/api/health -o /dev/null || (echo "âŒ API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨" && exit 1)
          echo "âœ… API í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
          
          # ì£¼ìš” ì •ì  ë¦¬ì†ŒìŠ¤ í™•ì¸
          curl -f -L -m 15 https://doha.kr/js/main.js -o /dev/null || echo "âš ï¸ JavaScript íŒŒì¼ í™•ì¸ í•„ìš”"
          curl -f -L -m 15 https://doha.kr/manifest.json -o /dev/null || echo "âš ï¸ PWA manifest í™•ì¸ í•„ìš”"
          
          echo "âœ… ë¡¤ë°± í›„ ê¸°ë³¸ ê¸°ëŠ¥ í™•ì¸ ì™„ë£Œ"

  # 5ï¸âƒ£ ë¡¤ë°± ì•Œë¦¼
  rollback-notification:
    name: ğŸ“¢ ë¡¤ë°± ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [pre-rollback-check, execute-rollback, verify-rollback]
    if: always()
    steps:
      - name: ë¡¤ë°± ì„±ê³µ ì•Œë¦¼
        if: needs.verify-rollback.result == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "âœ… ìˆ˜ë™ ë¡¤ë°± ì„±ê³µ ì•Œë¦¼"
          
          SUCCESS_MESSAGE="âœ… doha.kr ìˆ˜ë™ ë¡¤ë°± ì„±ê³µ
          
          ğŸ“‹ ë¡¤ë°± ì •ë³´:
          â€¢ ìš”ì²­ì: ${{ github.actor }}
          â€¢ ë¡¤ë°± ì‚¬ìœ : ${{ github.event.inputs.reason }}
          â€¢ ì´ì „ í™˜ê²½: ${{ needs.pre-rollback-check.outputs.current-env }}
          â€¢ í˜„ì¬ í™˜ê²½: ${{ needs.pre-rollback-check.outputs.target-env }}
          â€¢ ë¡¤ë°± ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          âœ… ê²€ì¦ ì™„ë£Œ:
          â€¢ í™˜ê²½ ì „í™˜ í™•ì¸
          â€¢ ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ í†µê³¼
          â€¢ CDN ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ
          
          ğŸŒ ì‚¬ì´íŠ¸ ìƒíƒœ: https://doha.kr
          ğŸ“Š ì›Œí¬í”Œë¡œìš°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Slack ì•Œë¦¼
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$SUCCESS_MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL"
          fi
          
          # Discord ì•Œë¦¼
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$SUCCESS_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL"
          fi

      - name: ë¡¤ë°± ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "âŒ ìˆ˜ë™ ë¡¤ë°± ì‹¤íŒ¨ ì•Œë¦¼"
          
          FAILURE_MESSAGE="âŒ doha.kr ìˆ˜ë™ ë¡¤ë°± ì‹¤íŒ¨
          
          ğŸš¨ ê¸´ê¸‰ ìƒí™©: ìˆ˜ë™ ë¡¤ë°± ì‹œë„ ì‹¤íŒ¨
          
          ğŸ“‹ ì‹¤íŒ¨ ì •ë³´:
          â€¢ ìš”ì²­ì: ${{ github.actor }}
          â€¢ ë¡¤ë°± ì‚¬ìœ : ${{ github.event.inputs.reason }}
          â€¢ ì‹œë„ í™˜ê²½: ${{ needs.pre-rollback-check.outputs.target-env }}
          â€¢ ì‹¤íŒ¨ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          ğŸš¨ ì¦‰ì‹œ í•„ìš”í•œ ì¡°ì¹˜:
          1. í˜„ì¬ ì‚¬ì´íŠ¸ ìƒíƒœ ê¸´ê¸‰ ì ê²€
          2. ì¸í”„ë¼ íŒ€ ì¦‰ì‹œ í˜¸ì¶œ
          3. DNS ì„¤ì • ìˆ˜ë™ í™•ì¸
          4. ì„œë²„ ìƒíƒœ ì ê²€
          
          ğŸ“Š ì‹¤íŒ¨ ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # ê¸´ê¸‰ ì•Œë¦¼
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$FAILURE_MESSAGE\", \"channel\": \"#alerts\", \"username\": \"GitHub Actions - ROLLBACK FAILURE\"}" \
              "$SLACK_WEBHOOK_URL"
          fi
          
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$FAILURE_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL"
          fi

      - name: ì´ìŠˆ ìƒì„± (ë¡¤ë°± ì‹¤íŒ¨ì‹œ)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ ê¸´ê¸‰: ìˆ˜ë™ ë¡¤ë°± ì‹¤íŒ¨ - ${new Date().toISOString()}`;
            const body = `## ğŸš¨ ê¸´ê¸‰ ìƒí™©: ìˆ˜ë™ ë¡¤ë°± ì‹¤íŒ¨
            
            **ë¡¤ë°± ì •ë³´:**
            - ìš”ì²­ì: ${{ github.actor }}
            - ë¡¤ë°± ì‚¬ìœ : ${{ github.event.inputs.reason }}
            - ì‹œë„ ì‹œê°„: ${new Date().toISOString()}
            - ì›Œí¬í”Œë¡œìš°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            **ì¦‰ì‹œ í•„ìš”í•œ ì¡°ì¹˜:**
            - [ ] í˜„ì¬ ì‚¬ì´íŠ¸ ìƒíƒœ ì ê²€
            - [ ] DNS ì„¤ì • ìˆ˜ë™ í™•ì¸
            - [ ] ì¸í”„ë¼ íŒ€ í˜¸ì¶œ
            - [ ] ì„œë²„ ë¡œê·¸ ë¶„ì„
            - [ ] ì‚¬ìš©ì ì˜í–¥ ë²”ìœ„ íŒŒì•…
            
            **ë‹´ë‹¹ì:** ì¸í”„ë¼ íŒ€ ì „ì²´
            **ìš°ì„ ìˆœìœ„:** P0 (ìµœê³  ìš°ì„ ìˆœìœ„)
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['emergency', 'rollback-failure', 'P0']
            });