name: ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/security-*.yml'
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
  pull-requests: write
  checks: write
  statuses: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: v1

jobs:
  # 1ï¸âƒ£ ë³€ê²½ì‚¬í•­ ê°ì§€ ë° ì‚¬ì „ ê²€ì¦
  detect-changes:
    name: ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„
    runs-on: ubuntu-latest
    outputs:
      has-code-changes: ${{ steps.changes.outputs.code }}
      has-css-changes: ${{ steps.changes.outputs.css }}
      has-js-changes: ${{ steps.changes.outputs.js }}
      has-api-changes: ${{ steps.changes.outputs.api }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            code:
              - 'js/**'
              - 'css/**'
              - '*.html'
              - 'api/**'
            css:
              - 'css/**'
            js:
              - 'js/**'
            api:
              - 'api/**'

      - name: ë°°í¬ í•„ìš”ì„± íŒë‹¨
        id: deploy-check
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # 2ï¸âƒ£ ë¹Œë“œ ë° ìµœì í™”
  build:
    name: ğŸ—ï¸ ë¹Œë“œ & ìµœì í™”
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      build-cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ìºì‹œ í‚¤ ìƒì„±
        id: cache-key
        run: |
          echo "key=build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('css/**', 'js/**') }}" >> $GITHUB_OUTPUT

      - name: ë¹Œë“œ ìºì‹œ í™•ì¸
        uses: actions/cache@v3
        id: build-cache
        with:
          path: |
            dist/
            .next/cache
            node_modules/.cache
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            build-${{ runner.os }}-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: CSS ë¹Œë“œ
        if: needs.detect-changes.outputs.has-css-changes == 'true' || steps.build-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ¨ CSS ë²ˆë“¤ë§ ì‹œì‘..."
          npm run build:css
          echo "âœ… CSS ë¹Œë“œ ì™„ë£Œ"

      - name: JavaScript ë¹Œë“œ
        if: needs.detect-changes.outputs.has-js-changes == 'true' || steps.build-cache.outputs.cache-hit != 'true'
        run: |
          echo "âš¡ JavaScript ë²ˆë“¤ë§ ì‹œì‘..."
          npm run build:js
          echo "âœ… JavaScript ë¹Œë“œ ì™„ë£Œ"

      - name: ì´ë¯¸ì§€ ìµœì í™”
        run: |
          echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ìµœì í™” ì‹œì‘..."
          npm run optimize:images
          echo "âœ… ì´ë¯¸ì§€ ìµœì í™” ì™„ë£Œ"

      - name: PWA ë¹Œë“œ
        run: |
          echo "ğŸ“± PWA ì„¤ì • ë¹Œë“œ..."
          if [ -f "build-pwa.cjs" ]; then
            npm run build:pwa
            echo "âœ… PWA ë¹Œë“œ ì™„ë£Œ"
          else
            echo "âš ï¸ PWA ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ - ê¸°ë³¸ ê²€ì¦ë§Œ ìˆ˜í–‰"
            # í•„ìˆ˜ PWA íŒŒì¼ í™•ì¸
            if [ ! -f "manifest.json" ]; then
              echo "âŒ manifest.json íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤"
              exit 1
            fi
            if [ ! -f "sw.js" ]; then
              echo "âŒ sw.js íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤"
              exit 1
            fi
            echo "âœ… PWA ê¸°ë³¸ íŒŒì¼ í™•ì¸ ì™„ë£Œ"
          fi

      - name: ë²ˆë“¤ í¬ê¸° ë¶„ì„
        run: |
          echo "ğŸ“¦ ë²ˆë“¤ í¬ê¸° ë¶„ì„..."
          if [ -f js/main.js ]; then
            MAIN_SIZE=$(stat -c%s "js/main.js")
            echo "main.js: $(($MAIN_SIZE / 1024))KB"
          fi
          npm run build:js:analyze
          echo "âœ… ë²ˆë“¤ ë¶„ì„ ì™„ë£Œ"

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            dist/
            js/
            css/
            sw.js
            manifest.json
          retention-days: 7
          compression-level: 6

  # 3ï¸âƒ£ í’ˆì§ˆ ê²€ì¦
  quality-check:
    name: ğŸ” í’ˆì§ˆ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix:
        check-type: ['lint', 'format', 'security']
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ë¦°íŒ… ê²€ì‚¬
        if: matrix.check-type == 'lint'
        run: |
          echo "ğŸ” ESLint ê²€ì‚¬..."
          npm run lint
          echo "âœ… ë¦°íŒ… ê²€ì‚¬ í†µê³¼"

      - name: í¬ë§·íŒ… ê²€ì‚¬
        if: matrix.check-type == 'format'
        run: |
          echo "ğŸ’… Prettier í¬ë§·íŒ… ê²€ì‚¬..."
          npm run format:check
          echo "âœ… í¬ë§·íŒ… ê²€ì‚¬ í†µê³¼"

      - name: ë³´ì•ˆ ê²€ì‚¬
        if: matrix.check-type == 'security'
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬..."
          npm audit --audit-level=moderate
          echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼"

  # 4ï¸âƒ£ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix:
        test-type: ['unit', 'integration', 'e2e']
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'unit'
        run: |
          echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run test:unit
          echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: í†µí•© í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'integration'
        run: |
          echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run test:integration
          echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: Playwright ì„¤ì¹˜
        if: matrix.test-type == 'e2e'
        run: npx playwright install --with-deps

      - name: E2E í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'e2e'
        run: |
          echo "ğŸ­ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run test:e2e
          echo "âœ… E2E í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}-${{ github.sha }}
          path: |
            test-results/
            playwright-report/
            coverage/
          retention-days: 7

  # 5ï¸âƒ£ ì„±ëŠ¥ ë° ì ‘ê·¼ì„± ê²€ì‚¬
  lighthouse:
    name: ğŸš¦ Lighthouse ê°ì‚¬
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.has-code-changes == 'true'
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ë¡œì»¬ ì„œë²„ ì‹œì‘
        run: |
          python -m http.server 3000 &
          sleep 5
          echo "âœ… ë¡œì»¬ ì„œë²„ ì‹œì‘ë¨"

      - name: Lighthouse CI ì‹¤í–‰
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/fortune/daily/
            http://localhost:3000/tests/mbti/
            http://localhost:3000/tools/bmi-calculator.html
          budgetPath: ./.github/lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ì„±ëŠ¥ ê²°ê³¼ ë¶„ì„
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼:"
          echo "- ë©”ì¸ í˜ì´ì§€ âœ…"
          echo "- ìš´ì„¸ í˜ì´ì§€ âœ…"
          echo "- MBTI í…ŒìŠ¤íŠ¸ âœ…"
          echo "- BMI ê³„ì‚°ê¸° âœ…"

  # 6ï¸âƒ£ ìŠ¤í…Œì´ì§• ë°°í¬ (PRìš©)
  deploy-preview:
    name: ğŸ­ ë¯¸ë¦¬ë³´ê¸° ë°°í¬
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.should-deploy == 'true'
    environment:
      name: preview-${{ github.event.number }}
      url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: Vercel ë¯¸ë¦¬ë³´ê¸° ë°°í¬
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./

      - name: PR ëŒ“ê¸€ ì—…ë°ì´íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ­ ë¯¸ë¦¬ë³´ê¸° ë°°í¬')
            );
            
            const body = `## ğŸ­ ë¯¸ë¦¬ë³´ê¸° ë°°í¬ ì™„ë£Œ
            
            **ë°°í¬ URL**: ${{ steps.deploy.outputs.preview-url }}
            
            ### ğŸ“‹ í™•ì¸ì‚¬í•­
            - [ ] ë©”ì¸ í˜ì´ì§€ ë™ì‘ í™•ì¸
            - [ ] ìš´ì„¸/í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ í™•ì¸
            - [ ] ëª¨ë°”ì¼ ë°˜ì‘í˜• í™•ì¸
            - [ ] í•œê¸€ í°íŠ¸ ë Œë”ë§ í™•ì¸
            
            *ìë™ ìƒì„±ëœ ë¯¸ë¦¬ë³´ê¸°ì…ë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§ˆë‹¤ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # 7ï¸âƒ£ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì¤€ë¹„
  prepare-blue-green:
    name: ğŸ”„ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check, test, lighthouse]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    outputs:
      current-env: ${{ steps.determine-env.outputs.current }}
      target-env: ${{ steps.determine-env.outputs.target }}
      blue-url: ${{ steps.determine-env.outputs.blue-url }}
      green-url: ${{ steps.determine-env.outputs.green-url }}
    steps:
      - name: í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸
        id: determine-env
        run: |
          # í˜„ì¬ í”„ë¡œë•ì…˜ì´ ì–´ëŠ í™˜ê²½ì¸ì§€ í™•ì¸
          CURRENT_RESPONSE=$(curl -s -f -m 10 "https://doha.kr/api/health" || echo "none")
          
          if echo "$CURRENT_RESPONSE" | grep -q "blue"; then
            echo "current=blue" >> $GITHUB_OUTPUT
            echo "target=green" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha.kr" >> $GITHUB_OUTPUT
            echo "green-url=https://doha-green.vercel.app" >> $GITHUB_OUTPUT
          elif echo "$CURRENT_RESPONSE" | grep -q "green"; then
            echo "current=green" >> $GITHUB_OUTPUT
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha-blue.vercel.app" >> $GITHUB_OUTPUT
            echo "green-url=https://doha.kr" >> $GITHUB_OUTPUT
          else
            # ì²« ë°°í¬ ë˜ëŠ” ê°ì§€ ì‹¤íŒ¨ì‹œ blueë¡œ ì„¤ì •
            echo "current=none" >> $GITHUB_OUTPUT
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha-blue.vercel.app" >> $GITHUB_OUTPUT
            echo "green-url=https://doha-green.vercel.app" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ” í˜„ì¬ í™˜ê²½: $(cat $GITHUB_OUTPUT | grep current= | cut -d= -f2)"
          echo "ğŸ¯ íƒ€ê²Ÿ í™˜ê²½: $(cat $GITHUB_OUTPUT | grep target= | cut -d= -f2)"

  # 8ï¸âƒ£ íƒ€ê²Ÿ í™˜ê²½ ë°°í¬
  deploy-target-environment:
    name: ğŸš€ íƒ€ê²Ÿ í™˜ê²½ ë°°í¬
    runs-on: ubuntu-latest
    needs: prepare-blue-green
    environment:
      name: production-${{ needs.prepare-blue-green.outputs.target-env }}
      url: ${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: GitHub Pages ì„¤ì •
        uses: actions/configure-pages@v4

      - name: ë°°í¬ìš© íŒŒì¼ ì¤€ë¹„
        run: |
          echo "ğŸ“¦ ë°°í¬ìš© íŒŒì¼ ì •ë¦¬..."
          # ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
          rm -rf node_modules src tests .github
          rm -f package*.json tsconfig.json *.config.js
          echo "âœ… íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

      - name: GitHub Pages ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: íƒ€ê²Ÿ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DEPLOY_ENV=${{ needs.prepare-blue-green.outputs.target-env }}" >> $GITHUB_ENV
          echo "TARGET_URL=${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}" >> $GITHUB_ENV

      - name: GitHub Pages ë°°í¬ (ì •ì  ìì‚°)
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Vercel íƒ€ê²Ÿ í™˜ê²½ ë°°í¬
        id: vercel-deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod --meta deployEnv=${{ needs.prepare-blue-green.outputs.target-env }}'
          working-directory: ./

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ${{ needs.prepare-blue-green.outputs.target-env }} í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ GitHub Pages: ${{ steps.deployment.outputs.page_url }}"
          echo "âš¡ Vercel URL: ${{ steps.vercel-deploy.outputs.preview-url }}"
          echo "ğŸ¯ íƒ€ê²Ÿ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸ“Š ëª¨ë“  í’ˆì§ˆ ê²€ì‚¬ í†µê³¼"

  # 9ï¸âƒ£ íƒ€ê²Ÿ í™˜ê²½ ê²€ì¦
  verify-target-environment:
    name: âœ… íƒ€ê²Ÿ í™˜ê²½ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [prepare-blue-green, deploy-target-environment]
    outputs:
      health-check: ${{ steps.health.outputs.status }}
      performance-check: ${{ steps.performance.outputs.status }}
      functional-check: ${{ steps.functional.outputs.status }}
    steps:
      - name: ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        run: |
          echo "â³ íƒ€ê²Ÿ í™˜ê²½ ë°°í¬ ì™„ë£Œ ëŒ€ê¸°..."
          sleep 30

      - name: í—¬ìŠ¤ì²´í¬
        id: health
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "ğŸ¥ íƒ€ê²Ÿ í™˜ê²½ í—¬ìŠ¤ì²´í¬: $TARGET_URL"
          
          # í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ë¡œì§
          for i in {1..5}; do
            if curl -f -s -m 10 "$TARGET_URL/api/health" > /dev/null; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
              break
            elif [ $i -eq 5 ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (5íšŒ ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨)"
              exit 1
            else
              echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5), 20ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 20
            fi
          done

      - name: ì„±ëŠ¥ ê²€ì¦
        id: performance
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "âš¡ ì„±ëŠ¥ ê²€ì¦: $TARGET_URL"
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 10 "$TARGET_URL")
          echo "ì‘ë‹µ ì‹œê°„: ${RESPONSE_TIME}ì´ˆ"
          
          # ì„±ëŠ¥ ê¸°ì¤€ í™•ì¸ (3ì´ˆ ì´í•˜)
          if (( $(echo "$RESPONSE_TIME <= 3.0" | bc -l) )); then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… ì„±ëŠ¥ ê²€ì¦ í†µê³¼"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì„±ëŠ¥ ê²½ê³ : ì‘ë‹µì‹œê°„ ${RESPONSE_TIME}ì´ˆ"
          fi

      - name: ê¸°ëŠ¥ ê²€ì¦
        id: functional
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "ğŸ” ê¸°ëŠ¥ ê²€ì¦: $TARGET_URL"
          
          # ì£¼ìš” í˜ì´ì§€ í™•ì¸
          PAGES=("" "/fortune/daily/" "/tests/mbti/" "/tools/bmi-calculator.html")
          
          for PAGE in "${PAGES[@]}"; do
            if curl -f -s -m 10 "$TARGET_URL$PAGE" > /dev/null; then
              echo "âœ… $PAGE í˜ì´ì§€ ì •ìƒ"
            else
              echo "âŒ $PAGE í˜ì´ì§€ ì˜¤ë¥˜"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          done
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… ëª¨ë“  ê¸°ëŠ¥ ê²€ì¦ í†µê³¼"

  # ğŸ”Ÿ íŠ¸ë˜í”½ ì „í™˜ (Blue-Green Switch)
  switch-traffic:
    name: ğŸ”„ íŠ¸ë˜í”½ ì „í™˜
    runs-on: ubuntu-latest
    needs: [prepare-blue-green, verify-target-environment]
    if: |
      needs.verify-target-environment.outputs.health-check == 'success' &&
      needs.verify-target-environment.outputs.functional-check == 'success'
    environment:
      name: production
      url: https://doha.kr
    steps:
      - name: DNS íŠ¸ë˜í”½ ì „í™˜ í™•ì¸
        run: |
          echo "ğŸ”„ DNS íŠ¸ë˜í”½ ì „í™˜ ì‹œì‘"
          echo "í˜„ì¬ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.current-env }}"
          echo "íƒ€ê²Ÿ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸ“¡ Cloudflare DNS ì—…ë°ì´íŠ¸ í•„ìš”"
          
      - name: CDN ìºì‹œ ë¬´íš¨í™”
        run: |
          echo "ğŸ—‘ï¸ CDN ìºì‹œ ë¬´íš¨í™” ì‹œì‘"
          # Cloudflare APIë¥¼ í†µí•œ ìºì‹œ í¼ì§€
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' || echo "âš ï¸ CDN ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨"
            echo "âœ… CDN ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"
          else
            echo "âš ï¸ Cloudflare API í† í°ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          fi

      - name: íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ
        run: |
          echo "ğŸ‰ íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
          echo "ğŸŒ í™œì„± í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸš€ ìƒˆ ë²„ì „ì´ í”„ë¡œë•ì…˜ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"

  # 1ï¸âƒ£1ï¸âƒ£ ìµœì¢… ê²€ì¦
  post-deploy-verification:
    name: âœ… ìµœì¢… ê²€ì¦
    runs-on: ubuntu-latest
    needs: [switch-traffic, prepare-blue-green]
    if: always() && needs.switch-traffic.result == 'success'
    steps:
      - name: ë°°í¬ ëŒ€ê¸°
        run: |
          echo "â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          sleep 60

      - name: í”„ë¡œë•ì…˜ ì‚¬ì´íŠ¸ ìµœì¢… í™•ì¸
        run: |
          echo "ğŸŒ í”„ë¡œë•ì…˜ ì‚¬ì´íŠ¸ ìµœì¢… í™•ì¸..."
          # ë©”ì¸ ë„ë©”ì¸ í™•ì¸
          curl -f -L https://doha.kr -o /dev/null || (echo "âŒ ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ì‹¤íŒ¨" && exit 1)
          curl -f -L https://doha.kr/api/health -o /dev/null || echo "âš ï¸ API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          
          # ìƒˆ í™˜ê²½ì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
          RESPONSE=$(curl -s https://doha.kr/api/health)
          if echo "$RESPONSE" | grep -q "${{ needs.prepare-blue-green.outputs.target-env }}"; then
            echo "âœ… ìƒˆ í™˜ê²½(${{ needs.prepare-blue-green.outputs.target-env }})ì´ í™œì„±í™”ë¨"
          else
            echo "âš ï¸ í™˜ê²½ ì „í™˜ í™•ì¸ í•„ìš”"
          fi
          echo "âœ… ì‚¬ì´íŠ¸ ìµœì¢… í™•ì¸ ì™„ë£Œ"

      - name: ì£¼ìš” ê¸°ëŠ¥ ê²€ì¦
        run: |
          echo "ğŸ” ì£¼ìš” ê¸°ëŠ¥ ê²€ì¦..."
          # ì •ì  ë¦¬ì†ŒìŠ¤ í™•ì¸
          curl -f -L https://doha.kr/js/main.js -o /dev/null || (echo "âŒ main.js ë¡œë“œ ì‹¤íŒ¨" && exit 1)
          curl -f -L https://doha.kr/css/main.css -o /dev/null || echo "âš ï¸ CSS ë¡œë“œ í™•ì¸ í•„ìš”"
          curl -f -L https://doha.kr/manifest.json -o /dev/null || (echo "âŒ PWA manifest ì‹¤íŒ¨" && exit 1)
          echo "âœ… ì£¼ìš” ë¦¬ì†ŒìŠ¤ ë¡œë“œ í™•ì¸"

      - name: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§..."
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://doha.kr)
          echo "ì‘ë‹µ ì‹œê°„: ${RESPONSE_TIME}ì´ˆ"
          
          # 3ì´ˆ ì´í•˜ ì‘ë‹µ ì‹œê°„ í™•ì¸
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "âš ï¸ ì‘ë‹µ ì‹œê°„ì´ 3ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          else
            echo "âœ… ì‘ë‹µ ì‹œê°„ ì–‘í˜¸"
          fi

      - name: SEO ë° ë©”íƒ€íƒœê·¸ í™•ì¸
        run: |
          echo "ğŸ” SEO ë©”íƒ€íƒœê·¸ í™•ì¸..."
          CONTENT=$(curl -s https://doha.kr)
          if echo "$CONTENT" | grep -q "doha.kr"; then
            echo "âœ… íƒ€ì´í‹€ íƒœê·¸ í™•ì¸"
          else
            echo "âš ï¸ íƒ€ì´í‹€ íƒœê·¸ í™•ì¸ í•„ìš”"
          fi

  # 1ï¸âƒ£2ï¸âƒ£ ë¡¤ë°± ëŒ€ê¸°
  rollback-standby:
    name: ğŸ”™ ë¡¤ë°± ëŒ€ê¸°
    runs-on: ubuntu-latest
    needs: [switch-traffic, prepare-blue-green, post-deploy-verification]
    if: failure() || needs.post-deploy-verification.result == 'failure'
    steps:
      - name: ë¡¤ë°± ì¤€ë¹„
        run: |
          echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ê°ì§€! ë¡¤ë°± ì¤€ë¹„ ì¤‘..."
          echo "ì´ì „ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.current-env }}"
          echo "ì‹¤íŒ¨í•œ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          
      - name: ìë™ ë¡¤ë°± ì‹¤í–‰
        run: |
          echo "ğŸ”™ ìë™ ë¡¤ë°± ì‹¤í–‰"
          # ì´ì „ í™˜ê²½ìœ¼ë¡œ DNS ë˜ëŒë¦¬ê¸°
          echo "ğŸ“¡ DNSë¥¼ ì´ì „ í™˜ê²½ìœ¼ë¡œ ë³µì›"
          
          # CDN ìºì‹œ ë¬´íš¨í™”
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
            echo "âœ… ë¡¤ë°±ìš© CDN ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"
          fi
          
          echo "âœ… ë¡¤ë°± ì™„ë£Œ - ì´ì „ í™˜ê²½ìœ¼ë¡œ ë³µì›ë¨"

  # 1ï¸âƒ£3ï¸âƒ£ ë°°í¬ ì•Œë¦¼
  notify:
    name: ğŸ“¢ ë°°í¬ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [post-deploy-verification, switch-traffic, prepare-blue-green, rollback-standby]
    if: always()
    steps:
      - name: ì„±ê³µ ì•Œë¦¼
        if: needs.post-deploy-verification.result == 'success' && needs.switch-traffic.result == 'success'
        run: |
          echo "ğŸ‰ doha.kr ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì„±ê³µ!"
          echo "âœ… ëª¨ë“  ê²€ì¦ ë‹¨ê³„ í†µê³¼"
          echo "ğŸŒ ì‚¬ì´íŠ¸: https://doha.kr"
          echo "ğŸ”„ í™œì„± í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ"
          echo "ğŸ“± PWA ì§€ì› í™œì„±í™”"
          echo "âš¡ ì„±ëŠ¥ ìµœì í™” ì™„ë£Œ"
          echo "ğŸ›¡ï¸ ëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ í†µê³¼"

      - name: ë¡¤ë°± ì•Œë¦¼
        if: needs.rollback-standby.result == 'success'
        run: |
          echo "ğŸ”™ ìë™ ë¡¤ë°± ì™„ë£Œ"
          echo "âš ï¸ ë°°í¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ì—¬ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ğŸ” ë°°í¬ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
          echo "ğŸŒ í˜„ì¬ í™œì„± í™˜ê²½: ${{ needs.prepare-blue-green.outputs.current-env }}"

      - name: ì‹¤íŒ¨ ì•Œë¦¼
        if: failure() && needs.rollback-standby.result != 'success'
        run: |
          echo "âŒ ë°°í¬ ë° ë¡¤ë°± ì‹¤íŒ¨"
          echo "ğŸš¨ ê¸´ê¸‰ ìƒí™©: ìˆ˜ë™ ê°œì…ì´ í•„ìš”í•©ë‹ˆë‹¤"
          echo "ğŸ” ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"
          echo "ğŸ“ ê°œë°œíŒ€ì— ì¦‰ì‹œ ë¬¸ì˜í•´ì£¼ì„¸ìš”"
          echo "ğŸŒ í˜„ì¬ ì‚¬ì´íŠ¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"