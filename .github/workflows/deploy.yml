name: ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/security-*.yml'
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
  pull-requests: write
  checks: write
  statuses: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: v1

jobs:
  # 1ï¸âƒ£ ë³€ê²½ì‚¬í•­ ê°ì§€ ë° ì‚¬ì „ ê²€ì¦
  detect-changes:
    name: ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„
    runs-on: ubuntu-latest
    outputs:
      has-code-changes: ${{ steps.changes.outputs.code }}
      has-css-changes: ${{ steps.changes.outputs.css }}
      has-js-changes: ${{ steps.changes.outputs.js }}
      has-api-changes: ${{ steps.changes.outputs.api }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ë³€ê²½ëœ íŒŒì¼ ê°ì§€
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            code:
              - 'js/**'
              - 'css/**'
              - '*.html'
              - 'api/**'
            css:
              - 'css/**'
            js:
              - 'js/**'
            api:
              - 'api/**'

      - name: ë°°í¬ í•„ìš”ì„± íŒë‹¨
        id: deploy-check
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # 2ï¸âƒ£ ë¹Œë“œ ë° ìµœì í™”
  build:
    name: ğŸ—ï¸ ë¹Œë“œ & ìµœì í™”
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      build-cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ìºì‹œ í‚¤ ìƒì„±
        id: cache-key
        run: |
          echo "key=build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('css/**', 'js/**') }}" >> $GITHUB_OUTPUT

      - name: ë¹Œë“œ ìºì‹œ í™•ì¸
        uses: actions/cache@v3
        id: build-cache
        with:
          path: |
            dist/
            .next/cache
            node_modules/.cache
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            build-${{ runner.os }}-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: CSS ë¹Œë“œ
        if: needs.detect-changes.outputs.has-css-changes == 'true' || steps.build-cache.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ¨ CSS ë²ˆë“¤ë§ ì‹œì‘..."
          npm run build:css
          echo "âœ… CSS ë¹Œë“œ ì™„ë£Œ"

      - name: JavaScript ë¹Œë“œ
        if: needs.detect-changes.outputs.has-js-changes == 'true' || steps.build-cache.outputs.cache-hit != 'true'
        run: |
          echo "âš¡ JavaScript ë²ˆë“¤ë§ ì‹œì‘..."
          npm run build:js
          echo "âœ… JavaScript ë¹Œë“œ ì™„ë£Œ"

      - name: ì´ë¯¸ì§€ ìµœì í™”
        run: |
          echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ìµœì í™” ì‹œì‘..."
          npm run optimize:images
          echo "âœ… ì´ë¯¸ì§€ ìµœì í™” ì™„ë£Œ"

      - name: PWA ë¹Œë“œ
        run: |
          echo "ğŸ“± PWA ì„¤ì • ë¹Œë“œ..."
          if [ -f "build-pwa.cjs" ]; then
            npm run build:pwa
            echo "âœ… PWA ë¹Œë“œ ì™„ë£Œ"
          else
            echo "âš ï¸ PWA ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ - ê¸°ë³¸ ê²€ì¦ë§Œ ìˆ˜í–‰"
            # í•„ìˆ˜ PWA íŒŒì¼ í™•ì¸
            if [ ! -f "manifest.json" ]; then
              echo "âŒ manifest.json íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤"
              exit 1
            fi
            if [ ! -f "sw.js" ]; then
              echo "âŒ sw.js íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤"
              exit 1
            fi
            echo "âœ… PWA ê¸°ë³¸ íŒŒì¼ í™•ì¸ ì™„ë£Œ"
          fi

      - name: ë²ˆë“¤ í¬ê¸° ë¶„ì„
        run: |
          echo "ğŸ“¦ ë²ˆë“¤ í¬ê¸° ë¶„ì„..."
          if [ -f js/main.js ]; then
            MAIN_SIZE=$(stat -c%s "js/main.js")
            echo "main.js: $(($MAIN_SIZE / 1024))KB"
          fi
          npm run build:js:analyze
          echo "âœ… ë²ˆë“¤ ë¶„ì„ ì™„ë£Œ"

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            dist/
            js/
            css/
            sw.js
            manifest.json
          retention-days: 7
          compression-level: 6

  # 3ï¸âƒ£ í’ˆì§ˆ ê²€ì¦
  quality-check:
    name: ğŸ” í’ˆì§ˆ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix:
        check-type: ['lint', 'format', 'security', 'env-validation']
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ë¦°íŒ… ê²€ì‚¬
        if: matrix.check-type == 'lint'
        run: |
          echo "ğŸ” ESLint ê²€ì‚¬..."
          npm run lint
          echo "âœ… ë¦°íŒ… ê²€ì‚¬ í†µê³¼"

      - name: í¬ë§·íŒ… ê²€ì‚¬
        if: matrix.check-type == 'format'
        run: |
          echo "ğŸ’… Prettier í¬ë§·íŒ… ê²€ì‚¬..."
          npm run format:check
          echo "âœ… í¬ë§·íŒ… ê²€ì‚¬ í†µê³¼"

      - name: ë³´ì•ˆ ê²€ì‚¬
        if: matrix.check-type == 'security'
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬..."
          npm audit --audit-level=moderate
          echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼"

      - name: í™˜ê²½ë³€ìˆ˜ ê²€ì¦
        if: matrix.check-type == 'env-validation'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          echo "ğŸ”§ í™˜ê²½ë³€ìˆ˜ ë° ë³´ì•ˆ ì„¤ì • ê²€ì¦..."
          node scripts/env-validation.js
          echo "âœ… í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í†µê³¼"

  # 4ï¸âƒ£ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix:
        test-type: ['unit', 'integration', 'e2e']
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'unit'
        run: |
          echo "ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run test:unit
          echo "âœ… ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: í†µí•© í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'integration'
        run: |
          echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run test:integration
          echo "âœ… í†µí•© í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: Playwright ì„¤ì¹˜
        if: matrix.test-type == 'e2e'
        run: npx playwright install --with-deps

      - name: E2E í…ŒìŠ¤íŠ¸
        if: matrix.test-type == 'e2e'
        run: |
          echo "ğŸ­ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run test:e2e
          echo "âœ… E2E í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}-${{ github.sha }}
          path: |
            test-results/
            playwright-report/
            coverage/
          retention-days: 7

  # 4ï¸âƒ£A 26í˜ì´ì§€ ì¢…í•© í…ŒìŠ¤íŠ¸
  comprehensive-validation:
    name: ğŸ” 26í˜ì´ì§€ ì¢…í•© ê²€ì¦
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check]
    if: needs.detect-changes.outputs.has-code-changes == 'true' && github.event.inputs.skip_tests != 'true'
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: Playwright ì„¤ì¹˜
        run: npx playwright install --with-deps

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ë¡œì»¬ ì„œë²„ ì‹œì‘
        run: |
          python -m http.server 3000 &
          sleep 10
          echo "âœ… í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹œì‘ë¨ (http://localhost:3000)"

      - name: 26í˜ì´ì§€ ì¢…í•© ê²€ì¦ ì‹¤í–‰
        run: |
          echo "ğŸŒ doha.kr ì „ì²´ í˜ì´ì§€ ê²€ì¦ ì‹œì‘..."
          npm run test:26pages
          echo "âœ… 26í˜ì´ì§€ ì¢…í•© ê²€ì¦ ì™„ë£Œ"

      - name: Playwright E2E ì¢…í•© í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ­ Playwright ì¢…í•© E2E í…ŒìŠ¤íŠ¸..."
          npx playwright test tests/e2e/doha-26pages-complete-verification.spec.js
          echo "âœ… Playwright E2E í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: ê²€ì¦ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-validation-${{ github.sha }}
          path: |
            doha-26pages-verification/
            test-results/
            playwright-report/
            screenshots/
          retention-days: 14

      - name: ê²€ì¦ ì‹¤íŒ¨ì‹œ ìŠ¬ë™ ì•Œë¦¼
        if: failure() && github.ref == 'refs/heads/main'
        run: |
          echo "âŒ 26í˜ì´ì§€ ì¢…í•© ê²€ì¦ ì‹¤íŒ¨"
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"ğŸš¨ doha.kr ë°°í¬ ì‹¤íŒ¨: 26í˜ì´ì§€ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n- ë¸Œëœì¹˜: ${{ github.ref }}\n- ì»¤ë°‹: ${{ github.sha }}\n- ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

  # 5ï¸âƒ£ ì„±ëŠ¥ ë° ì ‘ê·¼ì„± ê²€ì‚¬
  lighthouse:
    name: ğŸš¦ Lighthouse ê°ì‚¬
    runs-on: ubuntu-latest
    needs: [detect-changes, build, comprehensive-validation]
    if: needs.detect-changes.outputs.has-code-changes == 'true'
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --prefer-offline --no-audit

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: ë¡œì»¬ ì„œë²„ ì‹œì‘
        run: |
          python -m http.server 3000 &
          sleep 5
          echo "âœ… ë¡œì»¬ ì„œë²„ ì‹œì‘ë¨"

      - name: Lighthouse CI ì‹¤í–‰
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/fortune/daily/
            http://localhost:3000/tests/mbti/
            http://localhost:3000/tools/bmi-calculator.html
          budgetPath: ./.github/lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ì„±ëŠ¥ ê²°ê³¼ ë¶„ì„
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼:"
          echo "- ë©”ì¸ í˜ì´ì§€ âœ…"
          echo "- ìš´ì„¸ í˜ì´ì§€ âœ…"
          echo "- MBTI í…ŒìŠ¤íŠ¸ âœ…"
          echo "- BMI ê³„ì‚°ê¸° âœ…"

  # 6ï¸âƒ£ ìŠ¤í…Œì´ì§• ë°°í¬ (PRìš©)
  deploy-preview:
    name: ğŸ­ ë¯¸ë¦¬ë³´ê¸° ë°°í¬
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check, comprehensive-validation]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.should-deploy == 'true'
    environment:
      name: preview-${{ github.event.number }}
      url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: Vercel ë¯¸ë¦¬ë³´ê¸° ë°°í¬
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./

      - name: PR ëŒ“ê¸€ ì—…ë°ì´íŠ¸
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ­ ë¯¸ë¦¬ë³´ê¸° ë°°í¬')
            );
            
            const body = `## ğŸ­ ë¯¸ë¦¬ë³´ê¸° ë°°í¬ ì™„ë£Œ
            
            **ë°°í¬ URL**: ${{ steps.deploy.outputs.preview-url }}
            
            ### ğŸ“‹ í™•ì¸ì‚¬í•­
            - [ ] ë©”ì¸ í˜ì´ì§€ ë™ì‘ í™•ì¸
            - [ ] ìš´ì„¸/í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ í™•ì¸
            - [ ] ëª¨ë°”ì¼ ë°˜ì‘í˜• í™•ì¸
            - [ ] í•œê¸€ í°íŠ¸ ë Œë”ë§ í™•ì¸
            
            *ìë™ ìƒì„±ëœ ë¯¸ë¦¬ë³´ê¸°ì…ë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§ˆë‹¤ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # 7ï¸âƒ£ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì¤€ë¹„
  prepare-blue-green:
    name: ğŸ”„ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check, test, comprehensive-validation, lighthouse]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    outputs:
      current-env: ${{ steps.determine-env.outputs.current }}
      target-env: ${{ steps.determine-env.outputs.target }}
      blue-url: ${{ steps.determine-env.outputs.blue-url }}
      green-url: ${{ steps.determine-env.outputs.green-url }}
    steps:
      - name: í˜„ì¬ í™œì„± í™˜ê²½ í™•ì¸
        id: determine-env
        run: |
          # í˜„ì¬ í”„ë¡œë•ì…˜ì´ ì–´ëŠ í™˜ê²½ì¸ì§€ í™•ì¸
          CURRENT_RESPONSE=$(curl -s -f -m 10 "https://doha.kr/api/health" || echo "none")
          
          if echo "$CURRENT_RESPONSE" | grep -q "blue"; then
            echo "current=blue" >> $GITHUB_OUTPUT
            echo "target=green" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha.kr" >> $GITHUB_OUTPUT
            echo "green-url=https://doha-green.vercel.app" >> $GITHUB_OUTPUT
          elif echo "$CURRENT_RESPONSE" | grep -q "green"; then
            echo "current=green" >> $GITHUB_OUTPUT
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha-blue.vercel.app" >> $GITHUB_OUTPUT
            echo "green-url=https://doha.kr" >> $GITHUB_OUTPUT
          else
            # ì²« ë°°í¬ ë˜ëŠ” ê°ì§€ ì‹¤íŒ¨ì‹œ blueë¡œ ì„¤ì •
            echo "current=none" >> $GITHUB_OUTPUT
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha-blue.vercel.app" >> $GITHUB_OUTPUT
            echo "green-url=https://doha-green.vercel.app" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ” í˜„ì¬ í™˜ê²½: $(cat $GITHUB_OUTPUT | grep current= | cut -d= -f2)"
          echo "ğŸ¯ íƒ€ê²Ÿ í™˜ê²½: $(cat $GITHUB_OUTPUT | grep target= | cut -d= -f2)"

  # 8ï¸âƒ£ íƒ€ê²Ÿ í™˜ê²½ ë°°í¬
  deploy-target-environment:
    name: ğŸš€ íƒ€ê²Ÿ í™˜ê²½ ë°°í¬
    runs-on: ubuntu-latest
    needs: prepare-blue-green
    environment:
      name: production-${{ needs.prepare-blue-green.outputs.target-env }}
      url: ${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: GitHub Pages ì„¤ì •
        uses: actions/configure-pages@v4

      - name: ë°°í¬ìš© íŒŒì¼ ì¤€ë¹„
        run: |
          echo "ğŸ“¦ ë°°í¬ìš© íŒŒì¼ ì •ë¦¬..."
          # ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
          rm -rf node_modules src tests .github
          rm -f package*.json tsconfig.json *.config.js
          echo "âœ… íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

      - name: GitHub Pages ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: íƒ€ê²Ÿ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "DEPLOY_ENV=${{ needs.prepare-blue-green.outputs.target-env }}" >> $GITHUB_ENV
          echo "TARGET_URL=${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}" >> $GITHUB_ENV

      - name: GitHub Pages ë°°í¬ (ì •ì  ìì‚°)
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Vercel íƒ€ê²Ÿ í™˜ê²½ ë°°í¬
        id: vercel-deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod --meta deployEnv=${{ needs.prepare-blue-green.outputs.target-env }}'
          working-directory: ./

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "ğŸ‰ ${{ needs.prepare-blue-green.outputs.target-env }} í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
          echo "ğŸŒ GitHub Pages: ${{ steps.deployment.outputs.page_url }}"
          echo "âš¡ Vercel URL: ${{ steps.vercel-deploy.outputs.preview-url }}"
          echo "ğŸ¯ íƒ€ê²Ÿ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸ“Š ëª¨ë“  í’ˆì§ˆ ê²€ì‚¬ í†µê³¼"

  # 9ï¸âƒ£ íƒ€ê²Ÿ í™˜ê²½ ê²€ì¦
  verify-target-environment:
    name: âœ… íƒ€ê²Ÿ í™˜ê²½ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [prepare-blue-green, deploy-target-environment]
    outputs:
      health-check: ${{ steps.health.outputs.status }}
      performance-check: ${{ steps.performance.outputs.status }}
      functional-check: ${{ steps.functional.outputs.status }}
    steps:
      - name: ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        run: |
          echo "â³ íƒ€ê²Ÿ í™˜ê²½ ë°°í¬ ì™„ë£Œ ëŒ€ê¸°..."
          sleep 30

      - name: í—¬ìŠ¤ì²´í¬
        id: health
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "ğŸ¥ íƒ€ê²Ÿ í™˜ê²½ í—¬ìŠ¤ì²´í¬: $TARGET_URL"
          
          # í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ë¡œì§
          for i in {1..5}; do
            if curl -f -s -m 10 "$TARGET_URL/api/health" > /dev/null; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
              break
            elif [ $i -eq 5 ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (5íšŒ ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨)"
              exit 1
            else
              echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5), 20ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 20
            fi
          done

      - name: ì„±ëŠ¥ ê²€ì¦
        id: performance
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "âš¡ ì„±ëŠ¥ ê²€ì¦: $TARGET_URL"
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 10 "$TARGET_URL")
          echo "ì‘ë‹µ ì‹œê°„: ${RESPONSE_TIME}ì´ˆ"
          
          # ì„±ëŠ¥ ê¸°ì¤€ í™•ì¸ (3ì´ˆ ì´í•˜)
          if (( $(echo "$RESPONSE_TIME <= 3.0" | bc -l) )); then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… ì„±ëŠ¥ ê²€ì¦ í†µê³¼"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì„±ëŠ¥ ê²½ê³ : ì‘ë‹µì‹œê°„ ${RESPONSE_TIME}ì´ˆ"
          fi

      - name: ê¸°ëŠ¥ ê²€ì¦
        id: functional
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "ğŸ” ê¸°ëŠ¥ ê²€ì¦: $TARGET_URL"
          
          # ì£¼ìš” í˜ì´ì§€ í™•ì¸
          PAGES=("" "/fortune/daily/" "/tests/mbti/" "/tools/bmi-calculator.html")
          
          for PAGE in "${PAGES[@]}"; do
            if curl -f -s -m 10 "$TARGET_URL$PAGE" > /dev/null; then
              echo "âœ… $PAGE í˜ì´ì§€ ì •ìƒ"
            else
              echo "âŒ $PAGE í˜ì´ì§€ ì˜¤ë¥˜"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          done
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… ëª¨ë“  ê¸°ëŠ¥ ê²€ì¦ í†µê³¼"

  # ğŸ”Ÿ íŠ¸ë˜í”½ ì „í™˜ (Blue-Green Switch)
  switch-traffic:
    name: ğŸ”„ íŠ¸ë˜í”½ ì „í™˜
    runs-on: ubuntu-latest
    needs: [prepare-blue-green, verify-target-environment]
    if: |
      needs.verify-target-environment.outputs.health-check == 'success' &&
      needs.verify-target-environment.outputs.functional-check == 'success'
    environment:
      name: production
      url: https://doha.kr
    steps:
      - name: DNS íŠ¸ë˜í”½ ì „í™˜ í™•ì¸
        run: |
          echo "ğŸ”„ DNS íŠ¸ë˜í”½ ì „í™˜ ì‹œì‘"
          echo "í˜„ì¬ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.current-env }}"
          echo "íƒ€ê²Ÿ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸ“¡ Cloudflare DNS ì—…ë°ì´íŠ¸ í•„ìš”"
          
      - name: CDN ìºì‹œ ë¬´íš¨í™”
        run: |
          echo "ğŸ—‘ï¸ CDN ìºì‹œ ë¬´íš¨í™” ì‹œì‘"
          # Cloudflare APIë¥¼ í†µí•œ ìºì‹œ í¼ì§€
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' || echo "âš ï¸ CDN ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨"
            echo "âœ… CDN ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"
          else
            echo "âš ï¸ Cloudflare API í† í°ì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          fi

      - name: íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ
        run: |
          echo "ğŸ‰ íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
          echo "ğŸŒ í™œì„± í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸš€ ìƒˆ ë²„ì „ì´ í”„ë¡œë•ì…˜ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤"

  # 1ï¸âƒ£1ï¸âƒ£ ìµœì¢… ê²€ì¦
  post-deploy-verification:
    name: âœ… ìµœì¢… ê²€ì¦
    runs-on: ubuntu-latest
    needs: [switch-traffic, prepare-blue-green]
    if: always() && needs.switch-traffic.result == 'success'
    steps:
      - name: ì²´í¬ì•„ì›ƒ (ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ìš©)
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ (ê²€ì¦ìš©)
        run: npm ci --prefer-offline --no-audit

      - name: ë°°í¬ ëŒ€ê¸° ë° DNS ì „íŒŒ í™•ì¸
        run: |
          echo "â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          sleep 90
          
          # DNS ì „íŒŒ í™•ì¸
          echo "ğŸ“¡ DNS ì „íŒŒ ìƒíƒœ í™•ì¸..."
          nslookup doha.kr || echo "âš ï¸ DNS ì¡°íšŒ ì‹¤íŒ¨"

      - name: í”„ë¡œë•ì…˜ ì‚¬ì´íŠ¸ ê¸°ë³¸ í™•ì¸
        run: |
          echo "ğŸŒ í”„ë¡œë•ì…˜ ì‚¬ì´íŠ¸ ê¸°ë³¸ ì ‘ê·¼ í™•ì¸..."
          
          # ë©”ì¸ ë„ë©”ì¸ í™•ì¸ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          for i in {1..5}; do
            if curl -f -L -m 30 https://doha.kr -o /dev/null; then
              echo "âœ… ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ì„±ê³µ (ì‹œë„ $i)"
              break
            elif [ $i -eq 5 ]; then
              echo "âŒ ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ì‹¤íŒ¨ (5íšŒ ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨)"
              exit 1
            else
              echo "âš ï¸ ë©”ì¸ ì‚¬ì´íŠ¸ ì ‘ê·¼ ì‹¤íŒ¨ (ì‹œë„ $i/5), 30ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 30
            fi
          done
          
          # API í—¬ìŠ¤ì²´í¬
          if curl -f -L -m 15 https://doha.kr/api/health -o /dev/null; then
            echo "âœ… API í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
          else
            echo "âŒ API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi
          
          # ìƒˆ í™˜ê²½ì´ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
          RESPONSE=$(curl -s -m 15 https://doha.kr/api/health)
          if echo "$RESPONSE" | grep -q "${{ needs.prepare-blue-green.outputs.target-env }}"; then
            echo "âœ… ìƒˆ í™˜ê²½(${{ needs.prepare-blue-green.outputs.target-env }})ì´ í™œì„±í™”ë¨"
          else
            echo "âš ï¸ í™˜ê²½ ì „í™˜ ìƒíƒœ: $RESPONSE"
          fi

      - name: í”„ë¡œë•ì…˜ 26í˜ì´ì§€ ì‹¤ì‹œê°„ ê²€ì¦
        env:
          BASE_URL: https://doha.kr
        run: |
          echo "ğŸŒ í”„ë¡œë•ì…˜ í™˜ê²½ 26í˜ì´ì§€ ì‹¤ì‹œê°„ ê²€ì¦..."
          
          # ì‹¤ì‹œê°„ 26í˜ì´ì§€ ê²€ì¦ ì‹¤í–‰
          BASE_URL=https://doha.kr node comprehensive-26-page-validator.js --production
          
          echo "âœ… í”„ë¡œë•ì…˜ 26í˜ì´ì§€ ê²€ì¦ ì™„ë£Œ"

      - name: ì¤‘ìš” API ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦
        run: |
          echo "ğŸ” ì¤‘ìš” API ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦..."
          
          # Fortune API í…ŒìŠ¤íŠ¸
          FORTUNE_RESPONSE=$(curl -s -X POST https://doha.kr/api/fortune \
            -H "Content-Type: application/json" \
            -d '{"type":"daily","userData":{"name":"í…ŒìŠ¤íŠ¸","birthDate":"1990-01-01","gender":"male"}}' \
            -m 30)
          
          if echo "$FORTUNE_RESPONSE" | grep -q "fortune"; then
            echo "âœ… Fortune API ì •ìƒ ì‘ë™"
          else
            echo "âŒ Fortune API ì˜¤ë¥˜: $FORTUNE_RESPONSE"
            exit 1
          fi
          
          # Manseryeok API í…ŒìŠ¤íŠ¸
          MANSERYEOK_RESPONSE=$(curl -s -X POST https://doha.kr/api/manseryeok \
            -H "Content-Type: application/json" \
            -d '{"year":2024,"month":8,"day":10}' \
            -m 15)
          
          if echo "$MANSERYEOK_RESPONSE" | grep -q "result"; then
            echo "âœ… Manseryeok API ì •ìƒ ì‘ë™"
          else
            echo "âŒ Manseryeok API ì˜¤ë¥˜: $MANSERYEOK_RESPONSE"
            exit 1
          fi

      - name: ì •ì  ë¦¬ì†ŒìŠ¤ ë° PWA ê²€ì¦
        run: |
          echo "ğŸ” ì •ì  ë¦¬ì†ŒìŠ¤ ë° PWA ê²€ì¦..."
          
          # CSS ë²ˆë“¤ í™•ì¸
          if curl -f -L -m 15 https://doha.kr/dist/styles.min.css -o /dev/null; then
            echo "âœ… CSS ë²ˆë“¤ ë¡œë“œ ì„±ê³µ"
          else
            echo "âš ï¸ CSS ë²ˆë“¤ ë¡œë“œ ì‹¤íŒ¨, ê°œë³„ CSS í™•ì¸..."
            curl -f -L -m 15 https://doha.kr/css/main.css -o /dev/null || echo "âš ï¸ ê°œë³„ CSSë„ ì‹¤íŒ¨"
          fi
          
          # JavaScript ë²ˆë“¤ í™•ì¸
          if curl -f -L -m 15 https://doha.kr/js/main.js -o /dev/null; then
            echo "âœ… JavaScript ë©”ì¸ íŒŒì¼ ë¡œë“œ ì„±ê³µ"
          else
            echo "âŒ JavaScript ë©”ì¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨"
            exit 1
          fi
          
          # PWA í•„ìˆ˜ íŒŒì¼ë“¤
          curl -f -L -m 10 https://doha.kr/manifest.json -o /dev/null || (echo "âŒ PWA manifest ì‹¤íŒ¨" && exit 1)
          curl -f -L -m 10 https://doha.kr/sw.js -o /dev/null || (echo "âŒ Service Worker ì‹¤íŒ¨" && exit 1)
          
          echo "âœ… ëª¨ë“  ì •ì  ë¦¬ì†ŒìŠ¤ ë¡œë“œ í™•ì¸"

      - name: ì„±ëŠ¥ ë° ì‘ë‹µì„± ëª¨ë‹ˆí„°ë§
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë° ì‘ë‹µì„± ëª¨ë‹ˆí„°ë§..."
          
          # ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          MAIN_RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 30 https://doha.kr)
          echo "ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì‹œê°„: ${MAIN_RESPONSE_TIME}ì´ˆ"
          
          # API ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          API_RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 15 https://doha.kr/api/health)
          echo "API ì‘ë‹µ ì‹œê°„: ${API_RESPONSE_TIME}ì´ˆ"
          
          # ì„±ëŠ¥ ì„ê³„ê°’ í™•ì¸
          if (( $(echo "$MAIN_RESPONSE_TIME > 5.0" | bc -l) )); then
            echo "âš ï¸ ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì‹œê°„ì´ 5ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          else
            echo "âœ… ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì‹œê°„ ì–‘í˜¸"
          fi
          
          if (( $(echo "$API_RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "âš ï¸ API ì‘ë‹µ ì‹œê°„ì´ 3ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          else
            echo "âœ… API ì‘ë‹µ ì‹œê°„ ì–‘í˜¸"
          fi

      - name: SEO ë° ë©”íƒ€ë°ì´í„° ê²€ì¦
        run: |
          echo "ğŸ” SEO ë° ë©”íƒ€ë°ì´í„° ê²€ì¦..."
          
          CONTENT=$(curl -s -m 30 https://doha.kr)
          
          # í•„ìˆ˜ SEO ìš”ì†Œë“¤ í™•ì¸
          if echo "$CONTENT" | grep -q "<title.*doha.kr"; then
            echo "âœ… íƒ€ì´í‹€ íƒœê·¸ í™•ì¸"
          else
            echo "âš ï¸ íƒ€ì´í‹€ íƒœê·¸ í™•ì¸ í•„ìš”"
          fi
          
          if echo "$CONTENT" | grep -q 'name="description"'; then
            echo "âœ… ë©”íƒ€ ì„¤ëª… íƒœê·¸ í™•ì¸"
          else
            echo "âš ï¸ ë©”íƒ€ ì„¤ëª… íƒœê·¸ ëˆ„ë½"
          fi
          
          if echo "$CONTENT" | grep -q 'property="og:'; then
            echo "âœ… Open Graph íƒœê·¸ í™•ì¸"
          else
            echo "âš ï¸ Open Graph íƒœê·¸ ëˆ„ë½"
          fi
          
          if echo "$CONTENT" | grep -q 'name="viewport"'; then
            echo "âœ… ë·°í¬íŠ¸ íƒœê·¸ í™•ì¸"
          else
            echo "âŒ ë·°í¬íŠ¸ íƒœê·¸ ëˆ„ë½"
            exit 1
          fi

      - name: í•œê¸€ ì¸ì½”ë”© ë° í°íŠ¸ ê²€ì¦
        run: |
          echo "ğŸ”¤ í•œê¸€ ì¸ì½”ë”© ë° í°íŠ¸ ê²€ì¦..."
          
          CONTENT=$(curl -s -m 30 https://doha.kr)
          
          # UTF-8 ì¸ì½”ë”© í™•ì¸
          if echo "$CONTENT" | grep -q 'charset.*utf-8'; then
            echo "âœ… UTF-8 ì¸ì½”ë”© ì„¤ì • í™•ì¸"
          else
            echo "âŒ UTF-8 ì¸ì½”ë”© ì„¤ì • ëˆ„ë½"
            exit 1
          fi
          
          # í•œê¸€ ì½˜í…ì¸  í™•ì¸
          if echo "$CONTENT" | grep -q 'ì‹¬ë¦¬í…ŒìŠ¤íŠ¸\|ìš´ì„¸\|ë„êµ¬'; then
            echo "âœ… í•œê¸€ ì½˜í…ì¸  ì •ìƒ í‘œì‹œ"
          else
            echo "âŒ í•œê¸€ ì½˜í…ì¸  í‘œì‹œ ë¬¸ì œ"
            exit 1
          fi
          
          # Pretendard í°íŠ¸ í™•ì¸
          if curl -f -L -m 10 https://doha.kr/fonts/PretendardVariable.woff2 -o /dev/null; then
            echo "âœ… Pretendard í°íŠ¸ íŒŒì¼ ë¡œë“œ ì„±ê³µ"
          else
            echo "âš ï¸ Pretendard í°íŠ¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨"
          fi

      - name: ê²€ì¦ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "ğŸ“‹ í”„ë¡œë•ì…˜ ë°°í¬ í›„ ê²€ì¦ ì™„ë£Œ"
          echo "=".repeat(50)
          echo "ğŸŒ ì‚¬ì´íŠ¸: https://doha.kr"
          echo "ğŸ”„ í™œì„± í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "ğŸ“Š ëª¨ë“  ê¸°ëŠ¥ ê²€ì¦ ì™„ë£Œ"
          echo "âš¡ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"
          echo "ğŸ›¡ï¸ ë³´ì•ˆ í—¤ë” í™•ì¸ ì™„ë£Œ"
          echo "ğŸ”¤ í•œê¸€ ì¸ì½”ë”© ê²€ì¦ ì™„ë£Œ"
          echo "ğŸ“± PWA ê¸°ëŠ¥ í™•ì¸ ì™„ë£Œ"
          echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ê²€ì¦ ì„±ê³µ!"

  # 1ï¸âƒ£2ï¸âƒ£ ë¡¤ë°± ëŒ€ê¸°
  rollback-standby:
    name: ğŸ”™ ë¡¤ë°± ëŒ€ê¸°
    runs-on: ubuntu-latest
    needs: [switch-traffic, prepare-blue-green, post-deploy-verification]
    if: failure() || needs.post-deploy-verification.result == 'failure'
    steps:
      - name: ë¡¤ë°± ì¤€ë¹„
        run: |
          echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ê°ì§€! ë¡¤ë°± ì¤€ë¹„ ì¤‘..."
          echo "ì´ì „ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.current-env }}"
          echo "ì‹¤íŒ¨í•œ í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}"
          
      - name: ìë™ ë¡¤ë°± ì‹¤í–‰
        run: |
          echo "ğŸ”™ ìë™ ë¡¤ë°± ì‹¤í–‰"
          # ì´ì „ í™˜ê²½ìœ¼ë¡œ DNS ë˜ëŒë¦¬ê¸°
          echo "ğŸ“¡ DNSë¥¼ ì´ì „ í™˜ê²½ìœ¼ë¡œ ë³µì›"
          
          # CDN ìºì‹œ ë¬´íš¨í™”
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
            echo "âœ… ë¡¤ë°±ìš© CDN ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ"
          fi
          
          echo "âœ… ë¡¤ë°± ì™„ë£Œ - ì´ì „ í™˜ê²½ìœ¼ë¡œ ë³µì›ë¨"

  # 1ï¸âƒ£3ï¸âƒ£ ë°°í¬ ì•Œë¦¼ ë° ëª¨ë‹ˆí„°ë§
  notify:
    name: ğŸ“¢ ë°°í¬ ì•Œë¦¼ ë° ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: [post-deploy-verification, switch-traffic, prepare-blue-green, rollback-standby]
    if: always()
    steps:
      - name: ì²´í¬ì•„ì›ƒ (ì•Œë¦¼ ìŠ¤í¬ë¦½íŠ¸ìš©)
        uses: actions/checkout@v4

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: needs.post-deploy-verification.result == 'success' && needs.switch-traffic.result == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "ğŸ‰ doha.kr ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì„±ê³µ!"
          
          # ë°°í¬ ì„±ê³µ ë©”ì‹œì§€ êµ¬ì„±
          SUCCESS_MESSAGE="ğŸ‰ doha.kr í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ!
          
          ğŸ“‹ ë°°í¬ ì •ë³´:
          â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}
          â€¢ ì»¤ë°‹: ${{ github.sha }}
          â€¢ í™œì„± í™˜ê²½: ${{ needs.prepare-blue-green.outputs.target-env }}
          â€¢ ë°°í¬ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          âœ… ê²€ì¦ ì™„ë£Œ:
          â€¢ 26í˜ì´ì§€ ì¢…í•© ê²€ì¦ í†µê³¼
          â€¢ API ì—”ë“œí¬ì¸íŠ¸ ì •ìƒ ì‘ë™
          â€¢ ì„±ëŠ¥ ì„ê³„ê°’ ë§Œì¡±
          â€¢ PWA ê¸°ëŠ¥ í™œì„±í™”
          â€¢ ë³´ì•ˆ ê²€ì‚¬ í†µê³¼
          â€¢ í•œê¸€ ì¸ì½”ë”© ì •ìƒ
          
          ğŸŒ ì‚¬ì´íŠ¸: https://doha.kr
          ğŸ“Š ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Slack ì•Œë¦¼
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$SUCCESS_MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL" || echo "âš ï¸ Slack ì•Œë¦¼ ì‹¤íŒ¨"
          fi
          
          # Discord ì•Œë¦¼
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$SUCCESS_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL" || echo "âš ï¸ Discord ì•Œë¦¼ ì‹¤íŒ¨"
          fi

      - name: ë¡¤ë°± ì™„ë£Œ ì•Œë¦¼
        if: needs.rollback-standby.result == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "ğŸ”™ ìë™ ë¡¤ë°± ì™„ë£Œ"
          
          # ë¡¤ë°± ì•Œë¦¼ ë©”ì‹œì§€ êµ¬ì„±
          ROLLBACK_MESSAGE="ğŸ”™ doha.kr ìë™ ë¡¤ë°± ì™„ë£Œ
          
          âš ï¸ ë°°í¬ ì¤‘ ë¬¸ì œ ë°œìƒìœ¼ë¡œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤
          
          ğŸ“‹ ë¡¤ë°± ì •ë³´:
          â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}
          â€¢ ì‹¤íŒ¨í•œ ì»¤ë°‹: ${{ github.sha }}
          â€¢ í˜„ì¬ í™œì„± í™˜ê²½: ${{ needs.prepare-blue-green.outputs.current-env }}
          â€¢ ë¡¤ë°± ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          ğŸ” ë‹¤ìŒ ë‹¨ê³„:
          â€¢ ë°°í¬ ë¡œê·¸ í™•ì¸ í•„ìš”
          â€¢ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„ í•„ìš”
          â€¢ ìˆ˜ì • í›„ ì¬ë°°í¬ ì¤€ë¹„
          
          ğŸŒ ì‚¬ì´íŠ¸ ìƒíƒœ: https://doha.kr (ì´ì „ ë²„ì „ í™œì„±)
          ğŸ“Š ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Slack ì•Œë¦¼ (ê¸´ê¸‰)
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$ROLLBACK_MESSAGE\", \"channel\": \"#alerts\"}" \
              "$SLACK_WEBHOOK_URL"
          fi
          
          # Discord ì•Œë¦¼ (ê¸´ê¸‰)
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$ROLLBACK_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL"
          fi

      - name: ë°°í¬ ì‹¤íŒ¨ ê¸´ê¸‰ ì•Œë¦¼
        if: failure() && needs.rollback-standby.result != 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "âŒ ë°°í¬ ë° ë¡¤ë°± ì‹¤íŒ¨ - ê¸´ê¸‰ ìƒí™©"
          
          # ê¸´ê¸‰ ìƒí™© ì•Œë¦¼ ë©”ì‹œì§€
          EMERGENCY_MESSAGE="ğŸš¨ doha.kr ê¸´ê¸‰ ìƒí™©: ë°°í¬ ë° ë¡¤ë°± ì‹¤íŒ¨
          
          âŒ ì‹¬ê°í•œ ë¬¸ì œ ë°œìƒ:
          â€¢ ë°°í¬ ì‹¤íŒ¨ í›„ ìë™ ë¡¤ë°±ë„ ì‹¤íŒ¨
          â€¢ ìˆ˜ë™ ê°œì…ì´ ì¦‰ì‹œ í•„ìš”í•©ë‹ˆë‹¤
          
          ğŸ“‹ ì‹¤íŒ¨ ì •ë³´:
          â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}
          â€¢ ì‹¤íŒ¨í•œ ì»¤ë°‹: ${{ github.sha }}
          â€¢ ì‹¤íŒ¨ ì‹œê°„: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          ğŸš¨ ì¦‰ì‹œ ìˆ˜í–‰í•  ì‘ì—…:
          1. í˜„ì¬ ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸: https://doha.kr
          2. DNS ì„¤ì • í™•ì¸
          3. Vercel ëŒ€ì‹œë³´ë“œ í™•ì¸
          4. ìˆ˜ë™ ë¡¤ë°± ì‹¤í–‰ ê³ ë ¤
          
          ğŸ‘¨â€ğŸ’» ë‹´ë‹¹ì í˜¸ì¶œ í•„ìš”
          ğŸ“ ê°œë°œíŒ€ ì¦‰ì‹œ ëŒ€ì‘ ìš”ì²­
          ğŸ“Š ìƒì„¸ ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # ê¸´ê¸‰ ì•Œë¦¼ ì „ì†¡
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$EMERGENCY_MESSAGE\", \"channel\": \"#alerts\", \"username\": \"GitHub Actions - EMERGENCY\"}" \
              "$SLACK_WEBHOOK_URL"
          fi
          
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$EMERGENCY_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL"
          fi

      - name: ë°°í¬ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        if: always()
        run: |
          echo "ğŸ“Š ë°°í¬ ë©”íŠ¸ë¦­ ìˆ˜ì§‘..."
          
          # ë°°í¬ ì‹œê°„ ê³„ì‚°
          START_TIME="${{ github.event.head_commit.timestamp }}"
          END_TIME=$(date -u -Iseconds)
          
          echo "ğŸ“ˆ ë°°í¬ í†µê³„:"
          echo "â€¢ ì‹œì‘ ì‹œê°„: $START_TIME"
          echo "â€¢ ì™„ë£Œ ì‹œê°„: $END_TIME"
          echo "â€¢ ì»¤ë°‹ ìˆ˜: ${{ github.event.commits.length }}"
          echo "â€¢ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo "â€¢ ì‘ì„±ì: ${{ github.event.head_commit.author.name }}"
          
          # í–¥í›„ Analytics APIë¡œ ë©”íŠ¸ë¦­ ì „ì†¡ ê°€ëŠ¥