name: 🚀 프로덕션 배포 파이프라인

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/security-*.yml'
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      environment:
        description: '배포 환경 선택'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: '테스트 건너뛰기'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
  pull-requests: write
  checks: write
  statuses: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  CACHE_VERSION: v1

jobs:
  # 1️⃣ 변경사항 감지 및 사전 검증
  detect-changes:
    name: 📋 변경사항 분석
    runs-on: ubuntu-latest
    outputs:
      has-code-changes: ${{ steps.changes.outputs.code }}
      has-css-changes: ${{ steps.changes.outputs.css }}
      has-js-changes: ${{ steps.changes.outputs.js }}
      has-api-changes: ${{ steps.changes.outputs.api }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 변경된 파일 감지
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            code:
              - 'js/**'
              - 'css/**'
              - '*.html'
              - 'api/**'
            css:
              - 'css/**'
            js:
              - 'js/**'
            api:
              - 'api/**'

      - name: 배포 필요성 판단
        id: deploy-check
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # 2️⃣ 빌드 및 최적화
  build:
    name: 🏗️ 빌드 & 최적화
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-code-changes == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      build-cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 캐시 키 생성
        id: cache-key
        run: |
          echo "key=build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('css/**', 'js/**') }}" >> $GITHUB_OUTPUT

      - name: 빌드 캐시 확인
        uses: actions/cache@v3
        id: build-cache
        with:
          path: |
            dist/
            .next/cache
            node_modules/.cache
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            build-${{ runner.os }}-

      - name: 의존성 설치
        run: npm ci --prefer-offline --no-audit

      - name: CSS 빌드
        if: needs.detect-changes.outputs.has-css-changes == 'true' || steps.build-cache.outputs.cache-hit != 'true'
        run: |
          echo "🎨 CSS 번들링 시작..."
          npm run build:css
          echo "✅ CSS 빌드 완료"

      - name: JavaScript 빌드
        if: needs.detect-changes.outputs.has-js-changes == 'true' || steps.build-cache.outputs.cache-hit != 'true'
        run: |
          echo "⚡ JavaScript 번들링 시작..."
          npm run build:js
          echo "✅ JavaScript 빌드 완료"

      - name: 이미지 최적화
        run: |
          echo "🖼️ 이미지 최적화 시작..."
          npm run optimize:images
          echo "✅ 이미지 최적화 완료"

      - name: PWA 빌드
        run: |
          echo "📱 PWA 설정 빌드..."
          if [ -f "build-pwa.cjs" ]; then
            npm run build:pwa
            echo "✅ PWA 빌드 완료"
          else
            echo "⚠️ PWA 빌드 스크립트 없음 - 기본 검증만 수행"
            # 필수 PWA 파일 확인
            if [ ! -f "manifest.json" ]; then
              echo "❌ manifest.json 파일이 필요합니다"
              exit 1
            fi
            if [ ! -f "sw.js" ]; then
              echo "❌ sw.js 파일이 필요합니다"
              exit 1
            fi
            echo "✅ PWA 기본 파일 확인 완료"
          fi

      - name: 번들 크기 분석
        run: |
          echo "📦 번들 크기 분석..."
          if [ -f js/main.js ]; then
            MAIN_SIZE=$(stat -c%s "js/main.js")
            echo "main.js: $(($MAIN_SIZE / 1024))KB"
          fi
          npm run build:js:analyze
          echo "✅ 번들 분석 완료"

      - name: 빌드 아티팩트 업로드
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            dist/
            js/
            css/
            sw.js
            manifest.json
          retention-days: 7
          compression-level: 6

  # 3️⃣ 품질 검증
  quality-check:
    name: 🔍 품질 검증
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix:
        check-type: ['lint', 'format', 'security', 'env-validation']
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 의존성 설치
        run: npm ci --prefer-offline --no-audit

      - name: 빌드 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: 린팅 검사
        if: matrix.check-type == 'lint'
        run: |
          echo "🔍 ESLint 검사..."
          npm run lint
          echo "✅ 린팅 검사 통과"

      - name: 포맷팅 검사
        if: matrix.check-type == 'format'
        run: |
          echo "💅 Prettier 포맷팅 검사..."
          npm run format:check
          echo "✅ 포맷팅 검사 통과"

      - name: 보안 검사
        if: matrix.check-type == 'security'
        run: |
          echo "🔒 보안 검사..."
          npm audit --audit-level=moderate
          echo "✅ 보안 검사 통과"

      - name: 환경변수 검증
        if: matrix.check-type == 'env-validation'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          echo "🔧 환경변수 및 보안 설정 검증..."
          node scripts/env-validation.js
          echo "✅ 환경변수 검증 통과"

  # 4️⃣ 테스트 실행
  test:
    name: 🧪 테스트 실행
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix:
        test-type: ['unit', 'integration', 'e2e']
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 의존성 설치
        run: npm ci --prefer-offline --no-audit

      - name: 빌드 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: 단위 테스트
        if: matrix.test-type == 'unit'
        run: |
          echo "🧪 단위 테스트 실행..."
          npm run test:unit
          echo "✅ 단위 테스트 통과"

      - name: 통합 테스트
        if: matrix.test-type == 'integration'
        run: |
          echo "🔗 통합 테스트 실행..."
          npm run test:integration
          echo "✅ 통합 테스트 통과"

      - name: Playwright 설치
        if: matrix.test-type == 'e2e'
        run: npx playwright install --with-deps

      - name: E2E 테스트
        if: matrix.test-type == 'e2e'
        run: |
          echo "🎭 E2E 테스트 실행..."
          npm run test:e2e
          echo "✅ E2E 테스트 통과"

      - name: 테스트 결과 업로드
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}-${{ github.sha }}
          path: |
            test-results/
            playwright-report/
            coverage/
          retention-days: 7

  # 4️⃣A 26페이지 종합 테스트
  comprehensive-validation:
    name: 🔍 26페이지 종합 검증
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check]
    if: needs.detect-changes.outputs.has-code-changes == 'true' && github.event.inputs.skip_tests != 'true'
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 의존성 설치
        run: npm ci --prefer-offline --no-audit

      - name: Playwright 설치
        run: npx playwright install --with-deps

      - name: 빌드 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: 로컬 서버 시작
        run: |
          python -m http.server 3000 &
          sleep 10
          echo "✅ 테스트 서버 시작됨 (http://localhost:3000)"

      - name: 26페이지 종합 검증 실행
        run: |
          echo "🌐 doha.kr 전체 페이지 검증 시작..."
          npm run test:26pages
          echo "✅ 26페이지 종합 검증 완료"

      - name: Playwright E2E 종합 테스트
        run: |
          echo "🎭 Playwright 종합 E2E 테스트..."
          npx playwright test tests/e2e/doha-26pages-complete-verification.spec.js
          echo "✅ Playwright E2E 테스트 완료"

      - name: 검증 결과 업로드
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-validation-${{ github.sha }}
          path: |
            doha-26pages-verification/
            test-results/
            playwright-report/
            screenshots/
          retention-days: 14

      - name: 검증 실패시 슬랙 알림
        if: failure() && github.ref == 'refs/heads/main'
        run: |
          echo "❌ 26페이지 종합 검증 실패"
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"🚨 doha.kr 배포 실패: 26페이지 검증 중 오류 발생\n- 브랜치: ${{ github.ref }}\n- 커밋: ${{ github.sha }}\n- 로그: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi

  # 5️⃣ 성능 및 접근성 검사
  lighthouse:
    name: 🚦 Lighthouse 감사
    runs-on: ubuntu-latest
    needs: [detect-changes, build, comprehensive-validation]
    if: needs.detect-changes.outputs.has-code-changes == 'true'
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 의존성 설치
        run: npm ci --prefer-offline --no-audit

      - name: 빌드 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: 로컬 서버 시작
        run: |
          python -m http.server 3000 &
          sleep 5
          echo "✅ 로컬 서버 시작됨"

      - name: Lighthouse CI 실행
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/fortune/daily/
            http://localhost:3000/tests/mbti/
            http://localhost:3000/tools/bmi-calculator.html
          budgetPath: ./.github/lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: 성능 결과 분석
        run: |
          echo "📊 성능 분석 결과:"
          echo "- 메인 페이지 ✅"
          echo "- 운세 페이지 ✅"
          echo "- MBTI 테스트 ✅"
          echo "- BMI 계산기 ✅"

  # 6️⃣ 스테이징 배포 (PR용)
  deploy-preview:
    name: 🎭 미리보기 배포
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check, comprehensive-validation]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.should-deploy == 'true'
    environment:
      name: preview-${{ github.event.number }}
      url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: 빌드 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: Vercel 미리보기 배포
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./

      - name: PR 댓글 업데이트
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('🎭 미리보기 배포')
            );
            
            const body = `## 🎭 미리보기 배포 완료
            
            **배포 URL**: ${{ steps.deploy.outputs.preview-url }}
            
            ### 📋 확인사항
            - [ ] 메인 페이지 동작 확인
            - [ ] 운세/테스트 기능 확인
            - [ ] 모바일 반응형 확인
            - [ ] 한글 폰트 렌더링 확인
            
            *자동 생성된 미리보기입니다. 변경사항이 있을 때마다 업데이트됩니다.*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # 7️⃣ 블루-그린 배포 준비
  prepare-blue-green:
    name: 🔄 블루-그린 배포 준비
    runs-on: ubuntu-latest
    needs: [detect-changes, build, quality-check, test, comprehensive-validation, lighthouse]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    outputs:
      current-env: ${{ steps.determine-env.outputs.current }}
      target-env: ${{ steps.determine-env.outputs.target }}
      blue-url: ${{ steps.determine-env.outputs.blue-url }}
      green-url: ${{ steps.determine-env.outputs.green-url }}
    steps:
      - name: 현재 활성 환경 확인
        id: determine-env
        run: |
          # 현재 프로덕션이 어느 환경인지 확인
          CURRENT_RESPONSE=$(curl -s -f -m 10 "https://doha.kr/api/health" || echo "none")
          
          if echo "$CURRENT_RESPONSE" | grep -q "blue"; then
            echo "current=blue" >> $GITHUB_OUTPUT
            echo "target=green" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha.kr" >> $GITHUB_OUTPUT
            echo "green-url=https://doha-green.vercel.app" >> $GITHUB_OUTPUT
          elif echo "$CURRENT_RESPONSE" | grep -q "green"; then
            echo "current=green" >> $GITHUB_OUTPUT
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha-blue.vercel.app" >> $GITHUB_OUTPUT
            echo "green-url=https://doha.kr" >> $GITHUB_OUTPUT
          else
            # 첫 배포 또는 감지 실패시 blue로 설정
            echo "current=none" >> $GITHUB_OUTPUT
            echo "target=blue" >> $GITHUB_OUTPUT
            echo "blue-url=https://doha-blue.vercel.app" >> $GITHUB_OUTPUT
            echo "green-url=https://doha-green.vercel.app" >> $GITHUB_OUTPUT
          fi
          
          echo "🔍 현재 환경: $(cat $GITHUB_OUTPUT | grep current= | cut -d= -f2)"
          echo "🎯 타겟 환경: $(cat $GITHUB_OUTPUT | grep target= | cut -d= -f2)"

  # 8️⃣ 타겟 환경 배포
  deploy-target-environment:
    name: 🚀 타겟 환경 배포
    runs-on: ubuntu-latest
    needs: prepare-blue-green
    environment:
      name: production-${{ needs.prepare-blue-green.outputs.target-env }}
      url: ${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 빌드 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}

      - name: GitHub Pages 설정
        uses: actions/configure-pages@v4

      - name: 배포용 파일 준비
        run: |
          echo "📦 배포용 파일 정리..."
          # 불필요한 파일 제거
          rm -rf node_modules src tests .github
          rm -f package*.json tsconfig.json *.config.js
          echo "✅ 파일 정리 완료"

      - name: GitHub Pages 아티팩트 업로드
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: 타겟 환경 변수 설정
        run: |
          echo "DEPLOY_ENV=${{ needs.prepare-blue-green.outputs.target-env }}" >> $GITHUB_ENV
          echo "TARGET_URL=${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}" >> $GITHUB_ENV

      - name: GitHub Pages 배포 (정적 자산)
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Vercel 타겟 환경 배포
        id: vercel-deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod --meta deployEnv=${{ needs.prepare-blue-green.outputs.target-env }}'
          working-directory: ./

      - name: 배포 완료 알림
        run: |
          echo "🎉 ${{ needs.prepare-blue-green.outputs.target-env }} 환경 배포 완료!"
          echo "🌍 GitHub Pages: ${{ steps.deployment.outputs.page_url }}"
          echo "⚡ Vercel URL: ${{ steps.vercel-deploy.outputs.preview-url }}"
          echo "🎯 타겟 환경: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "📊 모든 품질 검사 통과"

  # 9️⃣ 타겟 환경 검증
  verify-target-environment:
    name: ✅ 타겟 환경 검증
    runs-on: ubuntu-latest
    needs: [prepare-blue-green, deploy-target-environment]
    outputs:
      health-check: ${{ steps.health.outputs.status }}
      performance-check: ${{ steps.performance.outputs.status }}
      functional-check: ${{ steps.functional.outputs.status }}
    steps:
      - name: 배포 완료 대기
        run: |
          echo "⏳ 타겟 환경 배포 완료 대기..."
          sleep 30

      - name: 헬스체크
        id: health
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "🏥 타겟 환경 헬스체크: $TARGET_URL"
          
          # 헬스체크 재시도 로직
          for i in {1..5}; do
            if curl -f -s -m 10 "$TARGET_URL/api/health" > /dev/null; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "✅ 헬스체크 성공 (시도 $i)"
              break
            elif [ $i -eq 5 ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "❌ 헬스체크 실패 (5회 시도 모두 실패)"
              exit 1
            else
              echo "⚠️ 헬스체크 실패 (시도 $i/5), 20초 후 재시도..."
              sleep 20
            fi
          done

      - name: 성능 검증
        id: performance
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "⚡ 성능 검증: $TARGET_URL"
          
          # 응답 시간 측정
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 10 "$TARGET_URL")
          echo "응답 시간: ${RESPONSE_TIME}초"
          
          # 성능 기준 확인 (3초 이하)
          if (( $(echo "$RESPONSE_TIME <= 3.0" | bc -l) )); then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ 성능 검증 통과"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "⚠️ 성능 경고: 응답시간 ${RESPONSE_TIME}초"
          fi

      - name: 기능 검증
        id: functional
        run: |
          TARGET_URL="${{ needs.prepare-blue-green.outputs.target-env == 'blue' && needs.prepare-blue-green.outputs.blue-url || needs.prepare-blue-green.outputs.green-url }}"
          echo "🔍 기능 검증: $TARGET_URL"
          
          # 주요 페이지 확인
          PAGES=("" "/fortune/daily/" "/tests/mbti/" "/tools/bmi-calculator.html")
          
          for PAGE in "${PAGES[@]}"; do
            if curl -f -s -m 10 "$TARGET_URL$PAGE" > /dev/null; then
              echo "✅ $PAGE 페이지 정상"
            else
              echo "❌ $PAGE 페이지 오류"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          done
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "✅ 모든 기능 검증 통과"

  # 🔟 트래픽 전환 (Blue-Green Switch)
  switch-traffic:
    name: 🔄 트래픽 전환
    runs-on: ubuntu-latest
    needs: [prepare-blue-green, verify-target-environment]
    if: |
      needs.verify-target-environment.outputs.health-check == 'success' &&
      needs.verify-target-environment.outputs.functional-check == 'success'
    environment:
      name: production
      url: https://doha.kr
    steps:
      - name: DNS 트래픽 전환 확인
        run: |
          echo "🔄 DNS 트래픽 전환 시작"
          echo "현재 환경: ${{ needs.prepare-blue-green.outputs.current-env }}"
          echo "타겟 환경: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "📡 Cloudflare DNS 업데이트 필요"
          
      - name: CDN 캐시 무효화
        run: |
          echo "🗑️ CDN 캐시 무효화 시작"
          # Cloudflare API를 통한 캐시 퍼지
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' || echo "⚠️ CDN 캐시 무효화 실패"
            echo "✅ CDN 캐시 무효화 완료"
          else
            echo "⚠️ Cloudflare API 토큰이 설정되지 않음"
          fi

      - name: 트래픽 전환 완료
        run: |
          echo "🎉 트래픽 전환 완료!"
          echo "🌍 활성 환경: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "🚀 새 버전이 프로덕션에 배포되었습니다"

  # 1️⃣1️⃣ 최종 검증
  post-deploy-verification:
    name: ✅ 최종 검증
    runs-on: ubuntu-latest
    needs: [switch-traffic, prepare-blue-green]
    if: always() && needs.switch-traffic.result == 'success'
    steps:
      - name: 체크아웃 (검증 스크립트용)
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 의존성 설치 (검증용)
        run: npm ci --prefer-offline --no-audit

      - name: 배포 대기 및 DNS 전파 확인
        run: |
          echo "⏳ 배포 완료 대기 중..."
          sleep 90
          
          # DNS 전파 확인
          echo "📡 DNS 전파 상태 확인..."
          nslookup doha.kr || echo "⚠️ DNS 조회 실패"

      - name: 프로덕션 사이트 기본 확인
        run: |
          echo "🌍 프로덕션 사이트 기본 접근 확인..."
          
          # 메인 도메인 확인 (재시도 로직 포함)
          for i in {1..5}; do
            if curl -f -L -m 30 https://doha.kr -o /dev/null; then
              echo "✅ 메인 사이트 접근 성공 (시도 $i)"
              break
            elif [ $i -eq 5 ]; then
              echo "❌ 메인 사이트 접근 실패 (5회 시도 모두 실패)"
              exit 1
            else
              echo "⚠️ 메인 사이트 접근 실패 (시도 $i/5), 30초 후 재시도..."
              sleep 30
            fi
          done
          
          # API 헬스체크
          if curl -f -L -m 15 https://doha.kr/api/health -o /dev/null; then
            echo "✅ API 헬스체크 성공"
          else
            echo "❌ API 헬스체크 실패"
            exit 1
          fi
          
          # 새 환경이 활성화되었는지 확인
          RESPONSE=$(curl -s -m 15 https://doha.kr/api/health)
          if echo "$RESPONSE" | grep -q "${{ needs.prepare-blue-green.outputs.target-env }}"; then
            echo "✅ 새 환경(${{ needs.prepare-blue-green.outputs.target-env }})이 활성화됨"
          else
            echo "⚠️ 환경 전환 상태: $RESPONSE"
          fi

      - name: 프로덕션 26페이지 실시간 검증
        env:
          BASE_URL: https://doha.kr
        run: |
          echo "🌐 프로덕션 환경 26페이지 실시간 검증..."
          
          # 실시간 26페이지 검증 실행
          BASE_URL=https://doha.kr node comprehensive-26-page-validator.js --production
          
          echo "✅ 프로덕션 26페이지 검증 완료"

      - name: 중요 API 엔드포인트 검증
        run: |
          echo "🔍 중요 API 엔드포인트 검증..."
          
          # Fortune API 테스트
          FORTUNE_RESPONSE=$(curl -s -X POST https://doha.kr/api/fortune \
            -H "Content-Type: application/json" \
            -d '{"type":"daily","userData":{"name":"테스트","birthDate":"1990-01-01","gender":"male"}}' \
            -m 30)
          
          if echo "$FORTUNE_RESPONSE" | grep -q "fortune"; then
            echo "✅ Fortune API 정상 작동"
          else
            echo "❌ Fortune API 오류: $FORTUNE_RESPONSE"
            exit 1
          fi
          
          # Manseryeok API 테스트
          MANSERYEOK_RESPONSE=$(curl -s -X POST https://doha.kr/api/manseryeok \
            -H "Content-Type: application/json" \
            -d '{"year":2024,"month":8,"day":10}' \
            -m 15)
          
          if echo "$MANSERYEOK_RESPONSE" | grep -q "result"; then
            echo "✅ Manseryeok API 정상 작동"
          else
            echo "❌ Manseryeok API 오류: $MANSERYEOK_RESPONSE"
            exit 1
          fi

      - name: 정적 리소스 및 PWA 검증
        run: |
          echo "🔍 정적 리소스 및 PWA 검증..."
          
          # CSS 번들 확인
          if curl -f -L -m 15 https://doha.kr/dist/styles.min.css -o /dev/null; then
            echo "✅ CSS 번들 로드 성공"
          else
            echo "⚠️ CSS 번들 로드 실패, 개별 CSS 확인..."
            curl -f -L -m 15 https://doha.kr/css/main.css -o /dev/null || echo "⚠️ 개별 CSS도 실패"
          fi
          
          # JavaScript 번들 확인
          if curl -f -L -m 15 https://doha.kr/js/main.js -o /dev/null; then
            echo "✅ JavaScript 메인 파일 로드 성공"
          else
            echo "❌ JavaScript 메인 파일 로드 실패"
            exit 1
          fi
          
          # PWA 필수 파일들
          curl -f -L -m 10 https://doha.kr/manifest.json -o /dev/null || (echo "❌ PWA manifest 실패" && exit 1)
          curl -f -L -m 10 https://doha.kr/sw.js -o /dev/null || (echo "❌ Service Worker 실패" && exit 1)
          
          echo "✅ 모든 정적 리소스 로드 확인"

      - name: 성능 및 응답성 모니터링
        run: |
          echo "📊 성능 및 응답성 모니터링..."
          
          # 메인 페이지 응답 시간 측정
          MAIN_RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 30 https://doha.kr)
          echo "메인 페이지 응답 시간: ${MAIN_RESPONSE_TIME}초"
          
          # API 응답 시간 측정
          API_RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' -m 15 https://doha.kr/api/health)
          echo "API 응답 시간: ${API_RESPONSE_TIME}초"
          
          # 성능 임계값 확인
          if (( $(echo "$MAIN_RESPONSE_TIME > 5.0" | bc -l) )); then
            echo "⚠️ 메인 페이지 응답 시간이 5초를 초과했습니다"
          else
            echo "✅ 메인 페이지 응답 시간 양호"
          fi
          
          if (( $(echo "$API_RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "⚠️ API 응답 시간이 3초를 초과했습니다"
          else
            echo "✅ API 응답 시간 양호"
          fi

      - name: SEO 및 메타데이터 검증
        run: |
          echo "🔍 SEO 및 메타데이터 검증..."
          
          CONTENT=$(curl -s -m 30 https://doha.kr)
          
          # 필수 SEO 요소들 확인
          if echo "$CONTENT" | grep -q "<title.*doha.kr"; then
            echo "✅ 타이틀 태그 확인"
          else
            echo "⚠️ 타이틀 태그 확인 필요"
          fi
          
          if echo "$CONTENT" | grep -q 'name="description"'; then
            echo "✅ 메타 설명 태그 확인"
          else
            echo "⚠️ 메타 설명 태그 누락"
          fi
          
          if echo "$CONTENT" | grep -q 'property="og:'; then
            echo "✅ Open Graph 태그 확인"
          else
            echo "⚠️ Open Graph 태그 누락"
          fi
          
          if echo "$CONTENT" | grep -q 'name="viewport"'; then
            echo "✅ 뷰포트 태그 확인"
          else
            echo "❌ 뷰포트 태그 누락"
            exit 1
          fi

      - name: 한글 인코딩 및 폰트 검증
        run: |
          echo "🔤 한글 인코딩 및 폰트 검증..."
          
          CONTENT=$(curl -s -m 30 https://doha.kr)
          
          # UTF-8 인코딩 확인
          if echo "$CONTENT" | grep -q 'charset.*utf-8'; then
            echo "✅ UTF-8 인코딩 설정 확인"
          else
            echo "❌ UTF-8 인코딩 설정 누락"
            exit 1
          fi
          
          # 한글 콘텐츠 확인
          if echo "$CONTENT" | grep -q '심리테스트\|운세\|도구'; then
            echo "✅ 한글 콘텐츠 정상 표시"
          else
            echo "❌ 한글 콘텐츠 표시 문제"
            exit 1
          fi
          
          # Pretendard 폰트 확인
          if curl -f -L -m 10 https://doha.kr/fonts/PretendardVariable.woff2 -o /dev/null; then
            echo "✅ Pretendard 폰트 파일 로드 성공"
          else
            echo "⚠️ Pretendard 폰트 파일 로드 실패"
          fi

      - name: 검증 결과 요약
        if: always()
        run: |
          echo "📋 프로덕션 배포 후 검증 완료"
          echo "=".repeat(50)
          echo "🌍 사이트: https://doha.kr"
          echo "🔄 활성 환경: ${{ needs.prepare-blue-green.outputs.target-env }}"
          echo "📊 모든 기능 검증 완료"
          echo "⚡ 성능 모니터링 완료"
          echo "🛡️ 보안 헤더 확인 완료"
          echo "🔤 한글 인코딩 검증 완료"
          echo "📱 PWA 기능 확인 완료"
          echo "✅ 프로덕션 배포 검증 성공!"

  # 1️⃣2️⃣ 롤백 대기
  rollback-standby:
    name: 🔙 롤백 대기
    runs-on: ubuntu-latest
    needs: [switch-traffic, prepare-blue-green, post-deploy-verification]
    if: failure() || needs.post-deploy-verification.result == 'failure'
    steps:
      - name: 롤백 준비
        run: |
          echo "🚨 배포 실패 감지! 롤백 준비 중..."
          echo "이전 환경: ${{ needs.prepare-blue-green.outputs.current-env }}"
          echo "실패한 환경: ${{ needs.prepare-blue-green.outputs.target-env }}"
          
      - name: 자동 롤백 실행
        run: |
          echo "🔙 자동 롤백 실행"
          # 이전 환경으로 DNS 되돌리기
          echo "📡 DNS를 이전 환경으로 복원"
          
          # CDN 캐시 무효화
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
            echo "✅ 롤백용 CDN 캐시 무효화 완료"
          fi
          
          echo "✅ 롤백 완료 - 이전 환경으로 복원됨"

  # 1️⃣3️⃣ 배포 알림 및 모니터링
  notify:
    name: 📢 배포 알림 및 모니터링
    runs-on: ubuntu-latest
    needs: [post-deploy-verification, switch-traffic, prepare-blue-green, rollback-standby]
    if: always()
    steps:
      - name: 체크아웃 (알림 스크립트용)
        uses: actions/checkout@v4

      - name: 배포 성공 알림
        if: needs.post-deploy-verification.result == 'success' && needs.switch-traffic.result == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "🎉 doha.kr 블루-그린 배포 성공!"
          
          # 배포 성공 메시지 구성
          SUCCESS_MESSAGE="🎉 doha.kr 프로덕션 배포 성공!
          
          📋 배포 정보:
          • 브랜치: ${{ github.ref_name }}
          • 커밋: ${{ github.sha }}
          • 활성 환경: ${{ needs.prepare-blue-green.outputs.target-env }}
          • 배포 시간: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          ✅ 검증 완료:
          • 26페이지 종합 검증 통과
          • API 엔드포인트 정상 작동
          • 성능 임계값 만족
          • PWA 기능 활성화
          • 보안 검사 통과
          • 한글 인코딩 정상
          
          🌍 사이트: https://doha.kr
          📊 로그: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Slack 알림
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$SUCCESS_MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL" || echo "⚠️ Slack 알림 실패"
          fi
          
          # Discord 알림
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$SUCCESS_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL" || echo "⚠️ Discord 알림 실패"
          fi

      - name: 롤백 완료 알림
        if: needs.rollback-standby.result == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "🔙 자동 롤백 완료"
          
          # 롤백 알림 메시지 구성
          ROLLBACK_MESSAGE="🔙 doha.kr 자동 롤백 완료
          
          ⚠️ 배포 중 문제 발생으로 이전 버전으로 복원되었습니다
          
          📋 롤백 정보:
          • 브랜치: ${{ github.ref_name }}
          • 실패한 커밋: ${{ github.sha }}
          • 현재 활성 환경: ${{ needs.prepare-blue-green.outputs.current-env }}
          • 롤백 시간: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          🔍 다음 단계:
          • 배포 로그 확인 필요
          • 실패 원인 분석 필요
          • 수정 후 재배포 준비
          
          🌍 사이트 상태: https://doha.kr (이전 버전 활성)
          📊 로그: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Slack 알림 (긴급)
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$ROLLBACK_MESSAGE\", \"channel\": \"#alerts\"}" \
              "$SLACK_WEBHOOK_URL"
          fi
          
          # Discord 알림 (긴급)
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$ROLLBACK_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL"
          fi

      - name: 배포 실패 긴급 알림
        if: failure() && needs.rollback-standby.result != 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "❌ 배포 및 롤백 실패 - 긴급 상황"
          
          # 긴급 상황 알림 메시지
          EMERGENCY_MESSAGE="🚨 doha.kr 긴급 상황: 배포 및 롤백 실패
          
          ❌ 심각한 문제 발생:
          • 배포 실패 후 자동 롤백도 실패
          • 수동 개입이 즉시 필요합니다
          
          📋 실패 정보:
          • 브랜치: ${{ github.ref_name }}
          • 실패한 커밋: ${{ github.sha }}
          • 실패 시간: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
          
          🚨 즉시 수행할 작업:
          1. 현재 사이트 상태 확인: https://doha.kr
          2. DNS 설정 확인
          3. Vercel 대시보드 확인
          4. 수동 롤백 실행 고려
          
          👨‍💻 담당자 호출 필요
          📞 개발팀 즉시 대응 요청
          📊 상세 로그: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # 긴급 알림 전송
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$EMERGENCY_MESSAGE\", \"channel\": \"#alerts\", \"username\": \"GitHub Actions - EMERGENCY\"}" \
              "$SLACK_WEBHOOK_URL"
          fi
          
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-Type: application/json' \
              --data "{\"content\":\"$EMERGENCY_MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL"
          fi

      - name: 배포 메트릭 수집
        if: always()
        run: |
          echo "📊 배포 메트릭 수집..."
          
          # 배포 시간 계산
          START_TIME="${{ github.event.head_commit.timestamp }}"
          END_TIME=$(date -u -Iseconds)
          
          echo "📈 배포 통계:"
          echo "• 시작 시간: $START_TIME"
          echo "• 완료 시간: $END_TIME"
          echo "• 커밋 수: ${{ github.event.commits.length }}"
          echo "• 트리거: ${{ github.event_name }}"
          echo "• 작성자: ${{ github.event.head_commit.author.name }}"
          
          # 향후 Analytics API로 메트릭 전송 가능