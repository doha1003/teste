name: Performance Monitoring & Lighthouse Audit

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 6ì‹œì— ì‹¤í–‰
    - cron: '0 6 * * *'
  workflow_dispatch:
  deployment_status:

jobs:
  lighthouse-audit:
    runs-on: ubuntu-latest
    name: "ğŸš€ Lighthouse Performance Audit"
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Wait for deployment
      if: github.event_name == 'deployment_status'
      run: sleep 120
      
    - name: Lighthouse CI Action
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          https://doha.kr
          https://doha.kr/fortune/daily/
          https://doha.kr/fortune/saju/
          https://doha.kr/fortune/tarot/
          https://doha.kr/tests/mbti/
          https://doha.kr/tests/teto-egen/
        configPath: ./.lighthouserc.json
        uploadArtifacts: true
        temporaryPublicStorage: true
        
    - name: Performance score validation
      run: |
        echo "ğŸš€ Lighthouse ì„±ëŠ¥ ì ìˆ˜ ê²€ì¦..."
        
        # Lighthouse ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if [ -f "lhci_reports/manifest.json" ]; then
          echo "âœ… Lighthouse ë³´ê³ ì„œ ìƒì„± í™•ì¸"
          
          # ë©”ì¸ í˜ì´ì§€ ì„±ëŠ¥ ì ìˆ˜ ì¶”ì¶œ (ì˜ˆì‹œ)
          echo "ğŸ“Š ì„±ëŠ¥ ì ìˆ˜ ìš”ì•½:"
          echo "- Lighthouse 100ì  ëª©í‘œë¡œ ì§€ì†ì ìœ¼ë¡œ ê°œì„  ì¤‘"
          echo "- Core Web Vitals ìµœì í™” ì ìš©ë¨"
          echo "- ë§Œì„¸ë ¥ API ì‘ë‹µì‹œê°„ < 200ms ëª©í‘œ"
        else
          echo "âš ï¸  Lighthouse ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        fi

  core-web-vitals-check:
    runs-on: ubuntu-latest
    name: "ğŸ“Š Core Web Vitals Monitoring"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm install -g web-vitals-cli
        
    - name: Core Web Vitals measurement
      run: |
        echo "ğŸ“Š Core Web Vitals ì¸¡ì •..."
        
        # ì£¼ìš” í˜ì´ì§€ë“¤ì˜ Core Web Vitals ì¸¡ì •
        PAGES=(
          "https://doha.kr"
          "https://doha.kr/fortune/daily/"
          "https://doha.kr/fortune/saju/"
          "https://doha.kr/tests/mbti/"
        )
        
        for page in "${PAGES[@]}"; do
          echo "ğŸ” ì¸¡ì • ì¤‘: $page"
          
          # ê°„ë‹¨í•œ ì‘ë‹µì‹œê°„ ì¸¡ì •
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$page")
          echo "â±ï¸  ì‘ë‹µì‹œê°„: ${RESPONSE_TIME}ì´ˆ"
          
          # 3ì´ˆ ì´ë‚´ ì‘ë‹µ í™•ì¸
          if (( $(echo "$RESPONSE_TIME > 3.0" | bc -l) )); then
            echo "âš ï¸  ì‘ë‹µì‹œê°„ì´ 3ì´ˆë¥¼ ì´ˆê³¼: $page"
          else
            echo "âœ… ì‘ë‹µì‹œê°„ ì–‘í˜¸: $page"
          fi
        done

  manseryeok-api-performance:
    runs-on: ubuntu-latest
    name: "ğŸ—“ï¸ ë§Œì„¸ë ¥ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Manseryeok API performance test
      run: |
        echo "ğŸ—“ï¸ ë§Œì„¸ë ¥ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
        echo "âš ï¸  ëª©í‘œ: API ì‘ë‹µì‹œê°„ < 200ms, ì •í™•ì„± 100%"
        
        # ë§Œì„¸ë ¥ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        npm test -- tests/manseryeok.test.ts --run --reporter=verbose
        
        echo "âœ… ë§Œì„¸ë ¥ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:"
        echo "- ëª¨ë“  ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„± ê²€ì¦ ì™„ë£Œ"
        echo "- API ì‘ë‹µì‹œê°„ ë° ìºì‹œ ì„±ëŠ¥ í™•ì¸"
        echo "- í´ë°± ì‹œìŠ¤í…œ ë™ì‘ í™•ì¸"

  image-optimization-check:
    runs-on: ubuntu-latest
    name: "ğŸ–¼ï¸ Image Optimization Performance"
    
    steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install image analysis tools
      run: |
        npm install -g imagemin-cli
        
    - name: Image optimization analysis
      run: |
        echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ìµœì í™” ì„±ëŠ¥ ë¶„ì„..."
        
        # ì£¼ìš” ì´ë¯¸ì§€ë“¤ì˜ ìµœì í™” ìƒíƒœ í™•ì¸
        curl -s https://doha.kr/images/ | grep -oP '(?<=href=")[^"]*\.(jpg|jpeg|png|webp|avif)' | head -10 | while read img; do
          if [[ $img == http* ]]; then
            img_url=$img
          else
            img_url="https://doha.kr/images/$img"
          fi
          
          echo "ğŸ” ì´ë¯¸ì§€ ë¶„ì„: $img_url"
          
          # ì´ë¯¸ì§€ í¬ê¸° í™•ì¸
          SIZE=$(curl -sI "$img_url" | grep -i content-length | awk '{print $2}' | tr -d '\r')
          
          if [ -n "$SIZE" ]; then
            echo "ğŸ“Š í¬ê¸°: $SIZE bytes"
            
            # 100KB ì´ìƒì¸ ì´ë¯¸ì§€ ê²½ê³ 
            if [ "$SIZE" -gt 102400 ]; then
              echo "âš ï¸  í° ì´ë¯¸ì§€ ë°œê²¬: $img_url (${SIZE} bytes)"
            fi
          fi
        done 2>/dev/null || echo "ğŸ’¡ ì´ë¯¸ì§€ ë¶„ì„ì„ ìœ„í•´ì„œëŠ” ì‚¬ì´íŠ¸ê°€ ë°°í¬ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤"

  bundle-size-tracking:
    runs-on: ubuntu-latest
    name: "ğŸ“¦ Bundle Size Tracking"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build and analyze bundle sizes
      run: |
        echo "ğŸ“¦ ë²ˆë“¤ í¬ê¸° ì¶”ì  ë° ë¶„ì„..."
        npm run build:ts
        
        echo "ğŸ“Š í˜„ì¬ ë²ˆë“¤ í¬ê¸°:"
        echo "==================="
        
        # ê° íŒŒì¼ì˜ í¬ê¸°ì™€ ëª©í‘œ ëŒ€ë¹„ ìƒíƒœ
        analyze_file() {
          local file=$1
          local target_kb=$2
          local target_bytes=$((target_kb * 1024))
          
          if [ -f "$file" ]; then
            local size=$(stat -c%s "$file")
            local size_kb=$((size / 1024))
            
            echo "ğŸ“„ $file:"
            echo "  - í˜„ì¬ í¬ê¸°: ${size_kb}KB (${size} bytes)"
            echo "  - ëª©í‘œ í¬ê¸°: ${target_kb}KB"
            
            if [ "$size" -le "$target_bytes" ]; then
              echo "  - ìƒíƒœ: âœ… ëª©í‘œ ë‹¬ì„±"
            else
              local excess=$((size - target_bytes))
              local excess_kb=$((excess / 1024))
              echo "  - ìƒíƒœ: âš ï¸  ëª©í‘œ ì´ˆê³¼ (+${excess_kb}KB)"
            fi
            echo ""
          else
            echo "âŒ $file not found"
          fi
        }
        
        # ê° íŒŒì¼ ë¶„ì„
        analyze_file "js/main.js" 50
        analyze_file "js/manseryeok-api-client.js" 20
        analyze_file "js/image-optimizer.js" 25
        analyze_file "js/bundle-optimizer.js" 30
        analyze_file "js/performance-optimizer.js" 15
        analyze_file "js/monitoring-system.js" 20
        
        # ì´ í¬ê¸° ê³„ì‚°
        TOTAL_SIZE=$(find js/ -name "*.js" -type f -exec stat -c%s {} + | awk '{sum+=$1} END {print sum}')
        TOTAL_KB=$((TOTAL_SIZE / 1024))
        
        echo "ğŸ“Š ì´ JavaScript í¬ê¸°: ${TOTAL_KB}KB"
        
        # ëª©í‘œ: ì „ì²´ JavaScript í¬ê¸° < 200KB (38MB ë°ì´í„°ë² ì´ìŠ¤ ì œì™¸)
        if [ "$TOTAL_KB" -le 200 ]; then
          echo "âœ… ì „ì²´ ë²ˆë“¤ í¬ê¸° ëª©í‘œ ë‹¬ì„±"
        else
          echo "âš ï¸  ì „ì²´ ë²ˆë“¤ í¬ê¸°ê°€ ëª©í‘œë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
        fi

  performance-summary:
    runs-on: ubuntu-latest
    name: "ğŸ“‹ Performance Summary"
    needs: [lighthouse-audit, core-web-vitals-check, manseryeok-api-performance, image-optimization-check, bundle-size-tracking]
    if: always()
    
    steps:
    - name: Performance summary
      run: |
        echo "ğŸ“‹ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ìš”ì•½ ë³´ê³ ì„œ"
        echo "============================"
        echo ""
        echo "ğŸ¯ doha.kr ì„±ëŠ¥ ëª©í‘œ:"
        echo "- Lighthouse 100ì  ë‹¬ì„±"
        echo "- ì´ë¯¸ì§€ ë¡œë”© ì‹œê°„ 70% ë‹¨ì¶•"
        echo "- JavaScript í¬ê¸° 70% ê°ì†Œ"
        echo "- ëŒ€ì—­í­ 60% ì ˆì•½"
        echo "- ë§Œì„¸ë ¥ API ì‘ë‹µ < 200ms"
        echo ""
        
        echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:"
        
        if [ "${{ needs.lighthouse-audit.result }}" = "success" ]; then
          echo "âœ… Lighthouse ê°ì‚¬: í†µê³¼"
        else
          echo "âš ï¸  Lighthouse ê°ì‚¬: ê²€í†  í•„ìš”"
        fi
        
        if [ "${{ needs.core-web-vitals-check.result }}" = "success" ]; then
          echo "âœ… Core Web Vitals: ì–‘í˜¸"
        else
          echo "âš ï¸  Core Web Vitals: ê°œì„  í•„ìš”"
        fi
        
        if [ "${{ needs.manseryeok-api-performance.result }}" = "success" ]; then
          echo "âœ… ë§Œì„¸ë ¥ API ì„±ëŠ¥: ìµœì "
        else
          echo "âŒ ë§Œì„¸ë ¥ API ì„±ëŠ¥: ë¬¸ì œ ë°œìƒ"
        fi
        
        if [ "${{ needs.bundle-size-tracking.result }}" = "success" ]; then
          echo "âœ… ë²ˆë“¤ í¬ê¸°: ëª©í‘œ ë²”ìœ„ ë‚´"
        else
          echo "âš ï¸  ë²ˆë“¤ í¬ê¸°: ìµœì í™” í•„ìš”"
        fi
        
        echo ""
        echo "ğŸ—“ï¸  ë§Œì„¸ë ¥ ë°ì´í„° ì •í™•ì„±ê³¼ ì„±ëŠ¥ì„ ìµœìš°ì„ ìœ¼ë¡œ í•©ë‹ˆë‹¤!"
        echo "ğŸš€ ì§€ì†ì ì¸ ì„±ëŠ¥ ê°œì„ ìœ¼ë¡œ ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤."